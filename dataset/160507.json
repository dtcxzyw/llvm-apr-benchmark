{
  "bug_id": "160507",
  "issue_url": "https://github.com/llvm/llvm-project/issues/160507",
  "bug_type": "crash",
  "base_commit": "e47a42e5b597b155207da24a348baaba52014a92",
  "knowledge_cutoff": "2025-09-24T11:47:04Z",
  "lit_test_dir": [
    "llvm/test/Transforms/InstCombine"
  ],
  "hints": {
    "fix_commit": "6eff26094a2c277d9f324545b8b26a02213ed5de",
    "components": [
      "InstCombine"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp": [
        [
          723,
          728
        ],
        [
          733,
          739
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp": [
        "replaceExtractElements"
      ]
    }
  },
  "patch": "commit 6eff26094a2c277d9f324545b8b26a02213ed5de\nAuthor: Yingwei Zheng <dtcxzyw2333@gmail.com>\nDate:   Fri Sep 26 00:53:24 2025 +0800\n\n    [InstCombine] Skip replaceExtractElements for ConstantData (#160575)\n    \n    Closes https://github.com/llvm/llvm-project/issues/160507.\n    \n    Note: Replacing other users except for `ExtElt` is a bit strange to me.\n    I tried to only replace `ExtElt` with a new extractelement, but it\n    caused regressions on `widen_extract2/3`.\n\ndiff --git a/llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp b/llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp\nindex b17cf17db158..6ef30663bf3c 100644\n--- a/llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp\n+++ b/llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp\n@@ -723,6 +723,11 @@ static bool replaceExtractElements(InsertElementInst *InsElt,\n       NumExtElts >= NumInsElts)\n     return false;\n \n+  Value *ExtVecOp = ExtElt->getVectorOperand();\n+  // Bail out on constant vectors.\n+  if (isa<ConstantData>(ExtVecOp))\n+    return false;\n+\n   // Create a shuffle mask to widen the extended-from vector using poison\n   // values. The mask selects all of the values of the original vector followed\n   // by as many poison values as needed to create a vector of the same length\n@@ -733,7 +738,6 @@ static bool replaceExtractElements(InsertElementInst *InsElt,\n   for (unsigned i = NumExtElts; i < NumInsElts; ++i)\n     ExtendMask.push_back(-1);\n \n-  Value *ExtVecOp = ExtElt->getVectorOperand();\n   auto *ExtVecOpInst = dyn_cast<Instruction>(ExtVecOp);\n   BasicBlock *InsertionBlock = (ExtVecOpInst && !isa<PHINode>(ExtVecOpInst))\n                                    ? ExtVecOpInst->getParent()\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/InstCombine/insert-extract-shuffle.ll",
      "commands": [
        "opt -S -passes=instcombine %s"
      ],
      "tests": [
        {
          "test_name": "pr160507",
          "test_body": "define i64 @pr160507(ptr %arg, i32 %arg1, i1 %arg2, i8 %arg3, i64 %arg4) {\nbb:\n  br label %bb5\n\nbb5:                                              ; preds = %bb12, %bb6, %bb\n  %phi = phi i8 [ 0, %bb ], [ %extractelement, %bb6 ], [ 0, %bb12 ]\n  br i1 %arg2, label %bb6, label %bb8\n\nbb6:                                              ; preds = %bb5\n  %extractelement = extractelement <2 x i8> zeroinitializer, i64 %arg4\n  br label %bb5\n\nbb8:                                              ; preds = %bb5\n  %insertelement9 = insertelement <2 x i8> <i8 poison, i8 0>, i8 %phi, i64 0\n  %zext = zext <2 x i8> %insertelement9 to <2 x i64>\n  %shufflevector = shufflevector <2 x i64> %zext, <2 x i64> poison, <4 x i32> <i32 poison, i32 1, i32 1, i32 1>\n  br label %bb10\n\nbb10:                                             ; preds = %bb8\n  br label %bb12\n\nbb12:                                             ; preds = %bb10\n  %extractelement11 = extractelement <2 x i64> %zext, i64 1\n  %insertelement13 = insertelement <4 x i64> %shufflevector, i64 %extractelement11, i64 0\n  %extractelement14 = extractelement <4 x i64> %insertelement13, i32 %arg1\n  store i64 %extractelement14, ptr %arg, align 8\n  br label %bb5\n}\n"
        },
        {
          "test_name": "infloop_D151807",
          "test_body": "define <4 x i32> @infloop_D151807(<4 x float> %arg) {\n  %i = shufflevector <4 x float> %arg, <4 x float> poison, <2 x i32> <i32 2, i32 poison>\n  %i1 = bitcast <2 x float> %i to <2 x i32>\n  %i3 = extractelement <2 x i32> %i1, i64 0\n  %i4 = insertelement <4 x i32> zeroinitializer, i32 %i3, i64 0\n  ret <4 x i32> %i4\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[InstCombine] opt triggered assertion \"hasUseList()\" at -O1/O2/O3",
    "body": "Reproducer: https://godbolt.org/z/K9TMMvP6d\nTestcase:\n```llvm\ndefine i64 @func_1(ptr %g_322, i32 %0, i1 %tobool, i8 %BS_VAR_11.0, i64 %cond) {\nentry:\n  br label %BS_LABEL_1\n\nBS_LABEL_1:                                       ; preds = %cond.end24, %if.then, %entry\n  %BS_VAR_11.01 = phi i8 [ 0, %entry ], [ %vecext, %if.then ], [ 0, %cond.end24 ]\n  br i1 %tobool, label %if.then, label %if.end\n\nif.then:                                          ; preds = %BS_LABEL_1\n  %vecinit = insertelement <6 x i8> zeroinitializer, i8 %BS_VAR_11.0, i32 0\n  %vecinit2 = insertelement <6 x i8> %vecinit, i8 0, i32 0\n  %vecext = extractelement <6 x i8> %vecinit2, i64 %cond\n  br label %BS_LABEL_1\n\nif.end:                                           ; preds = %BS_LABEL_1\n  %vecinit10 = insertelement <2 x i8> zeroinitializer, i8 %BS_VAR_11.01, i32 0\n  %conv12 = zext <2 x i8> %vecinit10 to <2 x i64>\n  %shuffle = shufflevector <2 x i64> %conv12, <2 x i64> zeroinitializer, <32 x i32> <i32 1, i32 1, i32 1, i32 2, i32 0, i32 3, i32 0, i32 0, i32 3, i32 0, i32 2, i32 3, i32 1, i32 3, i32 1, i32 1, i32 0, i32 2, i32 1, i32 1, i32 0, i32 2, i32 2, i32 1, i32 2, i32 1, i32 3, i32 1, i32 1, i32 3, i32 2, i32 1>\n  %tobool19 = icmp ne i64 0, 0\n  br i1 %tobool19, label %cond.true20, label %cond.false22\n\ncond.true20:                                      ; preds = %if.end\n  %1 = load <2 x i64>, ptr null, align 16\n  br label %cond.end24\n\ncond.false22:                                     ; preds = %if.end\n  %vecext23 = extractelement <32 x i64> %shuffle, i32 0\n  br label %cond.end24\n\ncond.end24:                                       ; preds = %cond.false22, %cond.true20\n  %cond25 = phi i64 [ 0, %cond.true20 ], [ %vecext23, %cond.false22 ]\n  %vecinit26 = insertelement <32 x i64> %shuffle, i64 %cond25, i32 0\n  %vecext57 = extractelement <32 x i64> %vecinit26, i32 %0\n  %vecins = insertelement <1 x i64> zeroinitializer, i64 %vecext57, i32 0\n  store <1 x i64> %vecins, ptr %g_322, align 8\n  br label %BS_LABEL_1\n}\n```\nOutput:\n```\nopt: /root/llvm-project/llvm/include/llvm/IR/Value.h:395: llvm::Value::user_iterator llvm::Value::materialized_user_begin(): Assertion `hasUseList()' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -O1 <source>\n1.\tRunning pass \"function<eager-inv>(mem2reg,instcombine<max-iterations=1;no-verify-fixpoint>,simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>)\" on module \"<source>\"\n2.\tRunning pass \"instcombine<max-iterations=1;no-verify-fixpoint>\" on function \"func_1\"\n #0 0x00000000058da2e8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x58da2e8)\n #1 0x00000000058d7194 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x00007f13dc842520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x00007f13dc8969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x00007f13dc842476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x00007f13dc8287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x00007f13dc82871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x00007f13dc839e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x00000000049567e8 collectShuffleElements(llvm::Value*, llvm::SmallVectorImpl<int>&, llvm::Value*, llvm::InstCombinerImpl&, bool&) (.constprop.0) InstCombineVectorOps.cpp:0:0\n #9 0x0000000004959e2f llvm::InstCombinerImpl::visitInsertElementInst(llvm::InsertElementInst&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4959e2f)\n#10 0x000000000483798e llvm::InstCombinerImpl::run() (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x483798e)\n#11 0x00000000048394a6 combineInstructionsOverFunction(llvm::Function&, llvm::InstructionWorklist&, llvm::AAResults*, llvm::AssumptionCache&, llvm::TargetLibraryInfo&, llvm::TargetTransformInfo&, llvm::DominatorTree&, llvm::OptimizationRemarkEmitter&, llvm::BlockFrequencyInfo*, llvm::BranchProbabilityInfo*, llvm::ProfileSummaryInfo*, llvm::InstCombineOptions const&) (.isra.0) InstructionCombining.cpp:0:0\n#12 0x000000000483aa2d llvm::InstCombinePass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x483aa2d)\n#13 0x0000000002bebaee llvm::detail::PassModel<llvm::Function, llvm::InstCombinePass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x2bebaee)\n#14 0x00000000056c19c1 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56c19c1)\n#15 0x0000000000eeb97e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xeeb97e)\n#16 0x00000000056bff2a llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56bff2a)\n#17 0x000000000097295e llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97295e)\n#18 0x00000000056bf8e1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56bf8e1)\n#19 0x000000000097cb18 llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97cb18)\n#20 0x0000000000970cb7 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x970cb7)\n#21 0x00007f13dc829d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#22 0x00007f13dc829e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#23 0x0000000000967dc5 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x967dc5)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```\ncc @nikic @dtcxzyw ",
    "author": "XChy",
    "labels": [
      "llvm:instcombine",
      "crash-on-valid"
    ],
    "comments": [
      {
        "author": "nikic",
        "body": "InstCombine-only test case:\n```llvm\ndefine i64 @test(ptr %arg, i32 %arg1, i1 %arg2, i8 %arg3, i64 %arg4) {\nbb:\n  br label %bb5\n\nbb5:                                              ; preds = %bb12, %bb6, %bb\n  %phi = phi i8 [ 0, %bb ], [ %extractelement, %bb6 ], [ 0, %bb12 ]\n  br i1 %arg2, label %bb6, label %bb8\n\nbb6:                                              ; preds = %bb5\n  %extractelement = extractelement <6 x i8> zeroinitializer, i64 %arg4\n  br label %bb5\n\nbb8:                                              ; preds = %bb5\n  %insertelement9 = insertelement <2 x i8> <i8 poison, i8 0>, i8 %phi, i64 0\n  %zext = zext nneg <2 x i8> %insertelement9 to <2 x i64>\n  %shufflevector = shufflevector <2 x i64> %zext, <2 x i64> zeroinitializer, <32 x i32> <i32 poison, i32 1, i32 1, i32 2, i32 0, i32 3, i32 0, i32 0, i32 3, i32 0, i32 2, i32 3, i32 1, i32 3, i32 1, i32 1, i32 0, i32 2, i32 1, i32 1, i32 0, i32 2, i32 2, i32 1, i32 2, i32 1, i32 3, i32 1, i32 1, i32 3, i32 2, i32 1>\n  br label %bb10\n\nbb10:                                             ; preds = %bb8\n  br label %bb12\n\nbb12:                                             ; preds = %bb10\n  %extractelement11 = extractelement <2 x i64> %zext, i64 1\n  %insertelement13 = insertelement <32 x i64> %shufflevector, i64 %extractelement11, i64 0\n  %extractelement14 = extractelement <32 x i64> %insertelement13, i32 %arg1\n  %insertelement15 = insertelement <1 x i64> poison, i64 %extractelement14, i64 0\n  store <1 x i64> %insertelement15, ptr %arg, align 8\n  br label %bb5\n}\n```"
      },
      {
        "author": "dtcxzyw",
        "body": "https://github.com/llvm/llvm-project/blob/e3aa00e517e58583f96ca62e2c654d9ce6dec060/llvm/lib/Transforms/InstCombine/InstCombineVectorOps.cpp#L773-L785"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}