{
  "bug_id": "171055",
  "issue_url": "https://github.com/llvm/llvm-project/issues/171055",
  "bug_type": "crash",
  "base_commit": "0e92beb0c0f050e1180c88aa31713f3d6ba9d34e",
  "knowledge_cutoff": "2025-12-07T20:11:42Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "f8d0c355f5f8d373b1c31161d31d490b771aa03e",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          10930,
          10942
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "findAndSetMainInstruction"
      ]
    }
  },
  "patch": "commit f8d0c355f5f8d373b1c31161d31d490b771aa03e\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Mon Dec 8 08:11:48 2025 -0800\n\n    [SLP]Prefer instructions, ued outside the block, as the initial main copyable instructions\n    \n    Instructions, used outside the block, must be considered the first\n    choice for the main instructionsin the copyable nodes, to avoid\n    use-before-def.\n    \n    Fixes #171055\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 91f58bdc0686..6da11a2796d6 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -10930,13 +10930,21 @@ class InstructionsCompatibilityAnalysis {\n     }\n     unsigned BestOpcodeNum = 0;\n     MainOp = nullptr;\n+    bool UsedOutside = false;\n     for (const auto &P : Candidates) {\n+      bool PUsedOutside = all_of(P.second, isUsedOutsideBlock);\n+      if (UsedOutside && !PUsedOutside)\n+        continue;\n+      if (!UsedOutside && PUsedOutside)\n+        BestOpcodeNum = 0;\n       if (P.second.size() < BestOpcodeNum)\n         continue;\n       // If have inner dependencies - skip.\n-      if (any_of(P.second,\n-                 [&](Instruction *I) { return Operands.contains(I); }))\n+      if (!PUsedOutside && any_of(P.second, [&](Instruction *I) {\n+            return Operands.contains(I);\n+          }))\n         continue;\n+      UsedOutside = PUsedOutside;\n       for (Instruction *I : P.second) {\n         if (IsSupportedInstruction(I, AnyUndef)) {\n           MainOp = I;\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/copyable-child-node-used-outside.ll",
      "commands": [
        "opt -passes=slp-vectorizer -S -slp-threshold=-99999 -mtriple=x86_64-unknown-linux-gnu < %s"
      ],
      "tests": [
        {
          "test_name": "test",
          "test_body": "define <4 x i32> @test() {\nbb:\n  %trunc = trunc i64 0 to i32\n  br label %bb1\n\nbb1:                                              ; preds = %bb\n  %or = or i32 %trunc, 0\n  %zext = zext i32 %or to i64\n  %and = and i32 0, 0\n  %or2 = or i32 %trunc, 0\n  br label %bb3\n\nbb3:                                              ; preds = %bb1\n  %0 = insertelement <4 x i32> zeroinitializer, i32 %trunc, i32 0\n  %1 = insertelement <4 x i32> %0, i32 %and, i32 1\n  %2 = insertelement <4 x i32> %1, i32 %or2, i32 2\n  %3 = insertelement <4 x i32> %2, i32 %or, i32 3\n  ret <4 x i32> %3\n}\n"
        }
      ]
    },
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/copyable-with-used-outside-bb.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=x86_64-unknown-linux-gnu -slp-threshold=-99999 < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ndefine void @test(i32 %arg) {\n;\nbb:\n  br label %bb1\n\nbb1:\n  %sub = sub i32 0, %arg\n  %add = add i32 7, 0\n  %icmp = icmp ult i32 %add, 0\n  br i1 false, label %bb2, label %bb3\n\nbb2:\n  br label %bb3\n\nbb3:\n  %phi = phi i32 [ 7, %bb2 ], [ 0, %bb1 ]\n  %phi4 = phi i32 [ %sub, %bb2 ], [ %sub, %bb1 ]\n  %phi5 = phi i32 [ %add, %bb2 ], [ %add, %bb1 ]\n  %phi6 = phi i32 [ %add, %bb2 ], [ 0, %bb1 ]\n  ret void\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "Instruction does not dominate all uses! ... LLVM ERROR: Broken module found, compilation aborted!",
    "body": "To reproduce run opt with the test below (-passes=slp-vectorizer -slp-threshold=-99999):\n```\n; ModuleID = './reduced.ll'\nsource_filename = \"./reduced.ll\"\ntarget datalayout = \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128-ni:1-p2:32:8:8:32-ni:2\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\ndefine void @wombat(i32 %arg) #0 gc \"statepoint-example\" {\nbb:\n  br label %bb1\n\nbb1:                                              ; preds = %bb\n  %sub = sub i32 0, %arg\n  %add = add i32 7, 0\n  %icmp = icmp ult i32 %add, 0\n  br i1 false, label %bb2, label %bb3\n\nbb2:                                              ; preds = %bb1\n  br label %bb3\n\nbb3:                                              ; preds = %bb2, %bb1\n  %phi = phi i32 [ 7, %bb2 ], [ 0, %bb1 ]\n  %phi4 = phi i32 [ %sub, %bb2 ], [ %sub, %bb1 ]\n  %phi5 = phi i32 [ %add, %bb2 ], [ %add, %bb1 ]\n  %phi6 = phi i32 [ %add, %bb2 ], [ 0, %bb1 ]\n  ret void\n}\n\nattributes #0 = { \"target-features\"=\"+prfchw,-cldemote,+avx,+aes,+sahf,+pclmul,-xop,+crc32,-amx-fp8,+xsaves,-avx512fp16,-usermsr,-sm4,-egpr,+sse4.1,-avx10.1,-avx512ifma,+xsave,+sse4.2,-tsxldtrk,-sm3,-ptwrite,-widekl,-movrs,-invpcid,+64bit,+xsavec,-avx512vpopcntdq,+cmov,-avx512vp2intersect,-avx512cd,+movbe,-avxvnniint8,-ccmp,-amx-int8,-kl,-sha512,-avxvnni,-rtm,+adx,+avx2,-hreset,-movdiri,-serialize,-vpclmulqdq,-avx512vl,-uintr,-cf,+clflushopt,-raoint,-cmpccxadd,+bmi,-amx-tile,+sse,-gfni,-avxvnniint16,-amx-fp16,-zu,-ndd,+xsaveopt,+rdrnd,-avx512f,-amx-bf16,-avx512bf16,-avx512vnni,-push2pop2,+cx8,-avx512bw,+sse3,-pku,-nf,-amx-tf32,-amx-avx512,+fsgsbase,+clzero,-mwaitx,-lwp,+lzcnt,+sha,-movdir64b,-ppx,+wbnoinvd,-enqcmd,-avxneconvert,-tbm,-pconfig,-amx-complex,+ssse3,+cx16,-avx10.2,+bmi2,+fma,+popcnt,-avxifma,+f16c,-avx512bitalg,-rdpru,+clwb,+mmx,+sse2,+rdseed,-avx512vbmi2,-prefetchi,-amx-movrs,+rdpid,-fma4,-avx512vbmi,-shstk,-vaes,-waitpkg,-sgx,+fxsr,-avx512dq,+sse4a\" }\n```\nReproducer:  https://godbolt.org/z/zG7fPh7sa\n\nStack dump:\n```\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=slp-vectorizer -slp-threshold=-99999 <source>\n1.\tRunning pass \"verify\" on module \"<source>\"\n #0 0x00000000059f2228 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x59f2228)\n #1 0x00000000059ef0d4 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x000074bb71c42520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x000074bb71c969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x000074bb71c42476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x000074bb71c287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000000000082fd6b llvm::json::operator==(llvm::json::Value const&, llvm::json::Value const&) (.cold) JSON.cpp:0:0\n #7 0x0000000005926781 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5926781)\n #8 0x0000000005811438 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5811438)\n #9 0x00000000009795be llvm::detail::PassModel<llvm::Module, llvm::VerifierPass, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9795be)\n#10 0x00000000057cd9c1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x57cd9c1)\n#11 0x000000000098390a llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x98390a)\n#12 0x00000000009777a8 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9777a8)\n#13 0x000074bb71c29d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#14 0x000074bb71c29e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#15 0x000000000096e255 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x96e255)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "TatyanaDoubts",
    "labels": [
      "crash-on-invalid",
      "llvm:SLPVectorizer"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}