{
  "bug_id": "156656",
  "issue_url": "https://github.com/llvm/llvm-project/issues/156656",
  "bug_type": "crash",
  "base_commit": "57b1b254297ed2d2fd9560e6a5eef0c44918223a",
  "knowledge_cutoff": "2025-09-03T12:40:52Z",
  "lit_test_dir": [
    "llvm/test/Transforms/GlobalOpt"
  ],
  "hints": {
    "fix_commit": "f80e7e139e3e677638233037499f8cba50c66b9e",
    "components": [
      "GlobalOpt"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/IPO/GlobalOpt.cpp": [
        [
          1680,
          1686
        ],
        [
          1766,
          1775
        ],
        [
          1779,
          1785
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/IPO/GlobalOpt.cpp": [
        "ChangeCalleesToFastCall",
        "StripAttr",
        "changeCallSitesToColdCC",
        "isValidCandidateForColdCC"
      ]
    }
  },
  "patch": "commit f80e7e139e3e677638233037499f8cba50c66b9e\nAuthor: Hongyu Chen <xxs_chy@outlook.com>\nDate:   Wed Oct 1 16:47:41 2025 +0800\n\n    [GlobalOpt] Check if users are CallBase when changing CC (#161399)\n    \n    Fixes https://github.com/llvm/llvm-project/issues/156656\n    `hasChangeableCCImpl` guarantees the address of the function is not\n    taken, but it ignores assume-like calls.\n    This patch ignores assume-like calls when changing CC.\n\ndiff --git a/llvm/lib/Transforms/IPO/GlobalOpt.cpp b/llvm/lib/Transforms/IPO/GlobalOpt.cpp\nindex f88d51f443bc..99c4982c58b4 100644\n--- a/llvm/lib/Transforms/IPO/GlobalOpt.cpp\n+++ b/llvm/lib/Transforms/IPO/GlobalOpt.cpp\n@@ -1680,7 +1680,9 @@ processGlobal(GlobalValue &GV,\n /// FastCC.\n static void ChangeCalleesToFastCall(Function *F) {\n   for (User *U : F->users())\n-    cast<CallBase>(U)->setCallingConv(CallingConv::Fast);\n+    if (auto *Call = dyn_cast<CallBase>(U))\n+      if (Call->getCalledOperand() == F)\n+        Call->setCallingConv(CallingConv::Fast);\n }\n \n static AttributeList StripAttr(LLVMContext &C, AttributeList Attrs,\n@@ -1766,10 +1768,12 @@ isValidCandidateForColdCC(Function &F,\n     return false;\n \n   for (User *U : F.users()) {\n-    CallBase &CB = cast<CallBase>(*U);\n-    Function *CallerFunc = CB.getParent()->getParent();\n+    CallBase *CB = dyn_cast<CallBase>(U);\n+    if (!CB || CB->getCalledOperand() != &F)\n+      continue;\n+    Function *CallerFunc = CB->getParent()->getParent();\n     BlockFrequencyInfo &CallerBFI = GetBFI(*CallerFunc);\n-    if (!isColdCallSite(CB, CallerBFI))\n+    if (!isColdCallSite(*CB, CallerBFI))\n       return false;\n     if (!llvm::is_contained(AllCallsCold, CallerFunc))\n       return false;\n@@ -1779,7 +1783,9 @@ isValidCandidateForColdCC(Function &F,\n \n static void changeCallSitesToColdCC(Function *F) {\n   for (User *U : F->users())\n-    cast<CallBase>(U)->setCallingConv(CallingConv::Cold);\n+    if (auto *Call = dyn_cast<CallBase>(U))\n+      if (Call->getCalledOperand() == F)\n+        Call->setCallingConv(CallingConv::Cold);\n }\n \n // This function iterates over all the call instructions in the input Function\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/GlobalOpt/fastcc.ll",
      "commands": [
        "opt < %s -passes=globalopt -S"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ndeclare token @llvm.call.preallocated.setup(i32)\ndeclare ptr @llvm.call.preallocated.arg(token, i32)\n\ndefine internal i32 @f(ptr %m) {\n;\n  %v = load i32, ptr %m\n  ret i32 %v\n}\n\ndefine internal x86_thiscallcc i32 @g(ptr %m) {\n;\n  %v = load i32, ptr %m\n  ret i32 %v\n}\n\n; Leave this one alone, because the user went out of their way to request this\n; convention.\ndefine internal coldcc i32 @h(ptr %m) {\n;\n  %v = load i32, ptr %m\n  ret i32 %v\n}\n\ndefine internal i32 @j(ptr %m) {\n;\n  %v = load i32, ptr %m\n  ret i32 %v\n}\n\ndefine internal i32 @inalloca(ptr inalloca(i32) %p) {\n;\n  %rv = load i32, ptr %p\n  ret i32 %rv\n}\n\ndefine i32 @inalloca2_caller(ptr inalloca(i32) %p) {\n;\n  %rv = musttail call i32 @inalloca2(ptr inalloca(i32) %p)\n  ret i32 %rv\n}\ndefine internal i32 @inalloca2(ptr inalloca(i32) %p) {\n; Because of the musttail caller, this inalloca cannot be dropped.\n;\n  %rv = load i32, ptr %p\n  ret i32 %rv\n}\n\ndefine internal i32 @preallocated(ptr preallocated(i32) %p) {\n;\n  %rv = load i32, ptr %p\n  ret i32 %rv\n}\n\ndefine void @call_things() {\n;\n  %m = alloca i32\n  call i32 @f(ptr %m)\n  call x86_thiscallcc i32 @g(ptr %m)\n  call coldcc i32 @h(ptr %m)\n  call i32 @j(ptr %m)\n  %args = alloca inalloca i32\n  call i32 @inalloca(ptr inalloca(i32) %args)\n  %c = call token @llvm.call.preallocated.setup(i32 1)\n  %N = call ptr @llvm.call.preallocated.arg(token %c, i32 0) preallocated(i32)\n  call i32 @preallocated(ptr preallocated(i32) %N) [\"preallocated\"(token %c)]\n  ret void\n}\n\n@llvm.used = appending global [1 x ptr] [\n  ptr @j\n], section \"llvm.metadata\"\n\ndefine internal i32 @assume_fastcc() {\n;\n  %objsize = call i32 @llvm.objectsize.i32.p0(ptr @assume_fastcc, i1 false, i1 false, i1 false)\n  ret i32 %objsize\n}\n\ndefine internal i32 @constexpr_self_user() addrspace(1) {\n;\n  %objsize = call i32 @llvm.objectsize.i32.p0(ptr addrspacecast (ptr addrspace(1) @constexpr_self_user to ptr), i1 false, i1 false, i1 false)\n  ret i32 %objsize\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "crashes with assertion failure when running opt -passes=globalopt",
    "body": "Run opt with -passes=globalopt\n\nReproducer:\nhttps://godbolt.org/z/6obEYeKEh\n\nBacktrace:\n```console\nopt: /root/llvm-project/llvm/include/llvm/Support/Casting.h:578: decltype(auto) llvm::cast(From*) [with To = llvm::CallBase; From = llvm::User]: Assertion `isa<To>(Val) && \"cast<Ty>() argument of incompatible type!\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=globalopt <source>\n1.\tRunning pass \"globalopt\" on module \"<source>\"\n #0 0x000000000578f178 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x578f178)\n #1 0x000000000578c024 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x000071ca6f842520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x000071ca6f8969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x000071ca6f842476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x000071ca6f8287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000071ca6f82871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x000071ca6f839e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x00000000030ac2ea optimizeGlobalsInModule(llvm::Module&, llvm::DataLayout const&, llvm::function_ref<llvm::TargetLibraryInfo& (llvm::Function&)>, llvm::function_ref<llvm::TargetTransformInfo& (llvm::Function&)>, llvm::function_ref<llvm::BlockFrequencyInfo& (llvm::Function&)>, llvm::function_ref<llvm::DominatorTree& (llvm::Function&)>, llvm::function_ref<void (llvm::Function&)>, llvm::function_ref<void (llvm::Function&)>) (.constprop.0) GlobalOpt.cpp:0:0\n #9 0x00000000030ad19f llvm::GlobalOptPass::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x30ad19f)\n#10 0x0000000002e23dae llvm::detail::PassModel<llvm::Module, llvm::GlobalOptPass, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x2e23dae)\n#11 0x0000000005578c41 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5578c41)\n#12 0x0000000000976da8 llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x976da8)\n#13 0x000000000096ae17 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x96ae17)\n#14 0x000071ca6f829d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#15 0x000071ca6f829e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#16 0x0000000000961f35 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x961f35)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "k-arrows",
    "labels": [
      "ipo",
      "crash"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": false
  },
  "verified": true
}