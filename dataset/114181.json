{
  "bug_id": "114181",
  "issue_url": "https://github.com/llvm/llvm-project/issues/114181",
  "bug_type": "miscompilation",
  "base_commit": "d6d73ec89e493c69cf24dc3a710d861e2ce08acb",
  "knowledge_cutoff": "2024-10-30T04:57:32Z",
  "lit_test_dir": [
    "llvm/test/Transforms/InstCombine"
  ],
  "hints": {
    "fix_commit": "ff07df6620c32571c7e13ff96ec7976c63ed0ab8",
    "components": [
      "InstCombine"
    ],
    "files": [
      "llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp": [
        [
          333,
          338
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp": [
        "Negator::visitImpl"
      ]
    }
  },
  "patch": "commit ff07df6620c32571c7e13ff96ec7976c63ed0ab8\nAuthor: Yingwei Zheng <dtcxzyw2333@gmail.com>\nDate:   Fri Nov 8 16:20:04 2024 +0800\n\n    [InstCombine] Drop nsw in negation of select (#112893)\n    \n    Closes https://github.com/llvm/llvm-project/issues/112666 and\n    https://github.com/llvm/llvm-project/issues/114181.\n\ndiff --git a/llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp b/llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp\nindex 9bd848552615..2210336d92bf 100644\n--- a/llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp\n+++ b/llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp\n@@ -333,6 +333,17 @@ std::array<Value *, 2> Negator::getSortedOperandsOfBinOp(Instruction *I) {\n       NewSelect->swapValues();\n       // Don't swap prof metadata, we didn't change the branch behavior.\n       NewSelect->setName(I->getName() + \".neg\");\n+      // Poison-generating flags should be dropped\n+      Value *TV = NewSelect->getTrueValue();\n+      Value *FV = NewSelect->getFalseValue();\n+      if (match(TV, m_Neg(m_Specific(FV))))\n+        cast<Instruction>(TV)->dropPoisonGeneratingFlags();\n+      else if (match(FV, m_Neg(m_Specific(TV))))\n+        cast<Instruction>(FV)->dropPoisonGeneratingFlags();\n+      else {\n+        cast<Instruction>(TV)->dropPoisonGeneratingFlags();\n+        cast<Instruction>(FV)->dropPoisonGeneratingFlags();\n+      }\n       Builder.Insert(NewSelect);\n       return NewSelect;\n     }\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/InstCombine/sub-of-negatible.ll",
      "commands": [
        "opt < %s -passes=instcombine -S"
      ],
      "tests": [
        {
          "test_name": "negate_select_of_op_vs_negated_op",
          "test_body": "declare void @use8(i8)\n\ndefine i8 @negate_select_of_op_vs_negated_op(i8 %x, i8 %y, i1 %c) {\n  %t0 = sub i8 0, %x\n  call void @use8(i8 %t0)\n  %t1 = select i1 %c, i8 %t0, i8 %x, !prof !0\n  %t2 = sub i8 %y, %t1\n  ret i8 %t2\n}\n\n!0 = !{!\"branch_weights\", i32 40, i32 1}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[InstCombine] Wrong negation of vector selection with a poison value",
    "body": "https://github.com/llvm/llvm-project/blob/9a7519fdb39f21a807189e1ed06826b43db929e1/llvm/lib/Transforms/InstCombine/InstCombineNegator.cpp#L327-L350\r\n\r\n\r\nAlive2 report: https://alive2.llvm.org/ce/z/tdHHuq\r\n\r\n\r\n```llvm\r\n----------------------------------------\r\ndefine <2 x i32> @negate_select_of_negation_poison.2(<2 x i1> %c, <2 x i32> %x) {\r\n#0:\r\n  %#1 = srem <2 x i32> { poison, 0 }, %x\r\n  %neg = sub nsw <2 x i32> %#1, %x\r\n  %sel = select <2 x i1> %c, <2 x i32> %neg, <2 x i32> %x\r\n  %neg2 = sub <2 x i32> %x, %sel\r\n  ret <2 x i32> %neg2\r\n}\r\n=>\r\ndefine <2 x i32> @negate_select_of_negation_poison.2(<2 x i1> %c, <2 x i32> %x) {\r\n#0:\r\n  %neg = sub nsw <2 x i32> { 0, 0 }, %x\r\n  %#1 = select <2 x i1> %c, <2 x i32> %x, <2 x i32> %neg\r\n  %neg2 = add <2 x i32> %#1, %x\r\n  ret <2 x i32> %neg2\r\n}\r\nTransformation doesn't verify!\r\n\r\nERROR: Target is more poisonous than source\r\n\r\nExample:\r\n<2 x i1> %c = < #x0 (0), #x0 (0) >\r\n<2 x i32> %x = < #x80000000 (2147483648, -2147483648), #x0000000d (13) >\r\n\r\nSource:\r\n<2 x i32> %#1 = < poison, #x00000000 (0) >\r\n<2 x i32> %neg = < poison, #xfffffff3 (4294967283, -13) >\r\n<2 x i32> %sel = < #x80000000 (2147483648, -2147483648), #x0000000d (13) >\r\n<2 x i32> %neg2 = < #x00000000 (0), #x00000000 (0) >\r\n\r\nTarget:\r\n<2 x i32> %neg = < poison, #xfffffff3 (4294967283, -13) >\r\n<2 x i32> %#1 = < poison, #xfffffff3 (4294967283, -13) >\r\n<2 x i32> %neg2 = < poison, #x00000000 (0) >\r\nSource value: < #x00000000 (0), #x00000000 (0) >\r\nTarget value: < poison, #x00000000 (0) >\r\n\r\nSummary:\r\n  0 correct transformations\r\n  1 incorrect transformations\r\n  0 failed-to-prove transformations\r\n  0 Alive2 errors\r\n```",
    "author": "bongjunj",
    "labels": [
      "miscompilation",
      "llvm:instcombine"
    ],
    "comments": [
      {
        "author": "dtcxzyw",
        "body": "Duplicate of https://github.com/llvm/llvm-project/issues/112666"
      }
    ]
  }
}