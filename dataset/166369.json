{
  "bug_id": "166369",
  "issue_url": "https://github.com/llvm/llvm-project/issues/166369",
  "bug_type": "crash",
  "base_commit": "a02e5740119a4d13542126b124f2c464b23738d4",
  "knowledge_cutoff": "2025-11-04T13:12:21Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SimplifyCFG"
  ],
  "hints": {
    "fix_commit": "4ce58833d3653f0b15d5458b8430ec8cf25fdc16",
    "components": [
      "SimplifyCFG"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Utils/SimplifyCFG.cpp": [
        [
          778,
          785
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Utils/SimplifyCFG.cpp": [
        "matchInstruction"
      ]
    }
  },
  "patch": "commit 4ce58833d3653f0b15d5458b8430ec8cf25fdc16\nAuthor: Yingwei Zheng <dtcxzyw2333@gmail.com>\nDate:   Wed Nov 5 01:43:05 2025 +0800\n\n    [SimplifyCFG] Fix value enumeration of a full range (#166379)\n    \n    ConstantRange uses `[-1, -1)` as the canonical form of a full set.\n    Therefore, the `for (APInt I = Lower; I != Upper; ++I)` idiom doesn't\n    work for full ranges. This patch fixes the value enumeration in\n    `ConstantComparesGatherer` to prevent missing values for full sets.\n    \n    Closes https://github.com/llvm/llvm-project/issues/166369.\n\ndiff --git a/llvm/lib/Transforms/Utils/SimplifyCFG.cpp b/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\nindex 532511dcf91b..3a3e3ade2021 100644\n--- a/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\n+++ b/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\n@@ -778,8 +778,10 @@ private:\n       return false;\n \n     // Add all values from the range to the set\n-    for (APInt Tmp = Span.getLower(); Tmp != Span.getUpper(); ++Tmp)\n+    APInt Tmp = Span.getLower();\n+    do\n       Vals.push_back(ConstantInt::get(I->getContext(), Tmp));\n+    while (++Tmp != Span.getUpper());\n \n     UsedICmps++;\n     return true;\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SimplifyCFG/pr166369.ll",
      "commands": [
        "opt -S -passes=simplifycfg < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\n; Make sure we handle full-set ranges correctly.\ndefine void @test_i1() {\n;\nbb:\n  %icmp = icmp ugt i1 false, true\n  br label %bb5\n\nbb5:\n  %select = select i1 %icmp, i1 %icmp, i1 false\n  br i1 %select, label %bb5, label %bb6\n\nbb6:\n  ret void\n}\n\ndefine void @test_i3() {\n;\nbb:\n  %icmp = icmp ugt i3 0, 7\n  br label %bb5\n\nbb5:\n  %select = select i1 %icmp, i1 %icmp, i1 false\n  br i1 %select, label %bb5, label %bb6\n\nbb6:\n  ret void\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "SmallVector: Assertion `!empty()' failed",
    "body": "This is generated by one of our fuzz tests rather than found in a real project, however this is also a very recent regression. I've bisected it to e8a1162b7be6cf11041260886097843ce9f5e4a3.\n\nhttps://godbolt.org/z/xqzEPPaoK\n\n```\ndefine void @widget() {\nbb:\n  %icmp = icmp ugt i1 false, true\n  br label %bb1\n\nbb1:                                              ; preds = %bb\n  br label %bb2\n\nbb2:                                              ; preds = %bb1\n  br label %bb3\n\nbb3:                                              ; preds = %bb2\n  br label %bb4\n\nbb4:                                              ; preds = %bb3\n  br label %bb5\n\nbb5:                                              ; preds = %bb5, %bb4\n  %select = select i1 %icmp, i1 %icmp, i1 false\n  br i1 %select, label %bb5, label %bb6\n\nbb6:                                              ; preds = %bb6, %bb5\n  br label %bb6\n}\n```\n\n```\nopt: /root/llvm-project/llvm/include/llvm/ADT/SmallVector.h:313: T& llvm::SmallVectorTemplateCommon<T, <template-parameter-1-2> >::back() [with T = llvm::ConstantInt*; <template-parameter-1-2> = void; llvm::SmallVectorTemplateCommon<T, <template-parameter-1-2> >::reference = llvm::ConstantInt*&]: Assertion `!empty()' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S --passes=simplifycfg <source>\n1.\tRunning pass \"function(simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;no-switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>)\" on module \"<source>\"\n2.\tRunning pass \"simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;no-switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>\" on function \"widget\"\n #0 0x0000000005989ef8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5989ef8)\n #1 0x0000000005986da4 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x000074d3a5642520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x000074d3a56969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x000074d3a5642476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x000074d3a56287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000074d3a562871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x000074d3a5639e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x0000000004c646ae (anonymous namespace)::SimplifyCFGOpt::simplifyCondBranch(llvm::BranchInst*, llvm::IRBuilder<llvm::ConstantFolder, llvm::IRBuilderDefaultInserter>&) SimplifyCFG.cpp:0:0\n #9 0x0000000004c65337 llvm::simplifyCFG(llvm::BasicBlock*, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&, llvm::ArrayRef<llvm::WeakVH>) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4c65337)\n#10 0x000000000485f764 iterativelySimplifyCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#11 0x00000000048606b4 simplifyFunctionCFGImpl(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#12 0x0000000004861835 simplifyFunctionCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#13 0x000000000486197a llvm::SimplifyCFGPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x486197a)\n#14 0x00000000016e89ae llvm::detail::PassModel<llvm::Function, llvm::SimplifyCFGPass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x16e89ae)\n#15 0x0000000005763711 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5763711)\n#16 0x0000000000efdf2e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xefdf2e)\n#17 0x0000000005761d8a llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5761d8a)\n#18 0x000000000097972e llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97972e)\n#19 0x0000000005761741 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5761741)\n#20 0x00000000009838ca llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9838ca)\n#21 0x0000000000977b41 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x977b41)\n#22 0x000074d3a5629d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#23 0x000074d3a5629e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#24 0x000000000096ef55 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x96ef55)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```\n",
    "author": "gregbedwell",
    "labels": [
      "crash-on-valid",
      "llvm:transforms",
      "generated by fuzzer"
    ],
    "comments": [
      {
        "author": "dtcxzyw",
        "body": "Confirmed. I will post a fix.\n"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}