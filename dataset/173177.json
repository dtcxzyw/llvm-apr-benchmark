{
  "bug_id": "173177",
  "issue_url": "https://github.com/llvm/llvm-project/issues/173177",
  "bug_type": "crash",
  "base_commit": "f06f5b53443cddba42b4cd446df52f344f2f0412",
  "knowledge_cutoff": "2025-12-21T06:49:08Z",
  "lit_test_dir": [
    "llvm/test/Transforms/InstCombine"
  ],
  "hints": {
    "fix_commit": "0952ccc712ffc97943fbd0fc3c38a53e7aa875ac",
    "components": [
      "InstCombine"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp": [
        [
          3093,
          3099
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp": [
        "InstCombinerImpl::foldICmpBinOpWithConstantViaTruthTable"
      ]
    }
  },
  "patch": "commit 0952ccc712ffc97943fbd0fc3c38a53e7aa875ac\nAuthor: Hongyu Chen <xxs_chy@outlook.com>\nDate:   Sun Dec 21 16:40:38 2025 +0800\n\n    [InstCombine] Bail out on type mismatch in foldICmpBinOpWithConstantViaTruthTable (#173179)\n    \n    Fixes https://github.com/llvm/llvm-project/issues/173177\n    The previous implementation doesn't consider cases like `<2 x i1>\n    icmp(binop(sel <2 x i1>, sel i1))`.\n\ndiff --git a/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp b/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\nindex 616cb04be9db..7f1ced9505b9 100644\n--- a/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\n+++ b/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\n@@ -3093,7 +3093,7 @@ Instruction *InstCombinerImpl::foldICmpBinOpWithConstantViaTruthTable(\n               m_Select(m_Value(A), m_Constant(C1), m_Constant(C2)))) ||\n       !match(BO->getOperand(1),\n              m_Select(m_Value(B), m_Constant(C3), m_Constant(C4))) ||\n-      Cmp.getType() != A->getType())\n+      Cmp.getType() != A->getType() || Cmp.getType() != B->getType())\n     return nullptr;\n \n   std::bitset<4> Table;\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/InstCombine/icmp-binop.ll",
      "commands": [
        "opt < %s -passes=instcombine -S"
      ],
      "tests": [
        {
          "test_name": "mul_unkV_oddC_eq",
          "test_body": "define i1 @mul_unkV_oddC_eq(i32 %v) {\n  %mul = mul i32 %v, 3\n  %cmp = icmp eq i32 %mul, 0\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "icmp_eq_or_of_selects_with_constant_vectorized_nonsplat",
          "test_body": "define <2 x i1> @icmp_eq_or_of_selects_with_constant_vectorized_nonsplat(<2 x i1> %a, <2 x i1> %b) {\n  %s1 = select <2 x i1> %a, <2 x i64> splat (i64 65536), <2 x i64> zeroinitializer\n  %s2 = select <2 x i1> %b, <2 x i64> <i64 256, i64 128>, <2 x i64> zeroinitializer\n  %or = or <2 x i64> %s1, %s2\n  %cmp = icmp eq <2 x i64> %or, <i64 65792, i64 65664>\n  ret <2 x i1> %cmp\n}\n"
        },
        {
          "test_name": "pr173177",
          "test_body": "define <2 x i1> @pr173177(<2 x i1> %a, i1 %b) {\nentry:\n  %s1 = select <2 x i1> %a, <2 x i16> splat (i16 179), <2 x i16> splat (i16 1)\n  %s2 = select i1 %b, <2 x i16> zeroinitializer, <2 x i16> splat (i16 255)\n  %and = and <2 x i16> %s1, %s2\n  %cmp = icmp eq <2 x i16> %and, zeroinitializer\n  ret <2 x i1> %cmp\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[InstCombine] Assertion `New->getType() == getType() && \"replaceAllUses of value with new value of different type!\"' failed.",
    "body": "Reproducer: https://godbolt.org/z/raT3GvvGv\nTestcase:\n```llvm\ntarget datalayout = \"e-m:e-p:64:64-i64:64-i128:128-n32:64-S128\"\ntarget triple = \"riscv64-unknown-linux-musl\"\n\ndefine <2 x i1> @func_1(i1 %tobool117.not, <2 x i1> %0) {\nentry:\n  %cond131 = select i1 %tobool117.not, <8 x i8> <i8 poison, i8 poison, i8 poison, i8 9, i8 9, i8 poison, i8 poison, i8 poison>, <8 x i8> zeroinitializer\n  %1 = shufflevector <8 x i8> %cond131, <8 x i8> zeroinitializer, <2 x i32> <i32 3, i32 4>\n  %2 = select <2 x i1> %0, <2 x i16> splat (i16 179), <2 x i16> splat (i16 1)\n  %3 = zext <2 x i8> %1 to <2 x i16>\n  %4 = lshr <2 x i16> splat (i16 255), %3\n  %5 = and <2 x i16> %2, %4\n  %6 = icmp eq <2 x i16> %5, zeroinitializer\n  ret <2 x i1> %6\n}\n```\n\nDump:\n```\nopt: /root/llvm-project/llvm/lib/IR/Value.cpp:519: void llvm::Value::doRAUW(llvm::Value*, llvm::Value::ReplaceMetadataUses): Assertion `New->getType() == getType() && \"replaceAllUses of value with new value of different type!\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S --passes=instcombine <source>\n1.\tRunning pass \"function(instcombine<max-iterations=1;verify-fixpoint>)\" on module \"<source>\"\n2.\tRunning pass \"instcombine<max-iterations=1;verify-fixpoint>\" on function \"func_1\"\n #0 0x00000000059be998 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x59be998)\n #1 0x00000000059bb844 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x0000729660842520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x00007296608969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x0000729660842476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x00007296608287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000072966082871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x0000729660839e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x00000000057d3bb2 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x57d3bb2)\n #9 0x0000000000cc0924 llvm::InstCombiner::replaceInstUsesWith(llvm::Instruction&, llvm::Value*) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xcc0924)\n#10 0x0000000004993735 llvm::InstCombinerImpl::foldICmpBinOpWithConstantViaTruthTable(llvm::ICmpInst&, llvm::BinaryOperator*, llvm::APInt const&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4993735)\n#11 0x00000000049b706e llvm::InstCombinerImpl::foldICmpInstWithConstant(llvm::ICmpInst&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x49b706e)\n#12 0x00000000049c548e llvm::InstCombinerImpl::visitICmpInst(llvm::ICmpInst&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x49c548e)\n#13 0x000000000490e023 llvm::InstCombinerImpl::run() (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x490e023)\n#14 0x000000000490ff06 combineInstructionsOverFunction(llvm::Function&, llvm::InstructionWorklist&, llvm::AAResults*, llvm::AssumptionCache&, llvm::TargetLibraryInfo&, llvm::TargetTransformInfo&, llvm::DominatorTree&, llvm::OptimizationRemarkEmitter&, llvm::BlockFrequencyInfo*, llvm::BranchProbabilityInfo*, llvm::ProfileSummaryInfo*, llvm::InstCombineOptions const&) (.isra.0) InstructionCombining.cpp:0:0\n#15 0x0000000004911474 llvm::InstCombinePass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4911474)\n#16 0x0000000002ca3d4e llvm::detail::PassModel<llvm::Function, llvm::InstCombinePass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x2ca3d4e)\n#17 0x000000000579be41 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x579be41)\n#18 0x0000000000f0774e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xf0774e)\n#19 0x000000000579a50a llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x579a50a)\n#20 0x0000000000973a7e llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x973a7e)\n#21 0x0000000005799ec1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5799ec1)\n#22 0x000000000097ddaa llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97ddaa)\n#23 0x0000000000971c28 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x971c28)\n#24 0x0000729660829d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#25 0x0000729660829e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#26 0x00000000009686c5 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9686c5)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "XChy",
    "labels": [
      "llvm:instcombine",
      "crash-on-valid"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}