{
  "bug_id": "165301",
  "issue_url": "https://github.com/llvm/llvm-project/issues/165301",
  "bug_type": "crash",
  "base_commit": "6ba2127a5cbe87a97a01ee73b2ef2c4681203b8c",
  "knowledge_cutoff": "2025-10-27T19:27:45Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SimplifyCFG"
  ],
  "hints": {
    "fix_commit": "56777e7da2cb30f72a3ddc9861a2fbe3b9adbc6b",
    "components": [
      "SimplifyCFG"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Utils/SimplifyCFG.cpp": [
        [
          5977,
          5990
        ],
        [
          5993,
          5999
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Utils/SimplifyCFG.cpp": [
        "SimplifyCFGOpt::turnSwitchRangeIntoICmp"
      ]
    }
  },
  "patch": "commit 56777e7da2cb30f72a3ddc9861a2fbe3b9adbc6b\nAuthor: Yingwei Zheng <dtcxzyw2333@gmail.com>\nDate:   Fri Oct 31 10:30:29 2025 +0800\n\n    [SimplifyCFG] Avoid use-after-free when removing incoming values from PHI nodes (#165744)\n    \n    `PHINode::removeIncomingValue` removes itself when there are no incoming\n    edges. Then we cannot use it to retrieve the next instruction.\n    \n    Closes https://github.com/llvm/llvm-project/issues/165301.\n\ndiff --git a/llvm/lib/Transforms/Utils/SimplifyCFG.cpp b/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\nindex b03fb6213d61..7f6d779687e9 100644\n--- a/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\n+++ b/llvm/lib/Transforms/Utils/SimplifyCFG.cpp\n@@ -5977,14 +5977,14 @@ bool SimplifyCFGOpt::turnSwitchRangeIntoICmp(SwitchInst *SI,\n   }\n \n   // Prune obsolete incoming values off the successors' PHI nodes.\n-  for (auto BBI = Dest->begin(); isa<PHINode>(BBI); ++BBI) {\n+  for (auto &PHI : make_early_inc_range(Dest->phis())) {\n     unsigned PreviousEdges = Cases->size();\n     if (Dest == SI->getDefaultDest())\n       ++PreviousEdges;\n     for (unsigned I = 0, E = PreviousEdges - 1; I != E; ++I)\n-      cast<PHINode>(BBI)->removeIncomingValue(SI->getParent());\n+      PHI.removeIncomingValue(SI->getParent());\n   }\n-  for (auto BBI = OtherDest->begin(); isa<PHINode>(BBI); ++BBI) {\n+  for (auto &PHI : make_early_inc_range(OtherDest->phis())) {\n     unsigned PreviousEdges = OtherCases->size();\n     if (OtherDest == SI->getDefaultDest())\n       ++PreviousEdges;\n@@ -5993,7 +5993,7 @@ bool SimplifyCFGOpt::turnSwitchRangeIntoICmp(SwitchInst *SI,\n     if (NewBI->isUnconditional())\n       ++E;\n     for (unsigned I = 0; I != E; ++I)\n-      cast<PHINode>(BBI)->removeIncomingValue(SI->getParent());\n+      PHI.removeIncomingValue(SI->getParent());\n   }\n \n   // Clean up the default block - it may have phis or other instructions before\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SimplifyCFG/pr165301.ll",
      "commands": [
        "opt -S -passes=\"simplifycfg<switch-range-to-icmp>\" < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\n; Make sure there's no use after free when removing incoming values from PHI nodes\n\ndefine i32 @pr165301(i1 %cond) {\n;\nentry:\n  br label %switchbb\n\nswitchbb:\n  switch i1 %cond, label %default [\n  i1 false, label %switchbb\n  i1 true, label %switchbb\n  ]\n\ndefault:\n  %phi.lcssa = phi i32 [ 0, %switchbb ]\n  ret i32 %phi.lcssa\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SimplifyCFG] SIGSEGV at O3",
    "body": "Reproducer: https://godbolt.org/z/j4r194cah\n```\n; bin/opt -passes=simplifycfg<switch-range-to-icmp> test.ll -S\ntarget datalayout = \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\ndefine fastcc i32 @func_285(i1 %tobool271) {\nentry:\n  br label %if.then102\n\nif.then102:                                       ; preds = %if.then102, %if.then102, %entry\n  switch i1 %tobool271, label %default.unreachable [\n    i1 false, label %if.then102\n    i1 true, label %if.then102\n  ]\n\ndefault.unreachable:                              ; preds = %if.then102\n  %conv257.1.lcssa = phi i32 [ 0, %if.then102 ]\n  ret i32 %conv257.1.lcssa\n}\n```\n```\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=simplifycfg<switch-range-to-icmp> <source>\n1.\tRunning pass \"function(simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>)\" on module \"<source>\"\n2.\tRunning pass \"simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>\" on function \"func_285\"\n #0 0x0000000005975828 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5975828)\n #1 0x00000000059726d4 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x000073a3a8042520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x0000000004c4aabb (anonymous namespace)::SimplifyCFGOpt::simplifySwitch(llvm::SwitchInst*, llvm::IRBuilder<llvm::ConstantFolder, llvm::IRBuilderDefaultInserter>&) SimplifyCFG.cpp:0:0\n #4 0x0000000004c52343 llvm::simplifyCFG(llvm::BasicBlock*, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&, llvm::ArrayRef<llvm::WeakVH>) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4c52343)\n #5 0x000000000484f644 iterativelySimplifyCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n #6 0x0000000004850594 simplifyFunctionCFGImpl(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n #7 0x0000000004851715 simplifyFunctionCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n #8 0x000000000485185a llvm::SimplifyCFGPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x485185a)\n #9 0x00000000016dcc3e llvm::detail::PassModel<llvm::Function, llvm::SimplifyCFGPass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x16dcc3e)\n#10 0x000000000574f081 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x574f081)\n#11 0x0000000000efc57e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xefc57e)\n#12 0x000000000574d6fa llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x574d6fa)\n#13 0x000000000097bade llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97bade)\n#14 0x000000000574d0b1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x574d0b1)\n#15 0x0000000000985c7a llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x985c7a)\n#16 0x0000000000979ef1 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x979ef1)\n#17 0x000073a3a8029d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#18 0x000073a3a8029e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#19 0x0000000000971305 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x971305)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```\nNot sure if https://github.com/llvm/llvm-project/pull/165105 helps.\n",
    "author": "dtcxzyw",
    "labels": [
      "crash-on-valid",
      "llvm:transforms",
      "generated by fuzzer"
    ],
    "comments": [
      {
        "author": "dtcxzyw",
        "body": "Trigger another assertion after https://github.com/llvm/llvm-project/pull/165105.\n\n```\nopt: /home/dtcxzyw/WorkSpace/Projects/compilers/llvm-project/llvm/include/llvm/Support/Casting.h:109: static bool llvm::isa_impl_cl<To, const From*>::doit(const From*) [with To = llvm::PHINode; From = llvm::Instruction]: Assertion `Val && \"isa<> used on a null pointer\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.      Program arguments: bin/opt -passes=simplifycfg<switch-range-to-icmp> test.ll -S\n1.      Running pass \"function(simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>)\" on module \"test.ll\"\n2.      Running pass \"simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;no-switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>\" on function \"func_285\"\n #0 0x00007d665e653992 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/libLLVMSupport.so.22.0git+0x253992)\n #1 0x00007d665e64ff5f llvm::sys::RunSignalHandlers() (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/libLLVMSupport.so.22.0git+0x24ff5f)\n #2 0x00007d665e6500ac SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #3 0x00007d665e045330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)\n #4 0x00007d665e09eb2c __pthread_kill_implementation ./nptl/pthread_kill.c:44:76\n #5 0x00007d665e09eb2c __pthread_kill_internal ./nptl/pthread_kill.c:78:10\n #6 0x00007d665e09eb2c pthread_kill ./nptl/pthread_kill.c:89:10\n #7 0x00007d665e04527e raise ./signal/../sysdeps/posix/raise.c:27:6\n #8 0x00007d665e0288ff abort ./stdlib/abort.c:81:7\n #9 0x00007d665e02881b _nl_load_domain ./intl/loadmsgcat.c:1177:9\n#10 0x00007d665e03b517 (/lib/x86_64-linux-gnu/libc.so.6+0x3b517)\n#11 0x00007d66586bbe1c (anonymous namespace)::SimplifyCFGOpt::turnSwitchRangeIntoICmp(llvm::SwitchInst*, llvm::IRBuilder<llvm::ConstantFolder, llvm::IRBuilderDefaultInserter>&) SimplifyCFG.cpp:0:0\n#12 0x00007d66586e2df1 (anonymous namespace)::SimplifyCFGOpt::simplifySwitch(llvm::SwitchInst*, llvm::IRBuilder<llvm::ConstantFolder, llvm::IRBuilderDefaultInserter>&) SimplifyCFG.cpp:0:0\n#13 0x00007d66586eaf15 llvm::simplifyCFG(llvm::BasicBlock*, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&, llvm::ArrayRef<llvm::WeakVH>) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMTransformUtils.so.22.0git+0x2eaf15)\n#14 0x00007d66591c31ed iterativelySimplifyCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DomTreeUpdater*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#15 0x00007d66591c41b9 simplifyFunctionCFGImpl(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#16 0x00007d66591c4ba5 simplifyFunctionCFG(llvm::Function&, llvm::TargetTransformInfo const&, llvm::DominatorTree*, llvm::SimplifyCFGOptions const&) SimplifyCFGPass.cpp:0:0\n#17 0x00007d66591c4d00 llvm::SimplifyCFGPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMScalarOpts.so.22.0git+0x3c4d00)\n#18 0x00007d665b1a7195 llvm::detail::PassModel<llvm::Function, llvm::SimplifyCFGPass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libPolly.so.22.0git+0x1a7195)\n#19 0x00007d6657925189 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMCore.so.22.0git+0x325189)\n#20 0x00007d665d8dd385 llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMX86CodeGen.so.22.0git+0xdd385)\n#21 0x00007d6657923612 llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMCore.so.22.0git+0x323612)\n#22 0x00007d665e8e1375 llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/libLLVMOptDriver.so.22.0git+0x20375)\n#23 0x00007d6657923e3d llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/../lib/libLLVMCore.so.22.0git+0x323e3d)\n#24 0x00007d665e8ee3c1 llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/libLLVMOptDriver.so.22.0git+0x2d3c1)\n#25 0x00007d665e8f94e5 optMain (/home/dtcxzyw/WorkSpace/Projects/compilers/LLVM/llvm-build/bin/../lib/libLLVMOptDriver.so.22.0git+0x384e5)\n#26 0x00007d665e02a1ca __libc_start_call_main ./csu/../sysdeps/nptl/libc_start_call_main.h:74:3\n#27 0x00007d665e02a28b call_init ./csu/../csu/libc-start.c:128:20\n#28 0x00007d665e02a28b __libc_start_main ./csu/../csu/libc-start.c:347:5\n#29 0x0000620ebe031095 _start (bin/opt+0x1095)\nAborted (core dumped)\n```"
      },
      {
        "author": "dtcxzyw",
        "body": "https://github.com/llvm/llvm-project/blob/b258f5c2527f895dfa98921b61482978aba407e0/llvm/lib/Transforms/Utils/SimplifyCFG.cpp#L5978-L5988\n\n`removeIncomingValue` erases the PHI node. So there is a use-after-free in the next iteration. Unfortunately my machine is down while building LLVM :(\n"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}