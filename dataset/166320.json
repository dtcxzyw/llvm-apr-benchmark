{
  "bug_id": "166320",
  "issue_url": "https://github.com/llvm/llvm-project/issues/166320",
  "bug_type": "crash",
  "base_commit": "fd9dd4327f2a014ef531cc908923c05f31d0ea3e",
  "knowledge_cutoff": "2025-11-04T06:58:00Z",
  "lit_test_dir": [
    "llvm/test/Transforms/VectorCombine"
  ],
  "hints": {
    "fix_commit": "47d71b69b49326f0305b9250184974b6b7397d6f",
    "components": [],
    "bug_location_lineno": {
      "llvm/include/llvm/CodeGen/BasicTTIImpl.h": [
        [
          1331,
          1338
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/include/llvm/CodeGen/BasicTTIImpl.h": [
        "getCastInstrCost"
      ]
    }
  },
  "patch": "commit 47d71b69b49326f0305b9250184974b6b7397d6f\nAuthor: Shakil Ahmed <44522075+ahmedshakill@users.noreply.github.com>\nDate:   Thu Nov 6 18:45:42 2025 +0600\n\n    [BasicTTI] Only split vectors with even element counts in getCastInstrCost (#166528)\n    \n    Fixes #166320\n\ndiff --git a/llvm/include/llvm/CodeGen/BasicTTIImpl.h b/llvm/include/llvm/CodeGen/BasicTTIImpl.h\nindex 221d8f1e2f67..f58525754d7a 100644\n--- a/llvm/include/llvm/CodeGen/BasicTTIImpl.h\n+++ b/llvm/include/llvm/CodeGen/BasicTTIImpl.h\n@@ -1331,8 +1331,8 @@ public:\n       bool SplitDst =\n           TLI->getTypeAction(Dst->getContext(), TLI->getValueType(DL, Dst)) ==\n           TargetLowering::TypeSplitVector;\n-      if ((SplitSrc || SplitDst) && SrcVTy->getElementCount().isVector() &&\n-          DstVTy->getElementCount().isVector()) {\n+      if ((SplitSrc || SplitDst) && SrcVTy->getElementCount().isKnownEven() &&\n+          DstVTy->getElementCount().isKnownEven()) {\n         Type *SplitDstTy = VectorType::getHalfElementsVectorType(DstVTy);\n         Type *SplitSrcTy = VectorType::getHalfElementsVectorType(SrcVTy);\n         const T *TTI = thisT();\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/VectorCombine/AArch64/sve-interleave-splat.ll",
      "commands": [
        "opt -passes=vector-combine %s -S -o -"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ntarget triple = \"aarch64-unknown-linux-gnu\"\n\ndefine <vscale x 4 x i16> @interleave2_same_const_splat_nxv4i16() {\n;CHECK-LABEL: @interleave2_same_const_splat_nxv4i16(\n;CHECK: call <vscale x 4 x i16> @llvm.vector.interleave2\n;CHECK: ret <vscale x 4 x i16> %retval\n  %retval = call <vscale x 4 x i16> @llvm.vector.interleave2.nxv4i16(<vscale x 2 x i16> splat(i16 3), <vscale x 2 x i16> splat(i16 3))\n  ret <vscale x 4 x i16> %retval\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "[AArch64] Assertion `EltCnt.isKnownEven() && \"Cannot halve vector with odd number of elements.\"' failed.",
    "body": "Reproducer:\nhttps://godbolt.org/z/a3WMoGhPd\n\nBacktrace:\n```console\nopt: /root/llvm-project/llvm/include/llvm/IR/DerivedTypes.h:538: static llvm::VectorType* llvm::VectorType::getHalfElementsVectorType(llvm::VectorType*): Assertion `EltCnt.isKnownEven() && \"Cannot halve vector with odd number of elements.\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=vector-combine <source>\n1.\tRunning pass \"function(vector-combine)\" on module \"<source>\"\n2.\tRunning pass \"vector-combine\" on function \"interleave2_same_const_splat_nxv4i16\"\n #0 0x0000000005989ef8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5989ef8)\n #1 0x0000000005986da4 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x000078099b042520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x000078099b0969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x000078099b042476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x000078099b0287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000078099b02871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x000078099b039e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x0000000000bd6b5a llvm::BasicTTIImplBase<llvm::AArch64TTIImpl>::getCastInstrCost(unsigned int, llvm::Type*, llvm::Type*, llvm::TargetTransformInfo::CastContextHint, llvm::TargetTransformInfo::TargetCostKind, llvm::Instruction const*) const (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xbd6b5a)\n #9 0x0000000000bd6cd8 llvm::AArch64TTIImpl::getCastInstrCost(unsigned int, llvm::Type*, llvm::Type*, llvm::TargetTransformInfo::CastContextHint, llvm::TargetTransformInfo::TargetCostKind, llvm::Instruction const*) const (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xbd6cd8)\n#10 0x0000000000bd6841 llvm::BasicTTIImplBase<llvm::AArch64TTIImpl>::getCastInstrCost(unsigned int, llvm::Type*, llvm::Type*, llvm::TargetTransformInfo::CastContextHint, llvm::TargetTransformInfo::TargetCostKind, llvm::Instruction const*) const (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xbd6841)\n#11 0x0000000000bd6cd8 llvm::AArch64TTIImpl::getCastInstrCost(unsigned int, llvm::Type*, llvm::Type*, llvm::TargetTransformInfo::CastContextHint, llvm::TargetTransformInfo::TargetCostKind, llvm::Instruction const*) const (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xbd6cd8)\n#12 0x00000000050299fe llvm::TargetTransformInfo::getCastInstrCost(unsigned int, llvm::Type*, llvm::Type*, llvm::TargetTransformInfo::CastContextHint, llvm::TargetTransformInfo::TargetCostKind, llvm::Instruction const*) const (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x50299fe)\n#13 0x00000000037fb501 (anonymous namespace)::VectorCombine::foldInterleaveIntrinsics(llvm::Instruction&) VectorCombine.cpp:0:0\n#14 0x000000000380fbd8 (anonymous namespace)::VectorCombine::run()::'lambda'(llvm::Instruction&)::operator()(llvm::Instruction&) const (.isra.0) VectorCombine.cpp:0:0\n#15 0x0000000003811215 llvm::VectorCombinePass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x3811215)\n#16 0x0000000002faaebe llvm::detail::PassModel<llvm::Function, llvm::VectorCombinePass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x2faaebe)\n#17 0x0000000005763711 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5763711)\n#18 0x0000000000efdf2e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xefdf2e)\n#19 0x0000000005761d8a llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5761d8a)\n#20 0x000000000097972e llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97972e)\n#21 0x0000000005761741 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5761741)\n#22 0x00000000009838ca llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9838ca)\n#23 0x0000000000977b41 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x977b41)\n#24 0x000078099b029d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#25 0x000078099b029e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#26 0x000000000096ef55 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x96ef55)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "k-arrows",
    "labels": [
      "crash",
      "llvm::vectorcombine"
    ],
    "comments": [
      {
        "author": "k-arrows",
        "body": "Comes from llvm/test/CodeGen/AArch64/sve-vector-interleave.ll"
      },
      {
        "author": "ahmedshakill",
        "body": "Looking into it trying to understand if I can take up this task. Will let you know. "
      },
      {
        "author": "ahmedshakill",
        "body": "@k-arrows I looked into it. Could you please assign me this task. "
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}