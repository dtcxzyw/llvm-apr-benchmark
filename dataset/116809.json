{
  "bug_id": "116809",
  "issue_url": "https://github.com/llvm/llvm-project/issues/116809",
  "bug_type": "crash",
  "base_commit": "e80925b5eb4c824fe97a055d49faa586de16c2b9",
  "knowledge_cutoff": "2024-11-19T14:26:43Z",
  "lit_test_dir": [
    "llvm/test/Transforms/LICM"
  ],
  "hints": {
    "fix_commit": "5bd0474d1c45d58e472f25bf8292570ac78b5c15",
    "components": [
      "MemorySSAUpdater",
      "LICM"
    ],
    "bug_location_lineno": {
      "llvm/include/llvm/Analysis/MemorySSAUpdater.h": [
        [
          192,
          197
        ]
      ],
      "llvm/lib/Analysis/MemorySSAUpdater.cpp": [
        [
          1404,
          1411
        ]
      ],
      "llvm/lib/Transforms/Scalar/LICM.cpp": [
        [
          1464,
          1471
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Analysis/MemorySSAUpdater.cpp": [
        "MemorySSAUpdater::createMemoryAccessBefore",
        "MemorySSAUpdater::createMemoryAccessInBB"
      ],
      "llvm/lib/Transforms/Scalar/LICM.cpp": [
        "cloneInstructionInExitBlock"
      ]
    }
  },
  "patch": "commit 5bd0474d1c45d58e472f25bf8292570ac78b5c15\nAuthor: DianQK <dianqk@dianqk.net>\nDate:   Wed Nov 20 19:52:51 2024 +0800\n\n    [LICM] allow MemoryAccess creation failure (#116813)\n    \n    Fixes #116809.\n    \n    After running some passes (SimpleLoopUnswitch, LoopInstSimplify, etc.),\n    MemorySSA might be outdated, and the instruction `I` may have become a\n    non-memory touching instruction.\n    \n    LICM has already handled this, but it does not pass\n    `CreationMustSucceed=false` to `createDefinedAccess`.\n    \n    (cherry picked from commit 18b02bbf441660683df7f3925946984203d49bab)\n\ndiff --git a/llvm/include/llvm/Analysis/MemorySSAUpdater.h b/llvm/include/llvm/Analysis/MemorySSAUpdater.h\nindex d4da3ef1146d..f598dedea75f 100644\n--- a/llvm/include/llvm/Analysis/MemorySSAUpdater.h\n+++ b/llvm/include/llvm/Analysis/MemorySSAUpdater.h\n@@ -192,6 +192,11 @@ public:\n                                        const BasicBlock *BB,\n                                        MemorySSA::InsertionPlace Point);\n \n+  MemoryAccess *createMemoryAccessInBB(Instruction *I, MemoryAccess *Definition,\n+                                       const BasicBlock *BB,\n+                                       MemorySSA::InsertionPlace Point,\n+                                       bool CreationMustSucceed);\n+\n   /// Create a MemoryAccess in MemorySSA before an existing MemoryAccess.\n   ///\n   /// See createMemoryAccessInBB() for usage details.\ndiff --git a/llvm/lib/Analysis/MemorySSAUpdater.cpp b/llvm/lib/Analysis/MemorySSAUpdater.cpp\nindex aa550f0b6a7b..94061c949b7f 100644\n--- a/llvm/lib/Analysis/MemorySSAUpdater.cpp\n+++ b/llvm/lib/Analysis/MemorySSAUpdater.cpp\n@@ -1404,8 +1404,17 @@ void MemorySSAUpdater::changeToUnreachable(const Instruction *I) {\n MemoryAccess *MemorySSAUpdater::createMemoryAccessInBB(\n     Instruction *I, MemoryAccess *Definition, const BasicBlock *BB,\n     MemorySSA::InsertionPlace Point) {\n-  MemoryUseOrDef *NewAccess = MSSA->createDefinedAccess(I, Definition);\n-  MSSA->insertIntoListsForBlock(NewAccess, BB, Point);\n+  return createMemoryAccessInBB(I, Definition, BB, Point,\n+                                /*CreationMustSucceed=*/true);\n+}\n+\n+MemoryAccess *MemorySSAUpdater::createMemoryAccessInBB(\n+    Instruction *I, MemoryAccess *Definition, const BasicBlock *BB,\n+    MemorySSA::InsertionPlace Point, bool CreationMustSucceed) {\n+  MemoryUseOrDef *NewAccess = MSSA->createDefinedAccess(\n+      I, Definition, /*Template=*/nullptr, CreationMustSucceed);\n+  if (NewAccess)\n+    MSSA->insertIntoListsForBlock(NewAccess, BB, Point);\n   return NewAccess;\n }\n \ndiff --git a/llvm/lib/Transforms/Scalar/LICM.cpp b/llvm/lib/Transforms/Scalar/LICM.cpp\nindex 91ef2b4b7c18..ca03eff7a4e2 100644\n--- a/llvm/lib/Transforms/Scalar/LICM.cpp\n+++ b/llvm/lib/Transforms/Scalar/LICM.cpp\n@@ -1464,8 +1464,11 @@ static Instruction *cloneInstructionInExitBlock(\n \n   if (MSSAU.getMemorySSA()->getMemoryAccess(&I)) {\n     // Create a new MemoryAccess and let MemorySSA set its defining access.\n+    // After running some passes, MemorySSA might be outdated, and the\n+    // instruction `I` may have become a non-memory touching instruction.\n     MemoryAccess *NewMemAcc = MSSAU.createMemoryAccessInBB(\n-        New, nullptr, New->getParent(), MemorySSA::Beginning);\n+        New, nullptr, New->getParent(), MemorySSA::Beginning,\n+        /*CreationMustSucceed=*/false);\n     if (NewMemAcc) {\n       if (auto *MemDef = dyn_cast<MemoryDef>(NewMemAcc))\n         MSSAU.insertDef(MemDef, /*RenameUses=*/true);\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/LICM/PR116813-memoryssa-outdated.ll",
      "commands": [
        "opt -passes='loop-mssa(simple-loop-unswitch<nontrivial>,licm)' -verify-memoryssa -S < %s"
      ],
      "tests": [
        {
          "test_name": "foo",
          "test_body": "define i32 @foo(i1 %arg, ptr %arg1) {\nstart:\n  br label %loop\n\nloop:                                             ; preds = %loop, %start\n  %i = select i1 %arg, ptr %arg1, ptr @bar\n  %i3 = call i32 %i()\n  br i1 %arg, label %loop, label %ret\n\nret:                                              ; preds = %loop\n  ret i32 %i3\n}\n\n; Function Attrs: nounwind willreturn memory(none)\ndeclare i32 @bar() #0\n\nattributes #0 = { nounwind willreturn memory(none) }\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SimpleLoopUnswitch][LICM] Assertion `NewAccess != nullptr && \"Tried to create a memory access for a \" \"non-memory touching instruction\"'",
    "body": "The following IR triggers the assertion mentioned in the title:\r\n\r\n```llvm\r\n; opt -passes='loop-mssa(simple-loop-unswitch<nontrivial>,licm)'\r\ndefine i32 @foo(i1 %arg, ptr %arg1) {\r\nbb:\r\n  br label %bb2\r\n\r\nbb2:                                              ; preds = %bb2, %bb\r\n  %i = select i1 %arg, ptr %arg1, ptr @bar\r\n  %i3 = call i32 %i()\r\n  br i1 %arg, label %bb2, label %bb4\r\n\r\nbb4:                                              ; preds = %bb2\r\n  ret i32 %i3\r\n}\r\n\r\ndeclare i32 @bar() nounwind willreturn memory(none)\r\n```\r\n\r\nhttps://llvm.godbolt.org/z/bj79jxo8x",
    "author": "DianQK",
    "labels": [
      "crash",
      "llvm:analysis",
      "llvm:transforms"
    ],
    "comments": []
  }
}