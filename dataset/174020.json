{
  "bug_id": "174020",
  "issue_url": "https://github.com/llvm/llvm-project/issues/174020",
  "bug_type": "crash",
  "base_commit": "16ecf40aea105c3cf908b9653d6556e31bbc480a",
  "knowledge_cutoff": "2025-12-30T21:08:26Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "55e0b928b5f48678f742ea9a026774e41b484f13",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          14177,
          14182
        ],
        [
          18614,
          18619
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "adjustExtracts"
      ]
    }
  },
  "patch": "commit 55e0b928b5f48678f742ea9a026774e41b484f13\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Wed Dec 31 10:21:42 2025 -0800\n\n    [SLP]Consider deleted/gathered nodes, when deciding to erase extractelement\n    \n    If any user of the extractelement instruction is part of the node to be\n    deleted/gathered, such extractelements instructions should not be\n    considered for deletion.\n    \n    Fixes #174020\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 3d98d470387e..bbcdeea1654f 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -14177,6 +14177,11 @@ public:\n         ArrayRef<TreeEntry *> VEs = R.getTreeEntries(V);\n         if (!CheckedExtracts.insert(V).second ||\n             !R.areAllUsersVectorized(cast<Instruction>(V), &VectorizedVals) ||\n+            any_of(VEs,\n+                   [&](const TreeEntry *TE) {\n+                     return R.DeletedNodes.contains(TE) ||\n+                            R.TransformedToGatherNodes.contains(TE);\n+                   }) ||\n             (E->UserTreeIndex && E->UserTreeIndex.EdgeIdx == UINT_MAX &&\n              !R.isVectorized(EE) &&\n              count_if(E->Scalars, [&](Value *V) { return V == EE; }) !=\n@@ -18614,6 +18619,11 @@ public:\n           any_of(EI->users(), [&](User *U) {\n             ArrayRef<TreeEntry *> UTEs = R.getTreeEntries(U);\n             return UTEs.empty() || UTEs.size() > 1 ||\n+                   any_of(UTEs,\n+                          [&](const TreeEntry *TE) {\n+                            return R.DeletedNodes.contains(TE) ||\n+                                   R.TransformedToGatherNodes.contains(TE);\n+                          }) ||\n                    (isa<GetElementPtrInst>(U) &&\n                     !R.areAllUsersVectorized(cast<Instruction>(U))) ||\n                    (!UTEs.empty() &&\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/deleted-instructions-clear.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=x86_64-unknown-linux-gnu -mcpu=znver2 < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ndefine void @test(i32 %arg, i32 %arg1, i64 %arg2) {\n;\nbb:\n  br label %bb3\n\nbb3:\n  %phi = phi i64 [ 0, %bb3 ], [ 0, %bb ]\n  %phi4 = phi i64 [ %add39, %bb3 ], [ 0, %bb ]\n  %or = or i64 %phi, 0\n  %trunc = trunc i64 %or to i32\n  %or5 = or i64 %phi, 0\n  %mul = mul i64 %or, %or5\n  %or6 = or i64 0, 0\n  %or7 = or i64 0, 0\n  %mul8 = mul i64 %or6, %or7\n  %shl = shl i32 0, 1\n  %or9 = or i64 %phi, 0\n  %trunc10 = trunc i64 %or9 to i32\n  %or11 = or i32 %trunc10, 0\n  %or12 = or i64 %phi, 0\n  %mul13 = mul i64 %or9, %or12\n  %add = add i64 %mul, %mul8\n  %sext = sext i32 %shl to i64\n  %add14 = add i64 %add, %sext\n  %xor = xor i32 0, %trunc\n  %sext15 = sext i32 %xor to i64\n  %add16 = add i64 %add14, %sext15\n  %shl17 = shl i32 %shl, 0\n  %add18 = add i64 1, 0\n  %trunc19 = trunc i64 %add18 to i32\n  %mul20 = mul i64 0, 0\n  %add21 = add i64 %mul13, %add16\n  %sext22 = sext i32 %shl17 to i64\n  %add23 = add i64 %add21, %sext22\n  %xor24 = xor i32 %arg, %trunc10\n  %sext25 = sext i32 %xor24 to i64\n  %add26 = add i64 %add23, %sext25\n  %trunc27 = trunc i64 %arg2 to i32\n  %add28 = add i64 %mul20, %add26\n  %sext29 = sext i32 %shl to i64\n  %add30 = add i64 %add28, %sext29\n  %xor31 = xor i32 %arg1, %trunc19\n  %sext32 = sext i32 %xor31 to i64\n  %add33 = add i64 %add30, %sext32\n  %shl34 = shl i32 %arg1, 0\n  %sext35 = sext i32 %shl34 to i64\n  %add36 = add i64 %add33, %sext35\n  %xor37 = xor i32 %arg, %trunc27\n  %sext38 = sext i32 %xor37 to i64\n  %add39 = add i64 %add36, %sext38\n  br i1 false, label %bb40, label %bb3\n\nbb40:\n  %phi41 = phi i64 [ %add39, %bb3 ]\n  ret void\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "Assertion `I->use_empty() && \"trying to erase instruction with users.\"' failed.",
    "body": "To reproduce run opt with the test below (-passes=slp-vectorizer):\n```\n; ModuleID = './reduced.ll'\nsource_filename = \"./reduced.ll\"\ntarget datalayout = \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128-ni:1-p2:32:8:8:32-ni:2\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\ndefine void @wombat(i32 %arg, i32 %arg1, i64 %arg2) #0 gc \"statepoint-example\" {\nbb:\n  br label %bb3\n\nbb3:                                              ; preds = %bb3, %bb\n  %phi = phi i64 [ 0, %bb3 ], [ 0, %bb ]\n  %phi4 = phi i64 [ %add39, %bb3 ], [ 0, %bb ]\n  %or = or i64 %phi, 0\n  %trunc = trunc i64 %or to i32\n  %or5 = or i64 %phi, 0\n  %mul = mul i64 %or, %or5\n  %or6 = or i64 0, 0\n  %or7 = or i64 0, 0\n  %mul8 = mul i64 %or6, %or7\n  %shl = shl i32 0, 1\n  %or9 = or i64 %phi, 0\n  %trunc10 = trunc i64 %or9 to i32\n  %or11 = or i32 %trunc10, 0\n  %or12 = or i64 %phi, 0\n  %mul13 = mul i64 %or9, %or12\n  %add = add i64 %mul, %mul8\n  %sext = sext i32 %shl to i64\n  %add14 = add i64 %add, %sext\n  %xor = xor i32 0, %trunc\n  %sext15 = sext i32 %xor to i64\n  %add16 = add i64 %add14, %sext15\n  %shl17 = shl i32 %shl, 0\n  %add18 = add i64 1, 0\n  %trunc19 = trunc i64 %add18 to i32\n  %mul20 = mul i64 0, 0\n  %add21 = add i64 %mul13, %add16\n  %sext22 = sext i32 %shl17 to i64\n  %add23 = add i64 %add21, %sext22\n  %xor24 = xor i32 %arg, %trunc10\n  %sext25 = sext i32 %xor24 to i64\n  %add26 = add i64 %add23, %sext25\n  %trunc27 = trunc i64 %arg2 to i32\n  %add28 = add i64 %mul20, %add26\n  %sext29 = sext i32 %shl to i64\n  %add30 = add i64 %add28, %sext29\n  %xor31 = xor i32 %arg1, %trunc19\n  %sext32 = sext i32 %xor31 to i64\n  %add33 = add i64 %add30, %sext32\n %shl34 = shl i32 %arg1, 0\n  %sext35 = sext i32 %shl34 to i64\n  %add36 = add i64 %add33, %sext35\n  %xor37 = xor i32 %arg, %trunc27\n  %sext38 = sext i32 %xor37 to i64\n  %add39 = add i64 %add36, %sext38\n  br i1 false, label %bb40, label %bb3\n\nbb40:                                             ; preds = %bb3\n  %phi41 = phi i64 [ %add39, %bb3 ]\n  ret void\n}\n\nattributes #0 = { \"target-cpu\"=\"znver2\" }\n```\nReproducer: https://godbolt.org/z/fWzdn43sd\n\n\nStack dump:\n```\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=slp-vectorizer <source>\n1.\tRunning pass \"function(slp-vectorizer)\" on module \"<source>\"\n2.\tRunning pass \"slp-vectorizer\" on function \"wombat\"\n #0 0x0000000005a65f78 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5a65f78)\n #1 0x0000000005a62e24 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x0000753390242520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x00007533902969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x0000753390242476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x00007533902287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x000075339022871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x0000753390239e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x000000000378f07f llvm::slpvectorizer::BoUpSLP::~BoUpSLP() (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x378f07f)\n #9 0x00000000038861d6 llvm::SLPVectorizerPass::runImpl(llvm::Function&, llvm::ScalarEvolution*, llvm::TargetTransformInfo*, llvm::TargetLibraryInfo*, llvm::AAResults*, llvm::LoopInfo*, llvm::DominatorTree*, llvm::AssumptionCache*, llvm::DemandedBits*, llvm::OptimizationRemarkEmitter*) (.part.0) SLPVectorizer.cpp:0:0\n#10 0x0000000003886c5b llvm::SLPVectorizerPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x3886c5b)\n#11 0x0000000003036a7e llvm::detail::PassModel<llvm::Function, llvm::SLPVectorizerPass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x3036a7e)\n#12 0x0000000005841e31 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5841e31)\n#13 0x0000000000f19f8e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xf19f8e)\n#14 0x00000000058403ea llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x58403ea)\n#15 0x000000000097dfce llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97dfce)\n#16 0x000000000583fda1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x583fda1)\n#17 0x0000000000988280 llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x988280)\n#18 0x000000000097c178 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97c178)\n#19 0x0000753390229d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#20 0x0000753390229e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#21 0x0000000000972c15 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x972c15)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "TatyanaDoubts",
    "labels": [
      "llvm:SLPVectorizer",
      "crash"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}