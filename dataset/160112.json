{
  "bug_id": "160112",
  "issue_url": "https://github.com/llvm/llvm-project/issues/160112",
  "bug_type": "miscompilation",
  "base_commit": "e930644394735c9349bab73a8c33f0d215cd35f4",
  "knowledge_cutoff": "2025-09-22T13:52:13Z",
  "lit_test_dir": [
    "llvm/test/tools/llvm-lib"
  ],
  "hints": {
    "fix_commit": "48a6f2f85c8269d8326c185016801a4eb8d5dfd6",
    "components": [],
    "bug_location_lineno": {
      "llvm/lib/Object/ArchiveWriter.cpp": [
        [
          1119,
          1128
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Object/ArchiveWriter.cpp": [
        "writeArchiveToStream"
      ]
    }
  },
  "patch": "commit 48a6f2f85c8269d8326c185016801a4eb8d5dfd6\nAuthor: Jacek Caban <jacek@codeweavers.com>\nDate:   Sun Sep 28 20:17:01 2025 +0200\n\n    [Object][Archive] Recompute headers and symbol map when switching from COFF to GNU64 (#160606)\n    \n    COFF format has no 64-bit version, so we use GNU64 instead. Since this\n    changes the headers, we need to recalculate everything.\n    \n    Fixes #160112.\n\ndiff --git a/llvm/lib/Object/ArchiveWriter.cpp b/llvm/lib/Object/ArchiveWriter.cpp\nindex 6fc0889afc6a..a11259748b9c 100644\n--- a/llvm/lib/Object/ArchiveWriter.cpp\n+++ b/llvm/lib/Object/ArchiveWriter.cpp\n@@ -1119,10 +1119,26 @@ Error writeArchiveToStream(raw_ostream &Out,\n     // to switch to 64-bit. Note that the file can be larger than 4GB as long as\n     // the last member starts before the 4GB offset.\n     if (*HeadersSize + LastMemberHeaderOffset >= Sym64Threshold) {\n-      if (Kind == object::Archive::K_DARWIN)\n+      switch (Kind) {\n+      case object::Archive::K_COFF:\n+        // COFF format has no 64-bit version, so we use GNU64 instead.\n+        if (!SymMap.Map.empty() && !SymMap.ECMap.empty())\n+          // Only the COFF format supports the ECSYMBOLS section, so don\u2019t use\n+          // GNU64 when two symbol maps are required.\n+          return make_error<object::GenericBinaryError>(\n+              \"Archive is too large: ARM64X does not support archives larger \"\n+              \"than 4GB\");\n+        // Since this changes the headers, we need to recalculate everything.\n+        return writeArchiveToStream(Out, NewMembers, WriteSymtab,\n+                                    object::Archive::K_GNU64, Deterministic,\n+                                    Thin, IsEC, Warn);\n+      case object::Archive::K_DARWIN:\n         Kind = object::Archive::K_DARWIN64;\n-      else\n+        break;\n+      default:\n         Kind = object::Archive::K_GNU64;\n+        break;\n+      }\n       HeadersSize.reset();\n     }\n   }\n",
  "tests": [],
  "issue": {
    "title": "Regression(https://reviews.llvm.org/D143540): llvm-lib writes broken .lib files when output is > 4 GiB",
    "body": "Reduced repro (file names > 15 characters so that the string table is used):\n\n```\n% cat foo34567890123456789.cc \nvoid foo() {}\n```\n\n```\n% cat bar34567890123456789.cc \nvoid bar() {}\n```\n\nCompile them and make a .lib, using `SYM64_THRESHOLD` to force switch to 64-bit mode without needing many large obj files:\n\n```\n% out/gn/bin/clang-cl /c foo34567890123456789.cc                                                                                 \n% out/gn/bin/clang-cl /c bar34567890123456789.cc                                                             \n% SYM64_THRESHOLD=800 out/gn/bin/lld-link /lib /out:foo.lib foo34567890123456789.obj bar34567890123456789.obj\n```\n\nUse it:\n\n```\n% cat main.cc   \nvoid foo();\nvoid bar();\nint main() {\n  foo();\n  bar();\n}\n\n% out/gn/bin/clang-cl /c main.cc\n\n% out/gn/bin/lld-link /winsysroot:$HOME/src/chrome/src/third_party/depot_tools/win_toolchain/vs_files/e4305f407e main.obj foo.lib\nlld-link: error: could not get child name for archive foo.lib while loading symbol void __cdecl foo(void): truncated or malformed archive (string table at long name offset 25 not terminated)\n```\n\nThe problem is that `writeArchiveToStream` in llvm/lib/Object/ArchiveWriter.cpp dynamically switches `Kind` to `object::Archive::K_GNU64` if the output becomes large enough to require 64-bit offsets, but after https://reviews.llvm.org/D143540 / 4fcbf384200756, several places in ArchiveWriter.cpp check `Kind` and make binding decisions based on it before `Kind` may change.\n\nOptions:\n\n1. Short-term, revert the change to LibDriver.cpp to always use `K_GNU` to unbreak things\n2. In ArchiveWriter, maybe do a first pass to figure out the final Kind, and then don't change `Kind` while writing in a second, actually-writing pass\n\n@cjacek ",
    "author": "nico",
    "labels": [
      "miscompilation",
      "llvm",
      "regression:17"
    ],
    "comments": [
      {
        "author": "nico",
        "body": "(downstream: https://crbug.com/445194079)"
      },
      {
        "author": "nico",
        "body": "I also wonder what lib.exe does when you hand it obj files that need more than 4 GiB total. Does it error out? Something else?"
      },
      {
        "author": "nico",
        "body": "Another idea, if that matches lib.exe's behavior: make ArchiveWriter.cpp error out instead of changing to GNU64 when writing coff archives, and give LibWriter a flag to force GNU output."
      },
      {
        "author": "cjacek",
        "body": "Thanks! I guess we could try harder to make the output work with something like: https://github.com/cjacek/llvm-project/commit/309934a8ab3a25ce18b53e27e69580ddcf01a2b2. This fixes the repro for me.\n\nAs far as I remember, lib.exe errors out on overly large archives. I'm not sure whether we should replicate that, large archives seem possible to support (at least in non-EC cases), although less efficiently than for other types.\n\nllvm-ar already has a `--format` argument. I'm not sure how practical that is to use, but I guess we could add it to llvm-lib as well if that would help."
      },
      {
        "author": "nico",
        "body": "Thanks!\n\nAbstractly, having an `lld-link /lib` flag that controls if it errors out on large outputs, transparently switches to GNU64 when needed, or just always writes GNU seems useful.\n\nBut concretely, nobody really asked for it, so maybe we can YAGNI it for now and just go with your patch \u2013\u00a0it's better than the current behavior (which is writing corrupt files). And if someone needs more flexibility in the future, we can add that then.\n\n(But if you'd rather do something else, that's fine with me too!)"
      },
      {
        "author": "nico",
        "body": "@cjacek Were your planning on uploading your commit, or would you prefer if I do it?"
      },
      {
        "author": "cjacek",
        "body": "I agree, I think we can go ahead with the patch now and see if there\u2019s demand for an explicit option. I\u2019ve created #160606.\n\n(I\u2019m traveling this week, so I may be less responsive than usual.)"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  }
}