{
  "bug_id": "173355",
  "issue_url": "https://github.com/llvm/llvm-project/issues/173355",
  "bug_type": "crash",
  "base_commit": "2eb8ee137f28e46a1711a28b6575083dafba7c8e",
  "knowledge_cutoff": "2025-12-23T11:06:49Z",
  "lit_test_dir": [
    "llvm/test/Transforms/MergeFunc"
  ],
  "hints": {
    "fix_commit": "4d66cccffe179d0d2bbec833ace041349cf872a4",
    "components": [
      "MergeFunctions"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/IPO/MergeFunctions.cpp": [
        [
          697,
          702
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/IPO/MergeFunctions.cpp": [
        "canCreateThunkFor"
      ]
    }
  },
  "patch": "commit 4d66cccffe179d0d2bbec833ace041349cf872a4\nAuthor: Sebastian Neubauer <flakebi@t-online.de>\nDate:   Sun Jan 4 13:35:16 2026 +0100\n\n    [MergeFunc] Do not merge kernel functions (#174254)\n    \n    Kernels cannot be called, so we cannot introduce calls to them in\n    MergeFunctions.\n    \n    The test uses a `--implicit-check-not=call` to make sure that only the\n    function with C calling convention gets merged.\n    \n    Fixes #39579. Fixes #173355.\n\ndiff --git a/llvm/lib/Transforms/IPO/MergeFunctions.cpp b/llvm/lib/Transforms/IPO/MergeFunctions.cpp\nindex 0faa36a495ac..fcf3f7c89c71 100644\n--- a/llvm/lib/Transforms/IPO/MergeFunctions.cpp\n+++ b/llvm/lib/Transforms/IPO/MergeFunctions.cpp\n@@ -697,6 +697,9 @@ static bool canCreateThunkFor(Function *F) {\n   if (F->isVarArg())\n     return false;\n \n+  if (F->hasKernelCallingConv())\n+    return false;\n+\n   // Don't merge tiny functions using a thunk, since it can just end up\n   // making the function larger.\n   if (F->size() == 1) {\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/MergeFunc/merge-calling-conv.ll",
      "commands": [
        "opt -S -passes=mergefunc < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\n; Check that no calls are generated for certain calling conventions\n\n@debug = global i32 0\n\n\ndefine void @normal(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 0\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine void @as_normal(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 0\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine amdgpu_kernel void @amdgpu_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 1\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine amdgpu_kernel void @as_amdgpu_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 1\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine ptx_kernel void @ptx_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 2\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine ptx_kernel void @as_ptx_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 2\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine spir_kernel void @spir_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 3\n  store i32 %b, ptr @debug\n  ret void\n}\n\ndefine spir_kernel void @as_spir_kernel(i32 %a) unnamed_addr {\n  %b = xor i32 %a, 3\n  store i32 %b, ptr @debug\n  ret void\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "[MergeFunc] Creates calls for calling convention that does not allow calls",
    "body": "When running opt on the following IR, opt crashes. \nI am not sure whether this is a valid case. If using opt in this way is not appropriate, I am open to closing this issue.\ngodbolt: https://godbolt.org/z/873edWGzK\n\nllvm version 50ae726bb3498\n\ntest.ll\n\n```\ndefine amdgpu_kernel void @hamming_search_inner_loop1() {\nentry:\n  br label %end\n\nend:                                              ; preds = %entry\n  ret void\n}\n\ndefine amdgpu_kernel void @hamming_search_inner_loop2() {\nentry:\n  br label %end\n\nend:                                              ; preds = %entry\n  ret void\n}\n\n```\n\n\ncommads\n./bin/opt test.ll -passes=mergefunc -S\n\nstacktrace\n\n```\ncalling convention does not permit calls\n  tail call amdgpu_kernel void @hamming_search_inner_loop1()\nLLVM ERROR: Broken module found, compilation aborted!\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=mergefunc -S <source>\n1.\tRunning pass \"verify\" on module \"<source>\"\n #0 0x0000000005a44d98 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5a44d98)\n #1 0x0000000005a41c44 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x00007bd9c3c42520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x00007bd9c3c969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x00007bd9c3c42476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x00007bd9c3c287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x00000000008339a1 llvm::json::operator==(llvm::json::Value const&, llvm::json::Value const&) (.cold) JSON.cpp:0:0\n #7 0x0000000005979301 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5979301)\n #8 0x0000000005862a88 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x5862a88)\n #9 0x000000000097d40e llvm::detail::PassModel<llvm::Module, llvm::VerifierPass, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97d40e)\n#10 0x000000000581f0b1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x581f0b1)\n#11 0x000000000098776a llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x98776a)\n#12 0x000000000097b5e8 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97b5e8)\n#13 0x00007bd9c3c29d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#14 0x00007bd9c3c29e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#15 0x0000000000972085 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x972085)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```\n",
    "author": "Emilyaxe",
    "labels": [
      "ipo",
      "crash"
    ],
    "comments": [
      {
        "author": "nikic",
        "body": "This is basically the same as https://github.com/llvm/llvm-project/issues/39579, though this one produces a verifier error."
      },
      {
        "author": "Flakebi",
        "body": "I opened a PR to fix both of these issues: #174254"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}