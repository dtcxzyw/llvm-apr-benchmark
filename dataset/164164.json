{
  "bug_id": "164164",
  "issue_url": "https://github.com/llvm/llvm-project/issues/164164",
  "bug_type": "crash",
  "base_commit": "b9ce7656e93a8cd54b2e9f44d8bae49c55a76a4b",
  "knowledge_cutoff": "2025-10-19T14:11:35Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "e6b0be376412bf0599f6e75aa5e67f95cd36b411",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          5343,
          5349
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "areAllOperandsReplacedByCopyableData"
      ]
    }
  },
  "patch": "commit e6b0be376412bf0599f6e75aa5e67f95cd36b411\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Sun Oct 19 11:29:14 2025 -0700\n\n    [SLP]Correctly calculate number of copyable operands\n    \n    The compiler shall not check for overflow of the number of copyable\n    operands counter, otherwise non-copyable operand can be counted as\n    copyable and lead to a compiler crash.\n    \n    Fixes #164164\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 9cd52da1ce1c..048a3e691fe5 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -5343,7 +5343,7 @@ private:\n             unsigned &OpCnt =\n                 OrderedEntriesCount.try_emplace(TE, 0).first->getSecond();\n             EdgeInfo EI(TE, U.getOperandNo());\n-            if (!getScheduleCopyableData(EI, Op) && OpCnt < NumOps)\n+            if (!getScheduleCopyableData(EI, Op))\n               continue;\n             // Found copyable operand - continue.\n             ++OpCnt;\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/num-uses-for-copyable-elements.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=x86_64-apple-macosx15.0.0  -mcpu=skylake-avx512 -S < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ndefine void @test(ptr %output) {\n;\nentry:\n  %arrayidx.2.i = getelementptr i8, ptr %output, i64 8\n  %0 = load i32, ptr %output, align 4\n  %arrayidx.3.i = getelementptr i8, ptr %output, i64 12\n  %1 = load i32, ptr %arrayidx.3.i, align 4\n  %xor7 = xor i32 -1, %0\n  %or.i = tail call i32 @llvm.fshl.i32(i32 %xor7, i32 0, i32 2)\n  %or.i11 = tail call i32 @llvm.fshl.i32(i32 %1, i32 %1, i32 2)\n  store i32 %or.i, ptr %arrayidx.2.i, align 4\n  store i32 %or.i11, ptr %arrayidx.3.i, align 4\n  ret void\n}\n\ndeclare i32 @llvm.fshl.i32(i32, i32, i32)"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SLP] Assertion `all_of(Bundles, [](const ScheduleBundle *Bundle) { return Bundle->isScheduled(); }) && \"must be scheduled at this point\"' failed.",
    "body": "The following input triggers an assertion with `-p slp-vectorizer` on current `main`:\nhttps://llvm.godbolt.org/z/xsTTooc64\n\n```\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-apple-macosx15.0.0\"\n\ndefine void @crash(ptr %output) #0 {\nentry:\n  %arrayidx.2.i = getelementptr i8, ptr %output, i64 8\n  %0 = load i32, ptr %output, align 4\n  %arrayidx.3.i = getelementptr i8, ptr %output, i64 12\n  %1 = load i32, ptr %arrayidx.3.i, align 4\n  %xor7 = xor i32 -1, %0\n  %or.i = tail call i32 @llvm.fshl.i32(i32 %xor7, i32 0, i32 2)\n  %or.i11 = tail call i32 @llvm.fshl.i32(i32 %1, i32 %1, i32 2)\n  store i32 %or.i, ptr %arrayidx.2.i, align 4\n  store i32 %or.i11, ptr %arrayidx.3.i, align 4\n  ret void\n}\n\ndeclare i32 @llvm.fshl.i32(i32, i32, i32) #1\n\nattributes #0 = { \"target-cpu\"=\"skylake-avx512\" }\n``",
    "author": "fhahn",
    "labels": [
      "llvm:SLPVectorizer",
      "crash-on-valid"
    ],
    "comments": [
      {
        "author": "fhahn",
        "body": "cc @alexey-bataev "
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}