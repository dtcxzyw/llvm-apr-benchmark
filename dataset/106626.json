{
  "bug_id": "106626",
  "issue_url": "https://github.com/llvm/llvm-project/issues/106626",
  "bug_type": "crash",
  "base_commit": "e51fc36c385d756ccbc2be8c47c52af207c3aead",
  "knowledge_cutoff": "2024-08-29T20:51:42Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "cc943a67d114e28c28f561c3b1a48ff2003264ce",
    "components": [
      "SLPVectorizer"
    ],
    "files": [
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          3237,
          3251
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "size",
        "getVectorFactor",
        "findLaneForValue",
        "empty"
      ]
    }
  },
  "patch": "commit cc943a67d114e28c28f561c3b1a48ff2003264ce\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Thu Aug 29 15:05:09 2024 -0700\n\n    [SLP]Fix PR106626: trye several attempts for lookup values, if not found.\n    \n    If the value is used in Scalar several times, the first attempt to find\n    its position in the node (if ReuseShuffleIndices and ReorderIndices not\n    empty) may fail. In this case need to find another copy of the same\n    value and try again.\n    Fixes https://github.com/llvm/llvm-project/issues/106626\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 775fa9ba75cf..edb2567fa057 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -3237,15 +3237,25 @@ private:\n     /// When ReuseReorderShuffleIndices is empty it just returns position of \\p\n     /// V within vector of Scalars. Otherwise, try to remap on its reuse index.\n     int findLaneForValue(Value *V) const {\n-      unsigned FoundLane = std::distance(Scalars.begin(), find(Scalars, V));\n-      assert(FoundLane < Scalars.size() && \"Couldn't find extract lane\");\n-      if (!ReorderIndices.empty())\n-        FoundLane = ReorderIndices[FoundLane];\n-      assert(FoundLane < Scalars.size() && \"Couldn't find extract lane\");\n-      if (!ReuseShuffleIndices.empty()) {\n-        FoundLane = std::distance(ReuseShuffleIndices.begin(),\n-                                  find(ReuseShuffleIndices, FoundLane));\n+      unsigned FoundLane = getVectorFactor();\n+      for (auto *It = find(Scalars, V), *End = Scalars.end(); It != End;\n+           std::advance(It, 1)) {\n+        if (*It != V)\n+          continue;\n+        FoundLane = std::distance(Scalars.begin(), It);\n+        assert(FoundLane < Scalars.size() && \"Couldn't find extract lane\");\n+        if (!ReorderIndices.empty())\n+          FoundLane = ReorderIndices[FoundLane];\n+        assert(FoundLane < Scalars.size() && \"Couldn't find extract lane\");\n+        if (ReuseShuffleIndices.empty())\n+          break;\n+        if (auto *RIt = find(ReuseShuffleIndices, FoundLane);\n+            RIt != ReuseShuffleIndices.end()) {\n+          FoundLane = std::distance(ReuseShuffleIndices.begin(), RIt);\n+          break;\n+        }\n       }\n+      assert(FoundLane < getVectorFactor() && \"Unable to find given value.\");\n       return FoundLane;\n     }\n \n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/AArch64/reused-scalar-repeated-in-node.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=aarch64-unknown-linux-gnu < %s"
      ],
      "tests": [
        {
          "test_name": "test",
          "test_body": "define void @test() {\nentry:\n  br label %bb61\n\nbb61:                                             ; preds = %entry\n  br label %bb64\n\nbb62:                                             ; No predecessors!\n  br i1 poison, label %bb63, label %bb64\n\nbb63:                                             ; preds = %bb62\n  br label %bb64\n\nbb64:                                             ; preds = %bb63, %bb62, %bb61\n  %i = phi nsz float [ poison, %bb61 ], [ poison, %bb63 ], [ poison, %bb62 ]\n  %i65 = phi nsz float [ poison, %bb61 ], [ poison, %bb63 ], [ poison, %bb62 ]\n  %i66 = load float, ptr poison, align 16\n  %i67 = load float, ptr poison, align 4\n  %i68 = load float, ptr poison, align 8\n  %i69 = load float, ptr poison, align 4\n  %i70 = load float, ptr poison, align 4\n  %i71 = load float, ptr poison, align 16\n  %i72 = load float, ptr poison, align 4\n  %i73 = load float, ptr poison, align 8\n  %i74 = load float, ptr poison, align 4\n  %i75 = load float, ptr poison, align 16\n  %i76 = load float, ptr poison, align 4\n  br i1 poison, label %bb167, label %bb77\n\nbb77:                                             ; preds = %bb64\n  br label %bb78\n\nbb78:                                             ; preds = %bb78, %bb77\n  %i79 = phi nsz float [ %i66, %bb77 ], [ %i103, %bb78 ]\n  %i80 = phi nsz float [ %i67, %bb77 ], [ %i104, %bb78 ]\n  %i81 = phi nsz float [ %i68, %bb77 ], [ %i105, %bb78 ]\n  %i82 = phi nsz float [ poison, %bb77 ], [ %i106, %bb78 ]\n  %i83 = phi nsz float [ poison, %bb77 ], [ %i123, %bb78 ]\n  %i84 = phi nsz float [ %i69, %bb77 ], [ %i124, %bb78 ]\n  %i85 = phi nsz float [ poison, %bb77 ], [ %i125, %bb78 ]\n  %i86 = phi nsz float [ %i70, %bb77 ], [ %i126, %bb78 ]\n  %i87 = fmul fast float %i79, poison\n  %i88 = fmul fast float %i80, poison\n  %i89 = fmul fast float %i81, poison\n  %i90 = fmul fast float %i82, poison\n  %i91 = fmul fast float %i83, poison\n  %i92 = fadd fast float %i91, %i87\n  %i93 = fmul fast float %i84, poison\n  %i94 = fadd fast float %i93, %i88\n  %i95 = fmul fast float %i85, poison\n  %i96 = fadd fast float %i95, %i89\n  %i97 = fmul fast float %i86, poison\n  %i98 = fadd fast float %i97, %i90\n  %i99 = fadd fast float %i92, poison\n  %i100 = fadd fast float %i94, poison\n  %i101 = fadd fast float %i96, poison\n  %i102 = fadd fast float %i98, poison\n  %i103 = fadd fast float %i99, poison\n  %i104 = fadd fast float %i100, poison\n  %i105 = fadd fast float %i101, poison\n  %i106 = fadd fast float %i102, poison\n  %i107 = fmul fast float %i79, poison\n  %i108 = fmul fast float %i80, poison\n  %i109 = fmul fast float %i81, poison\n  %i110 = fmul fast float %i82, poison\n  %i111 = fmul fast float %i83, poison\n  %i112 = fadd fast float %i111, %i107\n  %i113 = fmul fast float %i84, poison\n  %i114 = fadd fast float %i113, %i108\n  %i115 = fmul fast float %i85, poison\n  %i116 = fadd fast float %i115, %i109\n  %i117 = fmul fast float %i86, poison\n  %i118 = fadd fast float %i117, %i110\n  %i119 = fadd fast float %i112, poison\n  %i120 = fadd fast float %i114, poison\n  %i121 = fadd fast float %i116, poison\n  %i122 = fadd fast float %i118, poison\n  %i123 = fadd fast float %i119, poison\n  %i124 = fadd fast float %i120, poison\n  %i125 = fadd fast float %i121, poison\n  %i126 = fadd fast float %i122, poison\n  %i127 = fmul fast float %i79, %i\n  %i128 = fmul fast float %i80, %i\n  %i129 = fmul fast float %i81, %i\n  %i130 = fmul fast float %i82, %i\n  %i131 = fmul fast float %i83, %i65\n  %i132 = fadd fast float %i131, %i127\n  %i133 = fmul fast float %i84, %i65\n  %i134 = fadd fast float %i133, %i128\n  %i135 = fmul fast float %i85, %i65\n  %i136 = fadd fast float %i135, %i129\n  %i137 = fmul fast float %i86, %i65\n  %i138 = fadd fast float %i137, %i130\n  %i139 = fadd fast float %i132, poison\n  %i140 = fadd fast float %i134, poison\n  %i141 = fadd fast float %i136, poison\n  %i142 = fadd fast float %i138, poison\n  %i143 = fadd fast float %i139, poison\n  %i144 = fadd fast float %i140, poison\n  %i145 = fadd fast float %i141, poison\n  %i146 = fadd fast float %i142, poison\n  %i147 = fmul fast float %i79, poison\n  %i148 = fmul fast float %i80, poison\n  %i149 = fmul fast float %i81, poison\n  %i150 = fmul fast float %i82, poison\n  %i151 = fmul fast float %i83, poison\n  %i152 = fadd fast float %i151, %i147\n  %i153 = fmul fast float %i84, poison\n  %i154 = fadd fast float %i153, %i148\n  %i155 = fmul fast float %i85, poison\n  %i156 = fadd fast float %i155, %i149\n  %i157 = fmul fast float %i86, poison\n  %i158 = fadd fast float %i157, %i150\n  %i159 = fadd fast float %i152, poison\n  %i160 = fadd fast float %i154, poison\n  %i161 = fadd fast float %i156, poison\n  %i162 = fadd fast float %i158, poison\n  %i163 = fadd fast float %i159, poison\n  %i164 = fadd fast float %i160, poison\n  %i165 = fadd fast float %i161, poison\n  %i166 = fadd fast float %i162, poison\n  br i1 poison, label %bb78, label %bb167\n\nbb167:                                            ; preds = %bb78, %bb64\n  %i168 = phi nsz float [ %i76, %bb64 ], [ %i166, %bb78 ]\n  %i169 = phi nsz float [ poison, %bb64 ], [ %i165, %bb78 ]\n  %i170 = phi nsz float [ poison, %bb64 ], [ %i164, %bb78 ]\n  %i171 = phi nsz float [ %i75, %bb64 ], [ %i163, %bb78 ]\n  %i172 = phi nsz float [ %i74, %bb64 ], [ %i146, %bb78 ]\n  %i173 = phi nsz float [ %i73, %bb64 ], [ %i145, %bb78 ]\n  %i174 = phi nsz float [ %i72, %bb64 ], [ %i144, %bb78 ]\n  %i175 = phi nsz float [ %i71, %bb64 ], [ %i143, %bb78 ]\n  %i176 = phi nsz float [ %i70, %bb64 ], [ %i126, %bb78 ]\n  %i177 = phi nsz float [ poison, %bb64 ], [ %i125, %bb78 ]\n  %i178 = phi nsz float [ %i69, %bb64 ], [ %i124, %bb78 ]\n  %i179 = phi nsz float [ poison, %bb64 ], [ %i123, %bb78 ]\n  %i180 = phi nsz float [ poison, %bb64 ], [ %i106, %bb78 ]\n  %i181 = phi nsz float [ %i68, %bb64 ], [ %i105, %bb78 ]\n  %i182 = phi nsz float [ %i67, %bb64 ], [ %i104, %bb78 ]\n  %i183 = phi nsz float [ %i66, %bb64 ], [ %i103, %bb78 ]\n  store float %i182, ptr poison, align 1\n  store float %i174, ptr poison, align 1\n  br i1 poison, label %bb186, label %bb184\n\nbb184:                                            ; preds = %bb167\n  br label %bb185\n\nbb185:                                            ; preds = %bb185, %bb184\n  br i1 poison, label %bb185, label %bb186\n\nbb186:                                            ; preds = %bb185, %bb167\n  %i187 = phi nsz float [ %i178, %bb167 ], [ poison, %bb185 ]\n  ret void\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SLP] Assertion \"All elements in mask must be less than CommonVF.\" failed",
    "body": "[PR77529](https://github.com/llvm/llvm-project/pull/77529) trigger assertion on \"All elements in mask must be less than CommonVF.\" failed.\r\n\r\n@alexey-bataev \r\n\r\nTo reproduce, run with: opt -S -passes=slp-vectorizer t.ll -o o.ll\r\nUsing reduced t.ll below\r\n```\r\ntarget datalayout = \"e-m:e-i8:8:32-i16:16:32-i64:64-i128:128-n32:64-S128-Fn32\"\r\ntarget triple = \"aarch64-unknown-linux-gnu\"\r\n\r\ndefine void @test() {\r\nentry:\r\n  br label %bb61\r\n\r\nbb61:\r\n  br label %bb64\r\n\r\nbb62:\r\n  br i1 poison, label %bb63, label %bb64\r\n\r\nbb63:\r\n  br label %bb64\r\n\r\nbb64:\r\n  %i = phi nsz float [ poison, %bb61 ], [ poison, %bb63 ], [ poison, %bb62 ]\r\n  %i65 = phi nsz float [ poison, %bb61 ], [ poison, %bb63 ], [ poison, %bb62 ]\r\n  %i66 = load float, ptr poison, align 16\r\n  %i67 = load float, ptr poison, align 4\r\n  %i68 = load float, ptr poison, align 8\r\n  %i69 = load float, ptr poison, align 4\r\n  %i70 = load float, ptr poison, align 4\r\n  %i71 = load float, ptr poison, align 16\r\n  %i72 = load float, ptr poison, align 4\r\n  %i73 = load float, ptr poison, align 8\r\n  %i74 = load float, ptr poison, align 4\r\n  %i75 = load float, ptr poison, align 16\r\n  %i76 = load float, ptr poison, align 4\r\n  br i1 poison, label %bb167, label %bb77\r\n\r\nbb77:                                             ; preds = %bb64\r\n  br label %bb78\r\n\r\nbb78:                                             ; preds = %bb78, %bb77\r\n  %i79 = phi nsz float [ %i66, %bb77 ], [ %i103, %bb78 ]\r\n  %i80 = phi nsz float [ %i67, %bb77 ], [ %i104, %bb78 ]\r\n  %i81 = phi nsz float [ %i68, %bb77 ], [ %i105, %bb78 ]\r\n  %i82 = phi nsz float [ poison, %bb77 ], [ %i106, %bb78 ]\r\n  %i83 = phi nsz float [ poison, %bb77 ], [ %i123, %bb78 ]\r\n  %i84 = phi nsz float [ %i69, %bb77 ], [ %i124, %bb78 ]\r\n  %i85 = phi nsz float [ poison, %bb77 ], [ %i125, %bb78 ]\r\n  %i86 = phi nsz float [ %i70, %bb77 ], [ %i126, %bb78 ]\r\n  %i87 = fmul fast float %i79, poison\r\n  %i88 = fmul fast float %i80, poison\r\n  %i89 = fmul fast float %i81, poison\r\n  %i90 = fmul fast float %i82, poison\r\n  %i91 = fmul fast float %i83, poison\r\n  %i92 = fadd fast float %i91, %i87\r\n  %i93 = fmul fast float %i84, poison\r\n  %i94 = fadd fast float %i93, %i88\r\n  %i95 = fmul fast float %i85, poison\r\n  %i96 = fadd fast float %i95, %i89\r\n  %i97 = fmul fast float %i86, poison\r\n  %i98 = fadd fast float %i97, %i90\r\n  %i99 = fadd fast float %i92, poison\r\n  %i100 = fadd fast float %i94, poison\r\n  %i101 = fadd fast float %i96, poison\r\n  %i102 = fadd fast float %i98, poison\r\n  %i103 = fadd fast float %i99, poison\r\n  %i104 = fadd fast float %i100, poison\r\n  %i105 = fadd fast float %i101, poison\r\n  %i106 = fadd fast float %i102, poison\r\n  %i107 = fmul fast float %i79, poison\r\n  %i108 = fmul fast float %i80, poison\r\n  %i109 = fmul fast float %i81, poison\r\n  %i110 = fmul fast float %i82, poison\r\n  %i111 = fmul fast float %i83, poison\r\n  %i112 = fadd fast float %i111, %i107\r\n  %i113 = fmul fast float %i84, poison\r\n  %i114 = fadd fast float %i113, %i108\r\n  %i115 = fmul fast float %i85, poison\r\n  %i116 = fadd fast float %i115, %i109\r\n  %i117 = fmul fast float %i86, poison\r\n  %i118 = fadd fast float %i117, %i110\r\n  %i119 = fadd fast float %i112, poison\r\n  %i120 = fadd fast float %i114, poison\r\n  %i121 = fadd fast float %i116, poison\r\n  %i122 = fadd fast float %i118, poison\r\n  %i123 = fadd fast float %i119, poison\r\n  %i124 = fadd fast float %i120, poison\r\n  %i125 = fadd fast float %i121, poison\r\n  %i126 = fadd fast float %i122, poison\r\n  %i127 = fmul fast float %i79, %i\r\n  %i128 = fmul fast float %i80, %i\r\n  %i129 = fmul fast float %i81, %i\r\n  %i130 = fmul fast float %i82, %i\r\n  %i131 = fmul fast float %i83, %i65\r\n  %i132 = fadd fast float %i131, %i127\r\n  %i133 = fmul fast float %i84, %i65\r\n  %i134 = fadd fast float %i133, %i128\r\n  %i135 = fmul fast float %i85, %i65\r\n  %i136 = fadd fast float %i135, %i129\r\n  %i137 = fmul fast float %i86, %i65\r\n  %i138 = fadd fast float %i137, %i130\r\n  %i139 = fadd fast float %i132, poison\r\n  %i140 = fadd fast float %i134, poison\r\n  %i141 = fadd fast float %i136, poison\r\n  %i142 = fadd fast float %i138, poison\r\n  %i143 = fadd fast float %i139, poison\r\n  %i144 = fadd fast float %i140, poison\r\n  %i145 = fadd fast float %i141, poison\r\n  %i146 = fadd fast float %i142, poison\r\n  %i147 = fmul fast float %i79, poison\r\n  %i148 = fmul fast float %i80, poison\r\n  %i149 = fmul fast float %i81, poison\r\n  %i150 = fmul fast float %i82, poison\r\n  %i151 = fmul fast float %i83, poison\r\n  %i152 = fadd fast float %i151, %i147\r\n  %i153 = fmul fast float %i84, poison\r\n  %i154 = fadd fast float %i153, %i148\r\n  %i155 = fmul fast float %i85, poison\r\n  %i156 = fadd fast float %i155, %i149\r\n  %i157 = fmul fast float %i86, poison\r\n  %i158 = fadd fast float %i157, %i150\r\n  %i159 = fadd fast float %i152, poison\r\n  %i160 = fadd fast float %i154, poison\r\n  %i161 = fadd fast float %i156, poison\r\n  %i162 = fadd fast float %i158, poison\r\n  %i163 = fadd fast float %i159, poison\r\n  %i164 = fadd fast float %i160, poison\r\n  %i165 = fadd fast float %i161, poison\r\n  %i166 = fadd fast float %i162, poison\r\n  br i1 poison, label %bb78, label %bb167\r\n\r\nbb167:                                            ; preds = %bb78, %bb64\r\n  %i168 = phi nsz float [ %i76, %bb64 ], [ %i166, %bb78 ]\r\n  %i169 = phi nsz float [ poison, %bb64 ], [ %i165, %bb78 ]\r\n  %i170 = phi nsz float [ poison, %bb64 ], [ %i164, %bb78 ]\r\n  %i171 = phi nsz float [ %i75, %bb64 ], [ %i163, %bb78 ]\r\n  %i172 = phi nsz float [ %i74, %bb64 ], [ %i146, %bb78 ]\r\n  %i173 = phi nsz float [ %i73, %bb64 ], [ %i145, %bb78 ]\r\n  %i174 = phi nsz float [ %i72, %bb64 ], [ %i144, %bb78 ]\r\n  %i175 = phi nsz float [ %i71, %bb64 ], [ %i143, %bb78 ]\r\n  %i176 = phi nsz float [ %i70, %bb64 ], [ %i126, %bb78 ]\r\n  %i177 = phi nsz float [ poison, %bb64 ], [ %i125, %bb78 ]\r\n  %i178 = phi nsz float [ %i69, %bb64 ], [ %i124, %bb78 ]\r\n  %i179 = phi nsz float [ poison, %bb64 ], [ %i123, %bb78 ]\r\n  %i180 = phi nsz float [ poison, %bb64 ], [ %i106, %bb78 ]\r\n  %i181 = phi nsz float [ %i68, %bb64 ], [ %i105, %bb78 ]\r\n  %i182 = phi nsz float [ %i67, %bb64 ], [ %i104, %bb78 ]\r\n  %i183 = phi nsz float [ %i66, %bb64 ], [ %i103, %bb78 ]\r\n  store float %i182, ptr poison, align 1\r\n  store float %i174, ptr poison, align 1\r\n  br i1 poison, label %bb186, label %bb184\r\n\r\nbb184:                                            ; preds = %bb167\r\n  br label %bb185\r\n\r\nbb185:                                            ; preds = %bb185, %bb184\r\n  br i1 poison, label %bb185, label %bb186\r\n\r\nbb186:                                            ; preds = %bb185, %bb167\r\n  %i187 = phi nsz float [ %i178, %bb167 ], [ poison, %bb185 ]\r\n  ret void\r\n}\r\n```",
    "author": "huihzhang",
    "labels": [
      "llvm:SLPVectorizer",
      "crash"
    ],
    "comments": []
  }
}
