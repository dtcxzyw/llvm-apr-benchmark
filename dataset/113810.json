{
  "bug_id": "113810",
  "issue_url": "https://github.com/llvm/llvm-project/issues/113810",
  "bug_type": "crash",
  "base_commit": "ce0368eb8417f2d369499bb98b1f0ccbe2219598",
  "knowledge_cutoff": "2024-10-27T14:16:44Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "7152bf3bc805b8d9b1873058ab0a084d7b6079d6",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          7947,
          7954
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "BoUpSLP::buildTree_rec"
      ]
    }
  },
  "patch": "commit 7152bf3bc805b8d9b1873058ab0a084d7b6079d6\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Mon Oct 28 06:37:24 2024 -0700\n\n    [SLP]Do not create new vector node if scalars fully overlap with the existing one\n    \n    If the list of scalars vectorized as the part of the same vector node,\n    no need to generate vector node again, it will be handled as part of\n    overlapping matching.\n    \n    Fixes #113810\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 2afd02dae3a8..268546fe99e1 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -7947,8 +7947,13 @@ void BoUpSLP::buildTree_rec(ArrayRef<Value *> VL, unsigned Depth,\n           Nodes.insert(E);\n         SmallPtrSet<Value *, 8> Values(VL.begin(), VL.end());\n         if (any_of(Nodes, [&](const TreeEntry *E) {\n-              return all_of(E->Scalars,\n-                            [&](Value *V) { return Values.contains(V); });\n+              if (all_of(E->Scalars,\n+                         [&](Value *V) { return Values.contains(V); }))\n+                return true;\n+              SmallPtrSet<Value *, 8> EValues(E->Scalars.begin(),\n+                                              E->Scalars.end());\n+              return (\n+                  all_of(VL, [&](Value *V) { return EValues.contains(V); }));\n             })) {\n           LLVM_DEBUG(dbgs() << \"SLP: Gathering due to full overlap.\\n\");\n           if (TryToFindDuplicates(S))\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/full-overlap-non-schedulable.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer < %s"
      ],
      "tests": [
        {
          "test_name": "test",
          "test_body": "define void @test(ptr %p1, ptr %0, i32 %1, i1 %c1, ptr %p2) {\ntop:\n  %2 = getelementptr i8, ptr %0, i64 8\n  %3 = getelementptr i8, ptr %0, i64 12\n  %4 = getelementptr i8, ptr %0, i64 16\n  %5 = getelementptr i8, ptr %0, i64 20\n  br i1 %c1, label %L42, label %L41\n\nL41:                                              ; preds = %top\n  %.not276 = icmp eq ptr %2, null\n  %6 = load i32, ptr %2, align 4\n  %7 = select i1 %.not276, i32 0, i32 %6\n  %.not277 = icmp eq ptr %3, null\n  %8 = load i32, ptr %3, align 4\n  %9 = select i1 %.not277, i32 0, i32 %8\n  %.not278 = icmp eq ptr %4, null\n  %10 = load i32, ptr %4, align 4\n  %11 = select i1 %.not278, i32 0, i32 %10\n  %.not279 = icmp eq ptr %5, null\n  %12 = load i32, ptr %5, align 4\n  %13 = select i1 %.not279, i32 0, i32 %12\n  br label %L112\n\nL42:                                              ; preds = %top\n  %14 = load i32, ptr %2, align 4\n  %.not280 = icmp eq i32 %14, 0\n  br i1 %.not280, label %L112, label %L47\n\nL47:                                              ; preds = %L42\n  %15 = load i32, ptr %3, align 4\n  %.not282 = icmp eq ptr %4, null\n  %16 = load i32, ptr %4, align 4\n  %17 = select i1 %.not282, i32 0, i32 %16\n  %.not283 = icmp eq ptr %5, null\n  %18 = load i32, ptr %5, align 4\n  %19 = select i1 %.not283, i32 0, i32 %18\n  br label %L112\n\nL112:                                             ; preds = %L47, %L42, %L41\n  %value_phi13336 = phi i32 [ %19, %L47 ], [ %13, %L41 ], [ 0, %L42 ]\n  %value_phi12335 = phi i32 [ %17, %L47 ], [ %11, %L41 ], [ %1, %L42 ]\n  %value_phi11334 = phi i32 [ %15, %L47 ], [ %9, %L41 ], [ 0, %L42 ]\n  %value_phi10333 = phi i32 [ 0, %L47 ], [ %7, %L41 ], [ 0, %L42 ]\n  store i32 %value_phi10333, ptr %p2, align 4\n  store i32 %value_phi11334, ptr %p1, align 4\n  store i32 %value_phi12335, ptr %p2, align 4\n  store i32 %value_phi13336, ptr %p1, align 4\n  ret void\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "SLPVectorizer miscompilation",
    "body": "This IR\r\n```llvm\r\n; Function Attrs: alignstack(16)\r\ndefine swiftcc { ptr addrspace(10), i8 } @julia__zip_iterate_all_17381(ptr noalias nocapture noundef nonnull align 4 dereferenceable(96) %union_bytes_return, ptr nonnull swiftself %pgcstack_arg, ptr addrspace(11) nocapture noundef nonnull readonly align 4 dereferenceable(48) %0, ptr addrspace(11) nocapture noundef nonnull readonly align 4 dereferenceable(48) %1) #0 {\r\ntop:\r\n  %pgcstack = call ptr @julia.get_pgcstack()\r\n  %ptls_field = getelementptr inbounds i8, ptr %pgcstack, i32 8\r\n  %ptls_load = load ptr, ptr %ptls_field, align 4\r\n  %2 = getelementptr inbounds i8, ptr %ptls_load, i32 16\r\n  %safepoint = load ptr, ptr %2, align 4\r\n  fence syncscope(\"singlethread\") seq_cst\r\n  call void @julia.safepoint(ptr %safepoint)\r\n  fence syncscope(\"singlethread\") seq_cst\r\n  %3 = load i32, ptr addrspace(11) %1, align 4\r\n  %4 = load i32, ptr addrspace(11) %0, align 4\r\n  %.not = icmp eq i32 %3, %4\r\n  br i1 %.not, label %L26, label %L20\r\n\r\nL20:                                              ; preds = %top\r\n  %5 = add i32 %3, 1\r\n  %6 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 4\r\n  %7 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 8\r\n  %8 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 12\r\n  %9 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 16\r\n  %10 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 20\r\n  %.not265 = icmp eq ptr addrspace(11) %6, null\r\n  %11 = load i32, ptr addrspace(11) %6, align 4\r\n  %12 = select i1 %.not265, i32 undef, i32 %11\r\n  %.not266 = icmp eq ptr addrspace(11) %7, null\r\n  %13 = load i32, ptr addrspace(11) %7, align 4\r\n  %14 = select i1 %.not266, i32 undef, i32 %13\r\n  %.not267 = icmp eq ptr addrspace(11) %8, null\r\n  %15 = load i32, ptr addrspace(11) %8, align 4\r\n  %16 = select i1 %.not267, i32 undef, i32 %15\r\n  %.not268 = icmp eq ptr addrspace(11) %9, null\r\n  %17 = load i32, ptr addrspace(11) %9, align 4\r\n  %18 = select i1 %.not268, i32 undef, i32 %17\r\n  %.not269 = icmp eq ptr addrspace(11) %10, null\r\n  %19 = load i32, ptr addrspace(11) %10, align 4\r\n  %20 = select i1 %.not269, i32 undef, i32 %19\r\n  br label %L112\r\n\r\nL26:                                              ; preds = %top\r\n  %21 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 4\r\n  %22 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 8\r\n  %23 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 12\r\n  %24 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 16\r\n  %25 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 20\r\n  %26 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 4\r\n  %27 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 12\r\n  %28 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 16\r\n  %29 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 20\r\n  %30 = load i32, ptr addrspace(11) %21, align 4\r\n  %31 = load i32, ptr addrspace(11) %26, align 4\r\n  %.not275 = icmp eq i32 %30, %31\r\n  br i1 %.not275, label %L42, label %L41\r\n\r\nL41:                                              ; preds = %L26\r\n  %32 = add i32 %30, 1\r\n  %.not276 = icmp eq ptr addrspace(11) %22, null\r\n  %33 = load i32, ptr addrspace(11) %22, align 4\r\n  %34 = select i1 %.not276, i32 undef, i32 %33\r\n  %.not277 = icmp eq ptr addrspace(11) %23, null\r\n  %35 = load i32, ptr addrspace(11) %23, align 4\r\n  %36 = select i1 %.not277, i32 undef, i32 %35\r\n  %.not278 = icmp eq ptr addrspace(11) %24, null\r\n  %37 = load i32, ptr addrspace(11) %24, align 4\r\n  %38 = select i1 %.not278, i32 undef, i32 %37\r\n  %.not279 = icmp eq ptr addrspace(11) %25, null\r\n  %39 = load i32, ptr addrspace(11) %25, align 4\r\n  %40 = select i1 %.not279, i32 undef, i32 %39\r\n  br label %L112\r\n\r\nL42:                                              ; preds = %L26\r\n  %41 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 8\r\n  %42 = load i32, ptr addrspace(11) %22, align 4\r\n  %43 = load i32, ptr addrspace(11) %41, align 4\r\n  %.not280 = icmp eq i32 %42, %43\r\n  br i1 %.not280, label %L48, label %L47\r\n\r\nL47:                                              ; preds = %L42\r\n  %44 = add i32 %42, 1\r\n  %.not281 = icmp eq ptr addrspace(11) %23, null\r\n  %45 = load i32, ptr addrspace(11) %23, align 4\r\n  %46 = select i1 %.not281, i32 undef, i32 %45\r\n  %.not282 = icmp eq ptr addrspace(11) %24, null\r\n  %47 = load i32, ptr addrspace(11) %24, align 4\r\n  %48 = select i1 %.not282, i32 undef, i32 %47\r\n  %.not283 = icmp eq ptr addrspace(11) %25, null\r\n  %49 = load i32, ptr addrspace(11) %25, align 4\r\n  %50 = select i1 %.not283, i32 undef, i32 %49\r\n  br label %L112\r\n\r\nL48:                                              ; preds = %L42\r\n  %51 = load i32, ptr addrspace(11) %23, align 4\r\n  %52 = load i32, ptr addrspace(11) %27, align 4\r\n  %.not284 = icmp eq i32 %51, %52\r\n  br i1 %.not284, label %L54, label %L53\r\n\r\nL53:                                              ; preds = %L48\r\n  %53 = add i32 %51, 1\r\n  %.not285 = icmp eq ptr addrspace(11) %24, null\r\n  %54 = load i32, ptr addrspace(11) %24, align 4\r\n  %55 = select i1 %.not285, i32 undef, i32 %54\r\n  %.not286 = icmp eq ptr addrspace(11) %25, null\r\n  %56 = load i32, ptr addrspace(11) %25, align 4\r\n  %57 = select i1 %.not286, i32 undef, i32 %56\r\n  br label %L112\r\n\r\nL54:                                              ; preds = %L48\r\n  %58 = load i32, ptr addrspace(11) %24, align 4\r\n  %59 = load i32, ptr addrspace(11) %28, align 4\r\n  %.not287 = icmp eq i32 %58, %59\r\n  br i1 %.not287, label %L87, label %L59\r\n\r\nL59:                                              ; preds = %L54\r\n  %60 = add i32 %58, 1\r\n  %.not288 = icmp eq ptr addrspace(11) %25, null\r\n  %61 = load i32, ptr addrspace(11) %25, align 4\r\n  %62 = select i1 %.not288, i32 undef, i32 %61\r\n  br label %L112\r\n\r\nL87:                                              ; preds = %L54\r\n  %63 = load i32, ptr addrspace(11) %25, align 4\r\n  %64 = add i32 %63, 1\r\n  %65 = load i32, ptr addrspace(11) %29, align 4\r\n  %66 = icmp eq i32 %63, %65\r\n  br i1 %66, label %common.ret, label %L112\r\n\r\nL112:                                             ; preds = %L87, %L20, %L41, %L47, %L53, %L59\r\n  %value_phi13336 = phi i32 [ %64, %L87 ], [ %62, %L59 ], [ %57, %L53 ], [ %50, %L47 ], [ %40, %L41 ], [ %20, %L20 ]\r\n  %value_phi12335 = phi i32 [ 1, %L87 ], [ %60, %L59 ], [ %55, %L53 ], [ %48, %L47 ], [ %38, %L41 ], [ %18, %L20 ]\r\n  %value_phi11334 = phi i32 [ 1, %L87 ], [ 1, %L59 ], [ %53, %L53 ], [ %46, %L47 ], [ %36, %L41 ], [ %16, %L20 ]\r\n  %value_phi10333 = phi i32 [ 1, %L87 ], [ 1, %L59 ], [ 1, %L53 ], [ %44, %L47 ], [ %34, %L41 ], [ %14, %L20 ]\r\n  %value_phi9332 = phi i32 [ 1, %L87 ], [ 1, %L59 ], [ 1, %L53 ], [ 1, %L47 ], [ %32, %L41 ], [ %12, %L20 ]\r\n  %value_phi2326 = phi i32 [ 1, %L87 ], [ 1, %L59 ], [ 1, %L53 ], [ 1, %L47 ], [ 1, %L41 ], [ %5, %L20 ]\r\n  %67 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 24\r\n  %68 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 24\r\n  %69 = load i32, ptr addrspace(11) %68, align 4\r\n  %70 = load i32, ptr addrspace(11) %67, align 4\r\n  %.not289 = icmp eq i32 %69, %70\r\n  br i1 %.not289, label %L134, label %L128\r\n\r\nL128:                                             ; preds = %L112\r\n  %71 = add i32 %69, 1\r\n  %72 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 28\r\n  %73 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 32\r\n  %74 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 36\r\n  %75 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 40\r\n  %76 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 44\r\n  %.not290 = icmp eq ptr addrspace(11) %72, null\r\n  %77 = load i32, ptr addrspace(11) %72, align 4\r\n  %78 = select i1 %.not290, i32 undef, i32 %77\r\n  %.not291 = icmp eq ptr addrspace(11) %73, null\r\n  %79 = load i32, ptr addrspace(11) %73, align 4\r\n  %80 = select i1 %.not291, i32 undef, i32 %79\r\n  %.not292 = icmp eq ptr addrspace(11) %74, null\r\n  %81 = load i32, ptr addrspace(11) %74, align 4\r\n  %82 = select i1 %.not292, i32 undef, i32 %81\r\n  %.not293 = icmp eq ptr addrspace(11) %75, null\r\n  %83 = load i32, ptr addrspace(11) %75, align 4\r\n  %84 = select i1 %.not293, i32 undef, i32 %83\r\n  %.not294 = icmp eq ptr addrspace(11) %76, null\r\n  %85 = load i32, ptr addrspace(11) %76, align 4\r\n  %86 = select i1 %.not294, i32 undef, i32 %85\r\n  br label %L230\r\n\r\nL134:                                             ; preds = %L112\r\n  %87 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 28\r\n  %88 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 32\r\n  %89 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 36\r\n  %90 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 40\r\n  %91 = getelementptr inbounds i8, ptr addrspace(11) %1, i32 44\r\n  %92 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 28\r\n  %93 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 36\r\n  %94 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 40\r\n  %95 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 44\r\n  %96 = load i32, ptr addrspace(11) %87, align 4\r\n  %97 = load i32, ptr addrspace(11) %92, align 4\r\n  %.not300 = icmp eq i32 %96, %97\r\n  br i1 %.not300, label %L150, label %L149\r\n\r\nL149:                                             ; preds = %L134\r\n  %98 = add i32 %96, 1\r\n  %.not301 = icmp eq ptr addrspace(11) %88, null\r\n  %99 = load i32, ptr addrspace(11) %88, align 4\r\n  %100 = select i1 %.not301, i32 undef, i32 %99\r\n  %.not302 = icmp eq ptr addrspace(11) %89, null\r\n  %101 = load i32, ptr addrspace(11) %89, align 4\r\n  %102 = select i1 %.not302, i32 undef, i32 %101\r\n  %.not303 = icmp eq ptr addrspace(11) %90, null\r\n  %103 = load i32, ptr addrspace(11) %90, align 4\r\n  %104 = select i1 %.not303, i32 undef, i32 %103\r\n  %.not304 = icmp eq ptr addrspace(11) %91, null\r\n  %105 = load i32, ptr addrspace(11) %91, align 4\r\n  %106 = select i1 %.not304, i32 undef, i32 %105\r\n  br label %L230\r\n\r\nL150:                                             ; preds = %L134\r\n  %107 = getelementptr inbounds i8, ptr addrspace(11) %0, i32 32\r\n  %108 = load i32, ptr addrspace(11) %88, align 4\r\n  %109 = load i32, ptr addrspace(11) %107, align 4\r\n  %.not305 = icmp eq i32 %108, %109\r\n  br i1 %.not305, label %L156, label %L155\r\n\r\nL155:                                             ; preds = %L150\r\n  %110 = add i32 %108, 1\r\n  %.not306 = icmp eq ptr addrspace(11) %89, null\r\n  %111 = load i32, ptr addrspace(11) %89, align 4\r\n  %112 = select i1 %.not306, i32 undef, i32 %111\r\n  %.not307 = icmp eq ptr addrspace(11) %90, null\r\n  %113 = load i32, ptr addrspace(11) %90, align 4\r\n  %114 = select i1 %.not307, i32 undef, i32 %113\r\n  %.not308 = icmp eq ptr addrspace(11) %91, null\r\n  %115 = load i32, ptr addrspace(11) %91, align 4\r\n  %116 = select i1 %.not308, i32 undef, i32 %115\r\n  br label %L230\r\n\r\nL156:                                             ; preds = %L150\r\n  %117 = load i32, ptr addrspace(11) %89, align 4\r\n  %118 = load i32, ptr addrspace(11) %93, align 4\r\n  %.not309 = icmp eq i32 %117, %118\r\n  br i1 %.not309, label %L162, label %L161\r\n\r\nL161:                                             ; preds = %L156\r\n  %119 = add i32 %117, 1\r\n  %.not310 = icmp eq ptr addrspace(11) %90, null\r\n  %120 = load i32, ptr addrspace(11) %90, align 4\r\n  %121 = select i1 %.not310, i32 undef, i32 %120\r\n  %.not311 = icmp eq ptr addrspace(11) %91, null\r\n  %122 = load i32, ptr addrspace(11) %91, align 4\r\n  %123 = select i1 %.not311, i32 undef, i32 %122\r\n  br label %L230\r\n\r\nL162:                                             ; preds = %L156\r\n  %124 = load i32, ptr addrspace(11) %90, align 4\r\n  %125 = load i32, ptr addrspace(11) %94, align 4\r\n  %.not312 = icmp eq i32 %124, %125\r\n  br i1 %.not312, label %L195, label %L167\r\n\r\nL167:                                             ; preds = %L162\r\n  %126 = add i32 %124, 1\r\n  %.not313 = icmp eq ptr addrspace(11) %91, null\r\n  %127 = load i32, ptr addrspace(11) %91, align 4\r\n  %128 = select i1 %.not313, i32 undef, i32 %127\r\n  br label %L230\r\n\r\nL195:                                             ; preds = %L162\r\n  %129 = load i32, ptr addrspace(11) %91, align 4\r\n  %130 = add i32 %129, 1\r\n  %131 = load i32, ptr addrspace(11) %95, align 4\r\n  %132 = icmp eq i32 %129, %131\r\n  br i1 %132, label %common.ret, label %L230\r\n\r\ncommon.ret:                                       ; preds = %L87, %L195, %L230\r\n  %common.ret.op = phi { ptr addrspace(10), i8 } [ { ptr addrspace(10) null, i8 2 }, %L230 ], [ { ptr addrspace(10) null, i8 1 }, %L195 ], [ { ptr addrspace(10) null, i8 1 }, %L87 ]\r\n  ret { ptr addrspace(10), i8 } %common.ret.op\r\n\r\nL230:                                             ; preds = %L195, %L128, %L149, %L155, %L161, %L167\r\n  %value_phi29359 = phi i32 [ %130, %L195 ], [ %128, %L167 ], [ %123, %L161 ], [ %116, %L155 ], [ %106, %L149 ], [ %86, %L128 ]\r\n  %value_phi28358 = phi i32 [ 1, %L195 ], [ %126, %L167 ], [ %121, %L161 ], [ %114, %L155 ], [ %104, %L149 ], [ %84, %L128 ]\r\n  %value_phi27357 = phi i32 [ 1, %L195 ], [ 1, %L167 ], [ %119, %L161 ], [ %112, %L155 ], [ %102, %L149 ], [ %82, %L128 ]\r\n  %value_phi26356 = phi i32 [ 1, %L195 ], [ 1, %L167 ], [ 1, %L161 ], [ %110, %L155 ], [ %100, %L149 ], [ %80, %L128 ]\r\n  %value_phi25355 = phi i32 [ 1, %L195 ], [ 1, %L167 ], [ 1, %L161 ], [ 1, %L155 ], [ %98, %L149 ], [ %78, %L128 ]\r\n  %value_phi18349 = phi i32 [ 1, %L195 ], [ 1, %L167 ], [ 1, %L161 ], [ 1, %L155 ], [ 1, %L149 ], [ %71, %L128 ]\r\n  store i32 %value_phi2326, ptr %union_bytes_return, align 4\r\n  %.sroa.0429.sroa.0.sroa.2.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 4\r\n  store i32 %value_phi9332, ptr %.sroa.0429.sroa.0.sroa.2.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.0.sroa.3.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 8\r\n  store i32 %value_phi10333, ptr %.sroa.0429.sroa.0.sroa.3.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.0.sroa.4.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 12\r\n  store i32 %value_phi11334, ptr %.sroa.0429.sroa.0.sroa.4.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.0.sroa.5.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 16\r\n  store i32 %value_phi12335, ptr %.sroa.0429.sroa.0.sroa.5.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.0.sroa.6.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 20\r\n  store i32 %value_phi13336, ptr %.sroa.0429.sroa.0.sroa.6.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.2.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 24\r\n  store i32 %value_phi18349, ptr %.sroa.0429.sroa.2.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.3.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 28\r\n  store i32 %value_phi25355, ptr %.sroa.0429.sroa.3.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.4.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 32\r\n  store i32 %value_phi26356, ptr %.sroa.0429.sroa.4.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.5.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 36\r\n  store i32 %value_phi27357, ptr %.sroa.0429.sroa.5.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.6.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 40\r\n  store i32 %value_phi28358, ptr %.sroa.0429.sroa.6.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.7.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 44\r\n  store i32 %value_phi29359, ptr %.sroa.0429.sroa.7.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 48\r\n  store i32 %value_phi2326, ptr %.sroa.0429.sroa.8.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.sroa.2.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 52\r\n  store i32 %value_phi9332, ptr %.sroa.0429.sroa.8.sroa.2.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.sroa.3.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 56\r\n  store i32 %value_phi10333, ptr %.sroa.0429.sroa.8.sroa.3.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.sroa.4.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 60\r\n  store i32 %value_phi11334, ptr %.sroa.0429.sroa.8.sroa.4.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.sroa.5.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 64\r\n  store i32 %value_phi12335, ptr %.sroa.0429.sroa.8.sroa.5.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx, align 4\r\n  %.sroa.0429.sroa.8.sroa.6.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 68\r\n  store i32 %value_phi13336, ptr %.sroa.0429.sroa.8.sroa.6.0..sroa.0429.sroa.8.0.union_bytes_return.sroa_idx.sroa_idx, align 4\r\n  %.sroa.4430.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 72\r\n  store i32 %value_phi18349, ptr %.sroa.4430.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.5431.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 76\r\n  store i32 %value_phi25355, ptr %.sroa.5431.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.6432.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 80\r\n  store i32 %value_phi26356, ptr %.sroa.6432.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.7433.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 84\r\n  store i32 %value_phi27357, ptr %.sroa.7433.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.8434.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 88\r\n  store i32 %value_phi28358, ptr %.sroa.8434.0.union_bytes_return.sroa_idx, align 4\r\n  %.sroa.9435.0.union_bytes_return.sroa_idx = getelementptr inbounds i8, ptr %union_bytes_return, i32 92\r\n  store i32 %value_phi29359, ptr %.sroa.9435.0.union_bytes_return.sroa_idx, align 4\r\n  br label %common.ret\r\n}\r\n\r\ndeclare ptr @julia.get_pgcstack()\r\n\r\n; Function Attrs: memory(argmem: readwrite, inaccessiblemem: readwrite)\r\ndeclare void @julia.safepoint(ptr) #2\r\n\r\n; Function Attrs: willreturn memory(argmem: read, inaccessiblemem: readwrite)\r\ndeclare nonnull align 16 dereferenceable(16) ptr addrspace(10) @jl_alloc_genericmemory(ptr addrspace(10), i32) #3\r\n\r\n; Function Attrs: nounwind willreturn allockind(\"alloc\") allocsize(1) memory(argmem: read, inaccessiblemem: readwrite)\r\ndeclare noalias nonnull ptr addrspace(10) @julia.gc_alloc_obj(ptr, i32, ptr addrspace(10)) #4\r\n\r\n; Function Attrs: norecurse nosync nounwind speculatable willreturn memory(none)\r\ndeclare noundef nonnull ptr addrspace(13) @julia.gc_loaded(ptr addrspace(10) nocapture noundef nonnull readnone, ptr noundef nonnull readnone) #5\r\n\r\n; Function Attrs: nocallback nofree nosync nounwind willreturn memory(argmem: readwrite)\r\ndeclare void @llvm.lifetime.start.p0(i64 immarg, ptr nocapture) #6\r\n\r\n; Function Attrs: nocallback nofree nosync nounwind willreturn memory(argmem: readwrite)\r\ndeclare void @llvm.lifetime.end.p0(i64 immarg, ptr nocapture) #6\r\n```\r\ngives error \r\n```\r\nInstruction does not dominate all uses!\r\n  %20 = shufflevector <4 x ptr addrspace(11)> %19, <4 x ptr addrspace(11)> poison, <4 x i32> zeroinitializer\r\n  %17 = shufflevector <4 x ptr addrspace(11)> %20, <4 x ptr addrspace(11)> poison, <2 x i32> zeroinitializer\r\nInstruction does not dominate all uses!\r\n  %90 = shufflevector <4 x ptr addrspace(11)> %89, <4 x ptr addrspace(11)> poison, <4 x i32> zeroinitializer\r\n  %87 = shufflevector <4 x ptr addrspace(11)> %90, <4 x ptr addrspace(11)> poison, <2 x i32> zeroinitializer\r\nLLVM ERROR: Broken module found, compilation aborted!\r\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.\r\nStack dump:\r\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=slp-vectorizer <source>\r\n1.\tRunning pass \"verify\" on module \"<source>\"\r\n #0 0x00000000050e6958 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x50e6958)\r\n #1 0x00000000050e434c SignalHandler(int) Signals.cpp:0:0\r\n #2 0x00007508e6a42520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\r\n #3 0x00007508e6a969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\r\n #4 0x00007508e6a42476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\r\n #5 0x00007508e6a287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\r\n #6 0x00000000007d7105 llvm::json::operator==(llvm::json::Value const&, llvm::json::Value const&) (.cold) JSON.cpp:0:0\r\n #7 0x00000000050254d8 (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x50254d8)\r\n #8 0x0000000004f23440 llvm::VerifierPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4f23440)\r\n #9 0x00000000009000ae llvm::detail::PassModel<llvm::Module, llvm::VerifierPass, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x9000ae)\r\n#10 0x0000000004ee6850 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x4ee6850)\r\n#11 0x000000000090adda llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x90adda)\r\n#12 0x00000000008fdd2a optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x8fdd2a)\r\n#13 0x00007508e6a29d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\r\n#14 0x00007508e6a29e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\r\n#15 0x00000000008f57ae _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x8f57ae)\r\nProgram terminated with signal: SIGSEGV\r\nCompiler returned: 139\r\n```\r\nhttps://godbolt.org/z/sah34KE77",
    "author": "Zentrik",
    "labels": [
      "miscompilation",
      "llvm:SLPVectorizer"
    ],
    "comments": [
      {
        "author": "Zentrik",
        "body": "Reduced IR:\r\n```llvm\r\ndefine swiftcc { ptr addrspace(10), i8 } @julia__zip_iterate_all_17381(ptr addrspace(11) %0, i32 %1) {\r\ntop:\r\n  %2 = getelementptr i8, ptr addrspace(11) %0, i32 8\r\n  %3 = getelementptr i8, ptr addrspace(11) %0, i32 12\r\n  %4 = getelementptr i8, ptr addrspace(11) %0, i32 16\r\n  %5 = getelementptr i8, ptr addrspace(11) %0, i32 20\r\n  br i1 false, label %L42, label %L41\r\n\r\nL41:                                              ; preds = %top\r\n  %.not276 = icmp eq ptr addrspace(11) %2, null\r\n  %6 = select i1 %.not276, i32 0, i32 0\r\n  %.not277 = icmp eq ptr addrspace(11) %3, null\r\n  %7 = select i1 %.not277, i32 0, i32 0\r\n  %.not278 = icmp eq ptr addrspace(11) %4, null\r\n  %8 = select i1 %.not278, i32 0, i32 0\r\n  %.not279 = icmp eq ptr addrspace(11) %5, null\r\n  %9 = select i1 %.not279, i32 0, i32 0\r\n  br label %common.ret\r\n\r\nL42:                                              ; preds = %top\r\n  %.not282 = icmp eq ptr addrspace(11) %4, null\r\n  %10 = select i1 %.not282, i32 0, i32 0\r\n  %.not283 = icmp eq ptr addrspace(11) %5, null\r\n  %11 = select i1 %.not283, i32 0, i32 0\r\n  br label %common.ret\r\n\r\nL59:                                              ; No predecessors!\r\n  %12 = select i1 false, i32 0, i32 0\r\n  br label %common.ret\r\n\r\ncommon.ret:                                       ; preds = %L59, %L42, %L41\r\n  %value_phi13336 = phi i32 [ %12, %L59 ], [ %11, %L42 ], [ %9, %L41 ]\r\n  %value_phi12335 = phi i32 [ 0, %L59 ], [ %10, %L42 ], [ %8, %L41 ]\r\n  %value_phi11334 = phi i32 [ 0, %L59 ], [ %1, %L42 ], [ %7, %L41 ]\r\n  %value_phi10333 = phi i32 [ 0, %L59 ], [ 0, %L42 ], [ %6, %L41 ]\r\n  ret { ptr addrspace(10), i8 } zeroinitializer\r\n}\r\n```\r\nhttps://godbolt.org/z/a8xzqGYo9"
      },
      {
        "author": "Zentrik",
        "body": "Bisected to 69332bb8995aef60d830406de12cb79a5039026 and f3d2609af3031ddb54030548e86335f295cf49ca, @alexey-bataev "
      }
    ]
  },
  "verified": true,
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  }
}