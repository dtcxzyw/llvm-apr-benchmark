{
  "bug_id": "159918",
  "issue_url": "https://github.com/llvm/llvm-project/issues/159918",
  "bug_type": "crash",
  "base_commit": "178e2a704b1dc5209e4cc24866a2738c5bc468f3",
  "knowledge_cutoff": "2025-09-20T12:01:49Z",
  "lit_test_dir": [
    "llvm/test/Transforms/NewGVN"
  ],
  "hints": {
    "fix_commit": "be29612ffceac888f931dc45664f7c42cea9b598",
    "components": [
      "NewGVN"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Scalar/NewGVN.cpp": [
        [
          1646,
          1655
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Scalar/NewGVN.cpp": [
        "NewGVN::performSymbolicCallEvaluation"
      ]
    }
  },
  "patch": "commit be29612ffceac888f931dc45664f7c42cea9b598\nAuthor: ManuelJBrito <59119670+ManuelJBrito@users.noreply.github.com>\nDate:   Fri Oct 3 20:52:29 2025 +0100\n\n    [NewGVN] Remove returned arg simplification (#161865)\n    \n    Replacing uses of the return value with the argument is already handled\n    in other passes, additionally it causes issues with memory value\n    numbering when the call is a memory defining intrinsic.\n    fixes #159918\n\ndiff --git a/llvm/lib/Transforms/Scalar/NewGVN.cpp b/llvm/lib/Transforms/Scalar/NewGVN.cpp\nindex 9d4fb7941659..d6b76335dbb9 100644\n--- a/llvm/lib/Transforms/Scalar/NewGVN.cpp\n+++ b/llvm/lib/Transforms/Scalar/NewGVN.cpp\n@@ -1646,10 +1646,6 @@ NewGVN::performSymbolicPredicateInfoEvaluation(BitCastInst *I) const {\n // Evaluate read only and pure calls, and create an expression result.\n NewGVN::ExprResult NewGVN::performSymbolicCallEvaluation(Instruction *I) const {\n   auto *CI = cast<CallInst>(I);\n-  if (auto *II = dyn_cast<IntrinsicInst>(I)) {\n-    if (auto *ReturnedValue = II->getReturnedArgOperand())\n-      return ExprResult::some(createVariableOrConstant(ReturnedValue));\n-  }\n \n   // FIXME: Currently the calls which may access the thread id may\n   // be considered as not accessing the memory. But this is\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/NewGVN/pr159918.ll",
      "commands": [
        "opt -S -passes=newgvn < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\n; Don't use returned argument in memory defining intrinsics.\ndefine void @wombat(ptr %arg) {\n;\n  %load = load ptr, ptr %arg, align 8\n  %call = call ptr @llvm.objc.retain(ptr %load)\n  store ptr %call, ptr %arg, align 8\n  ret void\n}\n\ndeclare ptr @llvm.objc.retain(ptr returned) #0\n\nattributes #0 = { nounwind }"
        }
      ]
    }
  ],
  "issue": {
    "title": "[NewGVN] Assertion `NewClass->size() == 1 || (isa<StoreInst>(I) && NewClass->getStoreCount() == 1)' failed.",
    "body": "Reproducer:\nhttps://godbolt.org/z/xMdK51ceK\n\nBacktrace:\n```console\nopt: /root/llvm-project/llvm/lib/Transforms/Scalar/NewGVN.cpp:2251: void {anonymous}::NewGVN::moveMemoryToNewCongruenceClass(llvm::Instruction*, llvm::MemoryAccess*, {anonymous}::CongruenceClass*, {anonymous}::CongruenceClass*): Assertion `NewClass->size() == 1 || (isa<StoreInst>(I) && NewClass->getStoreCount() == 1)' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/opt -o /app/output.s -S -passes=newgvn <source>\n1.\tRunning pass \"function(newgvn)\" on module \"<source>\"\n2.\tRunning pass \"newgvn\" on function \"test_catch_with_objc_intrinsic\"\n #0 0x00000000058c75d8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x58c75d8)\n #1 0x00000000058c4484 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #2 0x00007accadc42520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #3 0x00007accadc969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #4 0x00007accadc42476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #5 0x00007accadc287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #6 0x00007accadc2871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #7 0x00007accadc39e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #8 0x00000000047081ce (anonymous namespace)::NewGVN::performCongruenceFinding(llvm::Instruction*, llvm::GVNExpression::Expression const*) NewGVN.cpp:0:0\n #9 0x0000000004716770 (anonymous namespace)::NewGVN::iterateTouchedInstructions() NewGVN.cpp:0:0\n#10 0x00000000047189f9 (anonymous namespace)::NewGVN::runGVN() NewGVN.cpp:0:0\n#11 0x000000000471aa7c llvm::NewGVNPass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x471aa7c)\n#12 0x0000000002f48a6e llvm::detail::PassModel<llvm::Function, llvm::NewGVNPass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x2f48a6e)\n#13 0x00000000056ae891 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56ae891)\n#14 0x0000000000eea94e llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0xeea94e)\n#15 0x00000000056acdfa llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56acdfa)\n#16 0x0000000000971bbe llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x971bbe)\n#17 0x00000000056ac7b1 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x56ac7b1)\n#18 0x000000000097bd78 llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x97bd78)\n#19 0x000000000096ff39 optMain (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x96ff39)\n#20 0x00007accadc29d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#21 0x00007accadc29e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#22 0x0000000000967095 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/opt+0x967095)\nProgram terminated with signal: SIGSEGV\nCompiler returned: 139\n```",
    "author": "k-arrows",
    "labels": [
      "crash",
      "llvm:GVN"
    ],
    "comments": [
      {
        "author": "k-arrows",
        "body": "The above reproducer comes from the following:\nhttps://github.com/llvm/llvm-project/blob/main/llvm/test/CodeGen/X86/win64-funclet-preisel-intrinsics.ll"
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}