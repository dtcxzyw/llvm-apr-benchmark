{
  "bug_id": "172221",
  "issue_url": "https://github.com/llvm/llvm-project/issues/172221",
  "bug_type": "crash",
  "base_commit": "82a8748aad3828c217fdb3f2dd0459b493084a70",
  "knowledge_cutoff": "2025-12-14T20:10:58Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "b9885558120c0a825d3ecc9dfa4d79a816060ef4",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          14108,
          14113
        ],
        [
          18283,
          18288
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "adjustExtracts"
      ]
    }
  },
  "patch": "commit b9885558120c0a825d3ecc9dfa4d79a816060ef4\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Mon Dec 15 08:22:24 2025 -0800\n\n    [SLP]Check if the extractelement is part of other buildvector node before marking for erasing\n    \n    Need to check if the extractelement instruction is part of other\n    buildvector node, before trying to mark it for the deletion, otherwise\n    the compiler may reuse the deleted instruction.\n    \n    Fixes #172221\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex a56edc67f28e..83faa89218bc 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -14108,6 +14108,11 @@ public:\n         ArrayRef<TreeEntry *> VEs = R.getTreeEntries(V);\n         if (!CheckedExtracts.insert(V).second ||\n             !R.areAllUsersVectorized(cast<Instruction>(V), &VectorizedVals) ||\n+            (E->UserTreeIndex && E->UserTreeIndex.EdgeIdx == UINT_MAX &&\n+             !R.isVectorized(EE) &&\n+             count_if(E->Scalars, [&](Value *V) { return V == EE; }) !=\n+                 count_if(E->UserTreeIndex.UserTE->Scalars,\n+                          [&](Value *V) { return V == EE; })) ||\n             any_of(EE->users(),\n                    [&](User *U) {\n                      return isa<GetElementPtrInst>(U) &&\n@@ -18283,6 +18288,11 @@ public:\n       // If the only one use is vectorized - can delete the extractelement\n       // itself.\n       if (!EI->hasOneUse() || R.ExternalUsesAsOriginalScalar.contains(EI) ||\n+          (E->UserTreeIndex && E->UserTreeIndex.EdgeIdx == UINT_MAX &&\n+           !R.isVectorized(EI) &&\n+           count_if(E->Scalars, [&](Value *V) { return V == EI; }) !=\n+               count_if(E->UserTreeIndex.UserTE->Scalars,\n+                        [&](Value *V) { return V == EI; })) ||\n           (NumParts != 1 && count(VL, EI) > 1) ||\n           any_of(EI->users(), [&](User *U) {\n             ArrayRef<TreeEntry *> UTEs = R.getTreeEntries(U);\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/extract-used-in-many-nodes.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=x86_64-unknown-linux-gnu < %s"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\ndefine i1 @test() {\n;\nentry:\n  %e0 = extractelement <4 x float> splat (float 0.0), i64 0\n  %c1 = fpext float %e0 to double\n  %m1 = fmul double 0.0, %c1\n  %s1 = select i1 false, double %m1, double 0.0\n  %r1 = fcmp olt double %s1, 0.0\n\n  %c2 = fpext float 0.0 to double\n  %m2 = fmul double 0.0, %c2\n  %s2 = select i1 false, double %m2, double 0.0\n  %r2 = fcmp olt double %s2, 0.0\n\n  %e1 = extractelement <4 x float> splat (float 1.0), i64 0\n  %c3 = fpext float %e1 to double\n  %m3 = fmul double 0.0, %c3\n  %s3 = select i1 false, double %m3, double 0.0\n  %r3 = fcmp olt double %s3, 0.0\n\n  %e2 = extractelement <4 x float> splat (float 2.0), i64 0\n  %c4 = fpext float %e2 to double\n  %m4 = fmul double 0.0, %c4\n  %s4 = select i1 false, double %m4, double 0.0\n  %r4 = fcmp olt double %s4, 0.0\n\n  %e3 = extractelement <4 x float> splat (float 3.0), i64 0\n  %c5 = fpext float %e3 to double\n  %m5 = fmul double 0.0, %c5\n  %s5 = select i1 false, double %m5, double 0.0\n  %r5 = fcmp olt double %s5, 0.0\n\n  %e4 = extractelement <4 x float> splat (float 4.0), i64 0\n  %c6 = fpext float %e4 to double\n  %m6 = fmul double 0.0, %c6\n  %s6 = select i1 false, double %m6, double 0.0\n  %r6 = fcmp olt double %s6, 0.0\n\n  %e5 = extractelement <4 x float> splat (float 5.0), i64 0\n  %c7 = fpext float %e5 to double\n  %m7 = fmul double 0.0, %c7\n  %s7 = select i1 false, double %m7, double 0.0\n  %r7 = fcmp olt double %s7, 0.0\n\n  %m8 = fmul double 0.0, %c1\n  %s8 = select i1 false, double %m8, double 0.0\n  %r8 = fcmp olt double %s8, 0.0\n\n  ret i1 %r8\n}"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SLPVectorizer] Assertion failure: \"trying to erase instruction with users\" in BoUpSLP destructor",
    "body": "**Description**\n\nThe SLP Vectorizer crashes with an assertion failure when vectorizing code containing a specific pattern of extractelement \u2192 fpext \u2192 fmul \u2192 select \u2192 fcmp chains.\nThe assertion I->use_empty() && \"trying to erase instruction with users.\" fails in BoUpSLP::~BoUpSLP() because an extractelement instruction is marked for deletion but still has live users (an insertelement instruction that was not marked for deletion).\n\nWhen assertions are disabled, this leads to a segfault in the VectorCombine pass.\n\n**Reproducer**\nMinimal LLVM IR (75 lines):\n```\n; Minimal reproducer for SLP Vectorizer assertion failure\n; Run: opt -passes='slp-vectorizer' crash.ll -o /dev/null\n\ntarget datalayout = \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\ndefine i1 @slp_crash() {\nentry:\n  %e0 = extractelement <4 x float> splat (float 0.0), i64 0\n  %c1 = fpext float %e0 to double\n  %m1 = fmul double 0.0, %c1\n  %s1 = select i1 false, double %m1, double 0.0\n  %r1 = fcmp olt double %s1, 0.0\n\n  %c2 = fpext float 0.0 to double\n  %m2 = fmul double 0.0, %c2\n  %s2 = select i1 false, double %m2, double 0.0\n  %r2 = fcmp olt double %s2, 0.0\n\n  %e1 = extractelement <4 x float> splat (float 1.0), i64 0\n  %c3 = fpext float %e1 to double\n  %m3 = fmul double 0.0, %c3\n  %s3 = select i1 false, double %m3, double 0.0\n  %r3 = fcmp olt double %s3, 0.0\n\n  %e2 = extractelement <4 x float> splat (float 2.0), i64 0\n  %c4 = fpext float %e2 to double\n  %m4 = fmul double 0.0, %c4\n  %s4 = select i1 false, double %m4, double 0.0\n  %r4 = fcmp olt double %s4, 0.0\n\n  %e3 = extractelement <4 x float> splat (float 3.0), i64 0\n  %c5 = fpext float %e3 to double\n  %m5 = fmul double 0.0, %c5\n  %s5 = select i1 false, double %m5, double 0.0\n  %r5 = fcmp olt double %s5, 0.0\n\n  %e4 = extractelement <4 x float> splat (float 4.0), i64 0\n  %c6 = fpext float %e4 to double\n  %m6 = fmul double 0.0, %c6\n  %s6 = select i1 false, double %m6, double 0.0\n  %r6 = fcmp olt double %s6, 0.0\n\n  %e5 = extractelement <4 x float> splat (float 5.0), i64 0\n  %c7 = fpext float %e5 to double\n  %m7 = fmul double 0.0, %c7\n  %s7 = select i1 false, double %m7, double 0.0\n  %r7 = fcmp olt double %s7, 0.0\n\n  %m8 = fmul double 0.0, %c1\n  %s8 = select i1 false, double %m8, double 0.0\n  %r8 = fcmp olt double %s8, 0.0\n\n  ret i1 %r8\n}\n```\n**Steps to Reproduce**\n```opt -passes='slp-vectorizer' crash.ll -o /dev/null```\n\n**Stack Trace**\n```opt: llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:6230: \n  llvm::slpvectorizer::BoUpSLP::~BoUpSLP(): \n  Assertion `I->use_empty() && \"trying to erase instruction with users.\"' failed.\n\nStack dump:\n0.  Program arguments: opt -passes=slp-vectorizer crash.ll -o /dev/null\n1.  Running pass \"function(slp-vectorizer)\" on module \"crash.ll\"\n2.  Running pass \"slp-vectorizer\" on function \"slp_crash\"\n #9  llvm::slpvectorizer::BoUpSLP::~BoUpSLP()\n#10  llvm::SLPVectorizerPass::runImpl(...)\n#11  llvm::SLPVectorizerPass::run(...)\n```\n\n**Environment**\nLLVM version: trunk (commit 96891b73a95c)\nTarget: x86_64-unknown-linux-gnu",
    "author": "saurabhk",
    "labels": [
      "llvm:SLPVectorizer",
      "crash-on-valid"
    ],
    "comments": [
      {
        "author": "saurabhk",
        "body": "FYI @RKSimon @alexey-bataev "
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}