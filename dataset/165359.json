{
  "bug_id": "165359",
  "issue_url": "https://github.com/llvm/llvm-project/issues/165359",
  "bug_type": "crash",
  "base_commit": "6a0ba8b7a4176bbc78f4dcff4f21bae1e2097d67",
  "knowledge_cutoff": "2025-10-28T08:46:02Z",
  "lit_test_dir": [
    "llvm/test/Transforms/LoopVectorize"
  ],
  "hints": {
    "fix_commit": "a04c6b5512bf091b4eec6c4f7dbfaaf44b290906",
    "components": [
      "LoopVectorize"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/LoopVectorize.cpp": [
        [
          4018,
          4023
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/LoopVectorize.cpp": [
        "LoopVectorizationPlanner::emitInvalidCostRemarks"
      ]
    }
  },
  "patch": "commit a04c6b5512bf091b4eec6c4f7dbfaaf44b290906\nAuthor: Ryan Buchner <buchner.ryan@gmail.com>\nDate:   Thu Nov 13 08:12:40 2025 -0800\n\n    [LV] Update LoopVectorizationPlanner::emitInvalidCostRemarks to handle reduction plans (#165913)\n    \n    The TypeSwitch for extracting the Opcode now handles the `VPReductionRecipe` case.\n    \n    Fixes #165359.\n\ndiff --git a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\nindex 835b0995cc4f..f4629d22002d 100644\n--- a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n+++ b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n@@ -4018,6 +4018,9 @@ void LoopVectorizationPlanner::emitInvalidCostRemarks(\n             .Case<VPInterleaveRecipe>([](const VPInterleaveRecipe *R) {\n               return R->getStoredValues().empty() ? Instruction::Load\n                                                   : Instruction::Store;\n+            })\n+            .Case<VPReductionRecipe>([](const auto *R) {\n+              return RecurrenceDescriptor::getOpcode(R->getRecurrenceKind());\n             });\n \n     // If the next recipe is different, or if there are no other pairs,\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/LoopVectorize/AArch64/bug165359.ll",
      "commands": [
        "opt < %s -passes=loop-vectorize -S -pass-remarks-analysis=loop-vectorize -disable-output"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "\n\ntarget triple = \"aarch64-unknown-linux-gnu\"\n\ndefine double @reduce_fail(i64 %loop_count, double %d0, ptr %ptr1) #0 {\nentry:\n  %d1 = load double, ptr %ptr1\n  br label %loop\n\nloop:\n  %acc0 = phi double [ %fadd0, %loop ], [ %d0, %entry ]\n  %iv = phi i64 [ 0, %entry ], [ %iv.next, %loop ]\n  %fadd0 = fadd double %acc0, %d1\n  %iv.next = add nsw nuw i64 %iv, 1\n  %exit_cond = icmp eq i64 %iv.next, %loop_count\n  br i1 %exit_cond, label %loopexit, label %loop\n\nloopexit:\n  ret double %fadd0\n}\n\nattributes #0 = { \"target-features\"=\"+sve\" }"
        }
      ]
    }
  ],
  "issue": {
    "title": "[LV][SVE] Crashed when optimization remarks are enabled: \"Fell off the end of a type-switch\"",
    "body": "Some Fortran benchmarks (e.g., SPEC2017 and NPB) fail to compile when optimization remarks are enabled.\nThe following is a reproducer.\n\n```\n$ cat repro.f90\nsubroutine repro(iter, v, sum)\n  implicit none\n\n  integer iter, i, m\n  double precision  v(5), sum(5)\n\n  do i = 1, iter\n    do m = 1, 5\n      sum(m) = sum(m) + v(m)\n    end do\n  end do\nend subroutine\n$ flang -O2 -march=armv8-a+sve repro.f90 -Rpass=vector\nFell off the end of a type-switch\nUNREACHABLE executed at /path/to/llvm-project/llvm/include/llvm/ADT/TypeSwitch.h:126!\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.      Program arguments: /path/to/build/bin/flang -fc1 -triple aarch64-unknown-linux-gnu -emit-obj -fcolor-diagnostics -mrelocation-model pic -pic-level 2 -pic-is-pie -target-cpu generic -target-feature +outline-atomics -target-feature +v8a -target-feature +fp-armv8 -target-feature +fullfp16 -target-feature +neon -target-feature +sve -vectorize-loops -vectorize-slp -Rpass=vector -resource-dir /path/to/build/lib/clang/22 -mframe-pointer=non-leaf -O2 -o /tmp/repro-737c08.o -x f95 repro.f90\n1.      Running pass \"function<eager-inv>(drop-unnecessary-assumes,float2int,lower-constant-intrinsics,loop(loop-rotate<header-duplication;no-prepare-for-lto>,loop-deletion),loop-distribute,inject-tli-mappings,loop-vectorize<no-interleave-forced-only;no-vectorize-forced-only;>,infer-alignment,loop-load-elim,instcombine<max-iterations=1;no-verify-fixpoint>,simplifycfg<bonus-inst-threshold=1;forward-switch-cond;switch-range-to-icmp;switch-to-arithmetic;switch-to-lookup;no-keep-loops;hoist-common-insts;no-hoist-loads-stores-with-cond-faulting;sink-common-insts;speculate-blocks;simplify-cond-branch;no-speculate-unpredictables>,slp-vectorizer,vector-combine,instcombine<max-iterations=1;no-verify-fixpoint>,loop-unroll<O2>,transform-warning,sroa<preserve-cfg>,infer-alignment,instcombine<max-iterations=1;no-verify-fixpoint>,loop-mssa(licm<allowspeculation>),alignment-from-assumptions,loop-sink,instsimplify,div-rem-pairs,tailcallelim,simplifycfg<bonus-inst-threshold=1;no-forward-switch-cond;switch-range-to-icmp;switch-to-arithmetic;no-switch-to-lookup;keep-loops;no-hoist-common-insts;hoist-loads-stores-with-cond-faulting;no-sink-common-insts;speculate-blocks;simplify-cond-branch;speculate-unpredictables>)\" on module \"FIRModule\"\n2.      Running pass \"loop-vectorize<no-interleave-forced-only;no-vectorize-forced-only;>\" on function \"repro_\"\n #0 0x0000ffff71b64710 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/path/to/build/lib/libLLVM.so.22.0git+0xa8f710)\n #1 0x0000ffff71b61c9c llvm::sys::RunSignalHandlers() (/path/to/build/lib/libLLVM.so.22.0git+0xa8cc9c)\n #2 0x0000ffff71b61df4 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n #3 0x0000ffff86f6d7f0 (linux-vdso.so.1+0x7f0)\n #4 0x0000ffff70cb37b8 __pthread_kill_implementation /usr/src/debug/glibc-2.34-168.el9_6.23.aarch64/nptl/pthread_kill.c:44:76\n #5 0x0000ffff70c6bb3c gsignal /usr/src/debug/glibc-2.34-168.el9_6.23.aarch64/signal/../sysdeps/posix/raise.c:27:6\n #6 0x0000ffff70c58074 abort /usr/src/debug/glibc-2.34-168.el9_6.23.aarch64/stdlib/abort.c:81:7\n #7 0x0000ffff71a7694c (/path/to/build/lib/libLLVM.so.22.0git+0x9a194c)\n #8 0x0000ffff736ff774 llvm::LoopVectorizationPlanner::emitInvalidCostRemarks(llvm::OptimizationRemarkEmitter*) (/path/to/build/lib/libLLVM.so.22.0git+0x262a774)\n #9 0x0000ffff73708cf8 llvm::LoopVectorizePass::processLoop(llvm::Loop*) (/path/to/build/lib/libLLVM.so.22.0git+0x2633cf8)\n#10 0x0000ffff7370b27c llvm::LoopVectorizePass::runImpl(llvm::Function&) (/path/to/build/lib/libLLVM.so.22.0git+0x263627c)\n#11 0x0000ffff7370b80c llvm::LoopVectorizePass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/path/to/build/lib/libLLVM.so.22.0git+0x263680c)\n  :\n#28 0x000000000081c2b0 _start (/path/to/build/bin/flang+0x81c2b0)\nflang-22: error: unable to execute command: Aborted (core dumped)\nflang-22: error: flang frontend command failed due to signal (use -v to see invocation)\nflang version 22.0.0git (https://github.com/llvm/llvm-project.git c8f5c602c897d2345c1cfd8d886c1325598dbdc6)\nTarget: aarch64-unknown-linux-gnu\nThread model: posix\nInstalledDir: /path/to/build/bin\nBuild config: +assertions\n```\n\nThe input IR: https://godbolt.org/z/z1P6Wxj7d",
    "author": "yus3710-fj",
    "labels": [
      "vectorizers",
      "crash"
    ],
    "comments": [
      {
        "author": "bababuck",
        "body": "Don't see anyone working on this, will take a look."
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}