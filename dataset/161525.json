{
  "bug_id": "161525",
  "issue_url": "https://github.com/llvm/llvm-project/issues/161525",
  "bug_type": "miscompilation",
  "base_commit": "c4709823bb82cb4b6ca2675ef69b1a0e02e3f58e",
  "knowledge_cutoff": "2025-10-01T14:16:31Z",
  "lit_test_dir": [
    "llvm/test/Transforms/InstCombine"
  ],
  "hints": {
    "fix_commit": "0b7129afccc8e79fb88bb686466211f3bcad142e",
    "components": [
      "InstCombine"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp": [
        [
          8527,
          8532
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp": [
        "foldFCmpFSubIntoFCmp"
      ]
    }
  },
  "patch": "commit 0b7129afccc8e79fb88bb686466211f3bcad142e\nAuthor: Yingwei Zheng <dtcxzyw2333@gmail.com>\nDate:   Fri Oct 3 01:44:03 2025 +0800\n\n    [InstCombine] Fix FMF propagation in `foldFCmpFSubIntoFCmp` (#161539)\n    \n    Proof: https://alive2.llvm.org/ce/z/orSP-S\n    Closes https://github.com/llvm/llvm-project/issues/161525.\n\ndiff --git a/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp b/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\nindex e4cb457499ef..60da48e1d95d 100644\n--- a/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\n+++ b/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp\n@@ -8527,6 +8527,9 @@ static Instruction *foldFCmpFSubIntoFCmp(FCmpInst &I, Instruction *LHSI,\n             DenormalMode::getIEEE()) {\n       CI.replaceOperand(I, 0, X);\n       CI.replaceOperand(I, 1, Y);\n+      I.setHasNoInfs(LHSI->hasNoInfs());\n+      if (LHSI->hasNoNaNs())\n+        I.setHasNoNaNs(true);\n       return &I;\n     }\n     break;\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/InstCombine/fcmp.ll",
      "commands": [
        "opt -S -passes=instcombine < %s"
      ],
      "tests": [
        {
          "test_name": "fcmp_ninf_ule_fsub_const",
          "test_body": "define i1 @fcmp_ninf_ule_fsub_const(float %x, float %y) {\n  %fs = fsub float %x, %y\n  %cmp = fcmp ninf ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "fcmp_ule_fsub_ninf_const",
          "test_body": "define i1 @fcmp_ule_fsub_ninf_const(float %x, float %y) {\n  %fs = fsub ninf float %x, %y\n  %cmp = fcmp ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "fcmp_ule_fsub_nnan_const",
          "test_body": "define i1 @fcmp_ule_fsub_nnan_const(float %x, float %y) {\n  %fs = fsub nnan float %x, %y\n  %cmp = fcmp ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "fcmp_nnan_ule_fsub_const",
          "test_body": "define i1 @fcmp_nnan_ule_fsub_const(float %x, float %y) {\n  %fs = fsub float %x, %y\n  %cmp = fcmp nnan ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "fcmp_ugt_fsub_const",
          "test_body": "define i1 @fcmp_ugt_fsub_const(float %x, float %y) {\n  %fs = fsub float %x, %y\n  %cmp = fcmp ugt float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        },
        {
          "test_name": "fcmp_ule_fsub_const",
          "test_body": "define i1 @fcmp_ule_fsub_const(float %x, float %y) {\n  %fs = fsub float %x, %y\n  %cmp = fcmp ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[InstCombine] `ninf` should not be propagated when folding `fcmp pred, x - y, 0` to `fcmp pred, x, y`",
    "body": "Reproducer: https://alive2.llvm.org/ce/z/ZHW6-B\n```\n; bin/opt -passes=instcombine test.ll -S\ndefine i1 @src1(float %x, float %y) {\n  %fs = fsub float %x, %y\n  %cmp = fcmp ninf ule float %fs, 0.000000e+00\n  ret i1 %cmp\n}\n```\n```\n=>\ndefine i1 @src1(float %x, float %y) {\n#0:\n  %cmp = fcmp ninf ule float %x, %y\n  ret i1 %cmp\n}\nTransformation doesn't verify!\n\nERROR: Target is more poisonous than source\n\nExample:\nfloat %x = #x7f800000 (+oo)\nfloat %y = #x7f800080 (SNaN)\n\nSource:\nfloat %fs = #xffc00003 (QNaN)\ni1 %cmp = #x1 (1)\n\nTarget:\ni1 %cmp = poison\nSource value: #x1 (1)\nTarget value: poison\n```\n",
    "author": "dtcxzyw",
    "labels": [
      "miscompilation",
      "llvm:instcombine",
      "floating-point",
      "generated by fuzzer"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  }
}