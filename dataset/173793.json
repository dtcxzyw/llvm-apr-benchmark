{
  "bug_id": "173793",
  "issue_url": "https://github.com/llvm/llvm-project/issues/173793",
  "bug_type": "miscompilation",
  "base_commit": "e4722c69b87f294daf36cd67fd0b544defe52ba1",
  "knowledge_cutoff": "2025-12-28T19:04:16Z",
  "lit_test_dir": [
    "llvm/test/Transforms/InstCombine"
  ],
  "hints": {
    "fix_commit": "144dc7464fcfde796401acf7784e084d0e66d15c",
    "components": [
      "InstCombine"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp": [
        [
          1105,
          1112
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp": [
        "InstCombinerImpl::SimplifyDemandedUseBits"
      ]
    }
  },
  "patch": "commit 144dc7464fcfde796401acf7784e084d0e66d15c\nAuthor: Yunbo Ni <ybni@cse.cuhk.edu.hk>\nDate:   Tue Dec 30 00:05:49 2025 +0800\n\n    [InstCombine] Drop range metadata when simplifying `fshl` with demanded bits (#173864)\n    \n    InstCombine may rewrite `llvm.fshl` operands when simplifying based on\n    demanded bits, which can invalidate previously attached return value\n    constraints. Except from range attribute, `!range` metadata could also\n    be not dropped after operand rewriting, leading to stale\n    poison-generating metadata and potential miscompilations.\n    \n    This patch drops poison-generating annotations when `fshl` operands are\n    simplified, ensuring that `!range` metadata is cleared consistently with\n    return attributes.\n    \n    Alive2 proof: https://alive2.llvm.org/ce/z/EVUvY6\n    \n    Fixes #173793\n\ndiff --git a/llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp b/llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp\nindex 519e32157207..45fa8ee8b33a 100644\n--- a/llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp\n+++ b/llvm/lib/Transforms/InstCombine/InstCombineSimplifyDemanded.cpp\n@@ -1105,8 +1105,8 @@ Value *InstCombinerImpl::SimplifyDemandedUseBits(Instruction *I,\n                                    Depth + 1) ||\n               SimplifyDemandedBits(I, 1, DemandedMaskRHS, RHSKnown, Q,\n                                    Depth + 1)) {\n-            // Range attribute may no longer hold.\n-            I->dropPoisonGeneratingReturnAttributes();\n+            // Range attribute or metadata may no longer hold.\n+            I->dropPoisonGeneratingAnnotations();\n             return I;\n           }\n         } else { // fshl is a rotate\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/InstCombine/fsh.ll",
      "commands": [
        "opt < %s -passes=instcombine -S"
      ],
      "tests": [
        {
          "test_name": "fshl_range_vec",
          "test_body": "define <2 x i8> @fshl_range_vec(<2 x i1> %x) {\n  %zext = zext <2 x i1> %x to <2 x i32>\n  %or = or disjoint <2 x i32> %zext, splat (i32 -2)\n  %fshl = call <2 x i32> @llvm.fshl.v2i32(<2 x i32> %or, <2 x i32> splat (i32 -2), <2 x i32> splat (i32 1)), !range !0\n  %tr = trunc <2 x i32> %fshl to <2 x i8>\n  ret <2 x i8> %tr\n}\n\n; Function Attrs: nocallback nofree nosync nounwind speculatable willreturn memory(none)\ndeclare <2 x i32> @llvm.fshl.v2i32(<2 x i32>, <2 x i32>, <2 x i32>) #0\n\nattributes #0 = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }\n\n!0 = !{i32 -4, i32 2}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[InstCombine] Vector `fshl` retains invalid `range` after demanded-bits simplification",
    "body": "In https://github.com/llvm/llvm-project/pull/124429, the patch correctly drops `range` for scalar `fshl` when operands are simplified based on demanded bits, but it does not consistently do so for vector `fshl`.\n\nIn the vector case, `SimplifyDemandedBits` can still change the operands such that the original `range` no longer holds, yet the `range` attribute is preserved, causing the `fshl` result to become poison.\n\nFor example, we have this vector case:\n\n```llvm\n%zext = zext <2 x i1> %x to <2 x i32>\n%or   = or disjoint <2 x i32> %zext, <i32 -2, i32 -2>\n%fshl = call <2 x i32> @llvm.fshl.v2i32(\n           <2 x i32> %or,\n           <2 x i32> <i32 -2, i32 -2>,\n           <2 x i32> <i32 1,  i32 1>),\n         !range !{i32 -4, i32 2}\n%tr   = trunc <2 x i32> %fshl to <2 x i8>\n```\n\nAfter demanded-bits simplification, `%or` is rewritten to `<126, 126>`, which changes the result of fshl to `<253, 253>`.\n\nHowever, the original `range [-4, 2)` attribute is still preserved on the vector `fshl`, even though the new value clearly violates it. As a result, the `fshl` produces `poison`. \n\nAlive2 proof: https://alive2.llvm.org/ce/z/JTXAYD\n\nExposed from https://github.com/llvm/llvm-project/commit/2131115be5b9d8b39af80973d9b64c0adc41d38d, cc @MaskRay ",
    "author": "cardigan1008",
    "labels": [
      "miscompilation",
      "llvm:instcombine"
    ],
    "comments": [
      {
        "author": "cardigan1008",
        "body": "I can propose a patch for this. Please assign it to me, thanks. "
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}