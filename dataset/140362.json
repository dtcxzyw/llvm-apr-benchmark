{
  "bug_id": "140362",
  "issue_url": "https://github.com/llvm/llvm-project/issues/140362",
  "bug_type": "crash",
  "base_commit": "a0ed47dad9b0639622495d31d4a5f4063e9c9a5c",
  "knowledge_cutoff": "2025-05-17T07:32:59Z",
  "lit_test_dir": [
    "llvm/test/DebugInfo"
  ],
  "hints": {
    "fix_commit": "592cdbdfcb03a69c10b1666b85da27afc37dd1ff",
    "components": [],
    "bug_location_lineno": {
      "llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp": [
        [
          240,
          245
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp": [
        "DebugHandlerBase::isUnsignedDIType"
      ]
    }
  },
  "patch": "commit 592cdbdfcb03a69c10b1666b85da27afc37dd1ff\nAuthor: Orlando Cazalet-Hyams <orlando.hyams@sony.com>\nDate:   Tue Oct 7 08:54:42 2025 +0100\n\n    [DWARF] Ignore DW_ATE_lo_user to hi_user in DebugHandlerBase assertion (#161695)\n    \n    Fixes #140362\n\ndiff --git a/llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp b/llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp\nindex d98d18035ac6..dc38f5a6887c 100644\n--- a/llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp\n+++ b/llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp\n@@ -240,6 +240,8 @@ bool DebugHandlerBase::isUnsignedDIType(const DIType *Ty) {\n           Encoding == dwarf::DW_ATE_complex_float ||\n           Encoding == dwarf::DW_ATE_signed_fixed ||\n           Encoding == dwarf::DW_ATE_unsigned_fixed ||\n+          (Encoding >= dwarf::DW_ATE_lo_user &&\n+           Encoding <= dwarf::DW_ATE_hi_user) ||\n           (Ty->getTag() == dwarf::DW_TAG_unspecified_type &&\n            Ty->getName() == \"decltype(nullptr)\")) &&\n          \"Unsupported encoding\");\n",
  "tests": [
    {
      "file": "llvm/test/DebugInfo/dwarf-complex-int.ll",
      "commands": [
        "%llc_dwarf %s -filetype=obj -o - | llvm-dwarfdump -"
      ],
      "tests": [
        {
          "test_name": "<module>",
          "test_body": "; REQUIRES: object-emission\n\n;; https://github.com/llvm/llvm-project/issues/140362\n;; Don't assert when emitting a complex integer type in DWARF.\n\n;; C source:\n;; int g;\n;;\n;; void foo(_Complex short c) { __builtin_memmove(&g, (char *)&c, 2); }\n;;\n;; void bar() { foo(0); }\n\n\n\n@g = dso_local local_unnamed_addr global i32 0, align 4, !dbg !0\n\ndefine dso_local void @bar() local_unnamed_addr !dbg !18 {\nentry:\n    #dbg_value(i32 0, !21, !DIExpression(), !27)\n  store i16 0, ptr @g, align 4, !dbg !29\n  ret void, !dbg !30\n}\n\n!llvm.dbg.cu = !{!2}\n!llvm.module.flags = !{!10, !11}\n!llvm.ident = !{!17}\n\n!0 = !DIGlobalVariableExpression(var: !1, expr: !DIExpression())\n!1 = distinct !DIGlobalVariable(name: \"g\", scope: !2, file: !8, line: 1, type: !9, isLocal: false, isDefinition: true)\n!2 = distinct !DICompileUnit(language: DW_LANG_C_plus_plus_14, file: !3, producer: \"clang version 22.0.0git\", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, retainedTypes: !4, globals: !7, splitDebugInlining: false, nameTableKind: None)\n!3 = !DIFile(filename: \"/app/example.cpp\", directory: \"/app\")\n!4 = !{!5}\n!5 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !6, size: 64)\n!6 = !DIBasicType(name: \"char\", size: 8, encoding: DW_ATE_signed_char)\n!7 = !{!0}\n!8 = !DIFile(filename: \"example.cpp\", directory: \"/app\")\n!9 = !DIBasicType(name: \"int\", size: 32, encoding: DW_ATE_signed)\n!10 = !{i32 7, !\"Dwarf Version\", i32 5}\n!11 = !{i32 2, !\"Debug Info Version\", i32 3}\n!17 = !{!\"clang version 22.0.0git\"}\n!18 = distinct !DISubprogram(name: \"bar\", linkageName: \"bar()\", scope: !8, file: !8, line: 5, type: !19, scopeLine: 5, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, keyInstructions: true)\n!19 = !DISubroutineType(types: !20)\n!20 = !{null}\n!21 = !DILocalVariable(name: \"c\", arg: 1, scope: !22, file: !8, line: 3, type: !25)\n!22 = distinct !DISubprogram(name: \"foo\", linkageName: \"_ZL3fooCs\", scope: !8, file: !8, line: 3, type: !23, scopeLine: 3, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagLocalToUnit | DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !26, keyInstructions: true)\n!23 = !DISubroutineType(types: !24)\n!24 = !{null, !25}\n!25 = !DIBasicType(name: \"complex\", size: 32, encoding: 128)\n!26 = !{!21}\n!27 = !DILocation(line: 0, scope: !22, inlinedAt: !28)\n!28 = distinct !DILocation(line: 5, column: 14, scope: !18)\n!29 = !DILocation(line: 3, column: 37, scope: !22, inlinedAt: !28, atomGroup: 1, atomRank: 1)\n!30 = !DILocation(line: 5, column: 22, scope: !18, atomGroup: 1, atomRank: 1)"
        }
      ]
    }
  ],
  "issue": {
    "title": "[DebugInfo] Assertion in llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp",
    "body": "Reproducer:\nhttps://godbolt.org/z/EKT8z533K\n```c\nint g;\n\nvoid foo(_Complex short c) { __builtin_memmove(&g, (char *)&c, 2); }\n\nvoid bar() { foo(0); }\n```\n\nThe original reproducer of this issue is the following:\nhttps://github.com/gcc-mirror/gcc/blob/master/gcc/testsuite/gcc.dg/pr116034.c\n\nBacktrace:\n```console\nclang: /root/llvm-project/llvm/lib/CodeGen/AsmPrinter/DebugHandlerBase.cpp:232: static bool llvm::DebugHandlerBase::isUnsignedDIType(const llvm::DIType*): Assertion `(Encoding == dwarf::DW_ATE_unsigned || Encoding == dwarf::DW_ATE_unsigned_char || Encoding == dwarf::DW_ATE_signed || Encoding == dwarf::DW_ATE_signed_char || Encoding == dwarf::DW_ATE_float || Encoding == dwarf::DW_ATE_UTF || Encoding == dwarf::DW_ATE_boolean || Encoding == dwarf::DW_ATE_complex_float || Encoding == dwarf::DW_ATE_signed_fixed || Encoding == dwarf::DW_ATE_unsigned_fixed || (Ty->getTag() == dwarf::DW_TAG_unspecified_type && Ty->getName() == \"decltype(nullptr)\")) && \"Unsupported encoding\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace, preprocessed source, and associated run script.\nStack dump:\n0.\tProgram arguments: /opt/compiler-explorer/clang-assertions-trunk/bin/clang -gdwarf-4 -g -o /app/output.s -mllvm --x86-asm-syntax=intel -fno-verbose-asm -S --gcc-toolchain=/opt/compiler-explorer/gcc-snapshot -fcolor-diagnostics -fno-crash-diagnostics -g -O1 <source>\n1.\t<eof> parser at end of file\n2.\tCode generation\n3.\tRunning pass 'Function Pass Manager' on module '<source>'.\n4.\tRunning pass 'X86 Assembly Printer' on function '@bar'\n #0 0x0000000003f9bf28 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x3f9bf28)\n #1 0x0000000003f99bb4 llvm::sys::CleanupOnSignal(unsigned long) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x3f99bb4)\n #2 0x0000000003ede7e8 CrashRecoverySignalHandler(int) CrashRecoveryContext.cpp:0:0\n #3 0x000079103e042520 (/lib/x86_64-linux-gnu/libc.so.6+0x42520)\n #4 0x000079103e0969fc pthread_kill (/lib/x86_64-linux-gnu/libc.so.6+0x969fc)\n #5 0x000079103e042476 gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x42476)\n #6 0x000079103e0287f3 abort (/lib/x86_64-linux-gnu/libc.so.6+0x287f3)\n #7 0x000079103e02871b (/lib/x86_64-linux-gnu/libc.so.6+0x2871b)\n #8 0x000079103e039e96 (/lib/x86_64-linux-gnu/libc.so.6+0x39e96)\n #9 0x0000000004f200d3 llvm::DebugHandlerBase::isUnsignedDIType(llvm::DIType const*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4f200d3)\n#10 0x0000000004f66199 llvm::DwarfUnit::addConstantValue(llvm::DIE&, unsigned long, llvm::DIType const*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4f66199)\n#11 0x0000000004fc4fbb llvm::DwarfCompileUnit::applyConcreteDbgVariableAttributes(llvm::Loc::Single const&, llvm::DbgVariable const&, llvm::DIE&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4fc4fbb)\n#12 0x0000000004fc3fa8 llvm::DwarfCompileUnit::constructVariableDIE(llvm::DbgVariable&, llvm::LexicalScope const&, llvm::DIE*&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4fc3fa8)\n#13 0x0000000004fc935a llvm::DwarfCompileUnit::createAndAddScopeChildren(llvm::LexicalScope*, llvm::DIE&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4fc935a)\n#14 0x0000000004fca918 llvm::DwarfCompileUnit::createAndAddScopeChildren(llvm::LexicalScope*, llvm::DIE&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4fca918)\n#15 0x0000000004fcb516 llvm::DwarfCompileUnit::constructSubprogramScopeDIE(llvm::DISubprogram const*, llvm::LexicalScope*, llvm::MCSymbol*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4fcb516)\n#16 0x0000000004f58e62 llvm::DwarfDebug::endFunctionImpl(llvm::MachineFunction const*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4f58e62)\n#17 0x0000000004f1d267 llvm::DebugHandlerBase::endFunction(llvm::MachineFunction const*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4f1d267)\n#18 0x0000000004f16f28 llvm::AsmPrinter::emitFunctionBody() (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4f16f28)\n#19 0x00000000028e93ee llvm::X86AsmPrinter::runOnMachineFunction(llvm::MachineFunction&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x28e93ee)\n#20 0x00000000032bd50a llvm::MachineFunctionPass::runOnFunction(llvm::Function&) (.part.0) MachineFunctionPass.cpp:0:0\n#21 0x00000000038df2cf llvm::FPPassManager::runOnFunction(llvm::Function&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x38df2cf)\n#22 0x00000000038df681 llvm::FPPassManager::runOnModule(llvm::Module&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x38df681)\n#23 0x00000000038dff21 llvm::legacy::PassManagerImpl::run(llvm::Module&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x38dff21)\n#24 0x0000000004258f3e clang::emitBackendOutput(clang::CompilerInstance&, clang::CodeGenOptions&, llvm::StringRef, llvm::Module*, clang::BackendAction, llvm::IntrusiveRefCntPtr<llvm::vfs::FileSystem>, std::unique_ptr<llvm::raw_pwrite_stream, std::default_delete<llvm::raw_pwrite_stream>>, clang::BackendConsumer*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4258f3e)\n#25 0x00000000049474f0 clang::BackendConsumer::HandleTranslationUnit(clang::ASTContext&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x49474f0)\n#26 0x000000000663381c clang::ParseAST(clang::Sema&, bool, bool) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x663381c)\n#27 0x00000000049478f8 clang::CodeGenAction::ExecuteAction() (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x49478f8)\n#28 0x0000000004c3f825 clang::FrontendAction::Execute() (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4c3f825)\n#29 0x0000000004bbe4ee clang::CompilerInstance::ExecuteAction(clang::FrontendAction&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4bbe4ee)\n#30 0x0000000004d32309 clang::ExecuteCompilerInvocation(clang::CompilerInstance*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4d32309)\n#31 0x0000000000daceaf cc1_main(llvm::ArrayRef<char const*>, char const*, void*) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0xdaceaf)\n#32 0x0000000000da307a ExecuteCC1Tool(llvm::SmallVectorImpl<char const*>&, llvm::ToolContext const&) driver.cpp:0:0\n#33 0x00000000049aebe9 void llvm::function_ref<void ()>::callback_fn<clang::driver::CC1Command::Execute(llvm::ArrayRef<std::optional<llvm::StringRef>>, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>*, bool*) const::'lambda'()>(long) Job.cpp:0:0\n#34 0x0000000003edec84 llvm::CrashRecoveryContext::RunSafely(llvm::function_ref<void ()>) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x3edec84)\n#35 0x00000000049af1ff clang::driver::CC1Command::Execute(llvm::ArrayRef<std::optional<llvm::StringRef>>, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>*, bool*) const (.part.0) Job.cpp:0:0\n#36 0x0000000004970fcd clang::driver::Compilation::ExecuteCommand(clang::driver::Command const&, clang::driver::Command const*&, bool) const (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x4970fcd)\n#37 0x000000000497205e clang::driver::Compilation::ExecuteJobs(clang::driver::JobList const&, llvm::SmallVectorImpl<std::pair<int, clang::driver::Command const*>>&, bool) const (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x497205e)\n#38 0x000000000497a345 clang::driver::Driver::ExecuteCompilation(clang::driver::Compilation&, llvm::SmallVectorImpl<std::pair<int, clang::driver::Command const*>>&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0x497a345)\n#39 0x0000000000da8e18 clang_main(int, char**, llvm::ToolContext const&) (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0xda8e18)\n#40 0x0000000000c2e464 main (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0xc2e464)\n#41 0x000079103e029d90 (/lib/x86_64-linux-gnu/libc.so.6+0x29d90)\n#42 0x000079103e029e40 __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e40)\n#43 0x0000000000da2b25 _start (/opt/compiler-explorer/clang-assertions-trunk/bin/clang+0xda2b25)\nclang: error: clang frontend command failed with exit code 134 (use -v to see invocation)\nCompiler returned: 134\n```",
    "author": "k-arrows",
    "labels": [
      "debuginfo",
      "crash"
    ],
    "comments": [
      {
        "author": "k-arrows",
        "body": "Goes back to clang-13: https://godbolt.org/z/WsGKdecv9 "
      }
    ]
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  }
}