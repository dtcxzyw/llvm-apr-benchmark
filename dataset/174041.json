{
  "bug_id": "174041",
  "issue_url": "https://github.com/llvm/llvm-project/issues/174041",
  "bug_type": "miscompilation",
  "base_commit": "a53dbe29d74dcab17078f9699e4a8c9f02ece0c3",
  "knowledge_cutoff": "2025-12-31T00:06:02Z",
  "lit_test_dir": [
    "llvm/test/Transforms/SLPVectorizer"
  ],
  "hints": {
    "fix_commit": "2541b1870e7c90236b4010eec9a020c048f8beea",
    "components": [
      "SLPVectorizer"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        [
          1217,
          1223
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp": [
        "add"
      ]
    }
  },
  "patch": "commit 2541b1870e7c90236b4010eec9a020c048f8beea\nAuthor: Alexey Bataev <a.bataev@outlook.com>\nDate:   Wed Dec 31 07:22:08 2025 -0800\n\n    [SLP]Mark and incompatible for 'xor %a, 0' operations\n    \n    Xor with 0 is incompatible with and, which resulst in all zero instead\n    of %a\n    \n    https://alive2.llvm.org/ce/z/oEVETS\n    \n    Fixes #174041\n\ndiff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 56f8188112d8..3d98d470387e 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -1217,7 +1217,7 @@ public:\n         break;\n       case Instruction::Xor:\n         if (CIValue.isZero())\n-          InterchangeableMask = XorBIT | OrBIT | AndBIT | SubBIT | AddBIT;\n+          InterchangeableMask = XorBIT | OrBIT | SubBIT | AddBIT;\n         break;\n       default:\n         if (CIValue.isZero())\n",
  "tests": [
    {
      "file": "llvm/test/Transforms/SLPVectorizer/X86/xor-with-zero-and-incompat.ll",
      "commands": [
        "opt -S --passes=slp-vectorizer -mtriple=x86_64-unknown-linux-gnu < %s -slp-threshold=-100"
      ],
      "tests": [
        {
          "test_name": "src_test_xor_and_identity_mismatch",
          "test_body": "define void @src_test_xor_and_identity_mismatch(i32 %a, i32 %b, ptr %dst) {\n  %op1 = xor i32 %a, 0\n  %op2 = and i32 %b, -1\n  store i32 %op1, ptr %dst, align 4\n  %gep = getelementptr i32, ptr %dst, i64 1\n  store i32 %op2, ptr %gep, align 4\n  ret void\n}\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[SLP] Miscompile when vectorizing `xor x, 0` with `and y, -1`",
    "body": "In https://github.com/llvm/llvm-project/commit/1f82553e385f449efee92da3dca43facb4a1ee66, SLPVectorizer may incorrectly vectorize a pair of identity operations `xor x, 0` and `and y, -1` into a single vector and instruction. Because the identity constants differ (0 vs -1), SLP forms a mixed constant vector <0, -1> and emits:\n\n```llvm\nand <2 x i32> <x, y>, <0, -1>\n```\n\nThis forces the first lane to `0` instead of `x`. When the original code stores results separately, this changes observable memory behavior (e.g. with `y = poison`).\n\nAlive2 proof: https://alive2.llvm.org/ce/z/CtTFRH\n\nExposed from https://github.com/llvm/llvm-project/commit/1f82553e385f449efee92da3dca43facb4a1ee66, cc @alexey-bataev ",
    "author": "cardigan1008",
    "labels": [
      "miscompilation",
      "llvm:SLPVectorizer"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}