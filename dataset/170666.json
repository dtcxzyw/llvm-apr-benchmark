{
  "bug_id": "170666",
  "issue_url": "https://github.com/llvm/llvm-project/issues/170666",
  "bug_type": "crash",
  "base_commit": "c456fd83f25276cf5819c2dafc687c78f03b2ab5",
  "knowledge_cutoff": "2025-12-04T14:20:43Z",
  "lit_test_dir": [
    "llvm/test/Transforms/LoopVectorize"
  ],
  "hints": {
    "fix_commit": "f02dc4d19869f91ac967f231abb35e221efba357",
    "components": [
      "LoopVectorize"
    ],
    "bug_location_lineno": {
      "llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp": [
        [
          2149,
          2156
        ]
      ]
    },
    "bug_location_funcname": {
      "llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp": [
        "hoistPreviousBeforeFORUsers"
      ]
    }
  },
  "patch": "commit f02dc4d19869f91ac967f231abb35e221efba357\nAuthor: Florian Hahn <flo@fhahn.com>\nDate:   Thu Dec 4 21:09:16 2025 +0000\n\n    [VPlan] Don't try to hoist multi-defs for first-order recurrences.\n    \n    Currently the hoisting implementation expects single-defs. Bail out on\n    multi-defs (VPInterleaveRecipe), to fix an assertion.\n    \n    Fixes https://github.com/llvm/llvm-project/issues/170666\n\ndiff --git a/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp b/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\nindex 018c2d21bf46..a59c8cf9ea1e 100644\n--- a/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\n+++ b/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\n@@ -2149,8 +2149,13 @@ static bool hoistPreviousBeforeFORUsers(VPFirstOrderRecurrencePHIRecipe *FOR,\n       if (Op == FOR)\n         return false;\n \n-      if (auto *R = NeedsHoisting(Op))\n+      if (auto *R = NeedsHoisting(Op)) {\n+        // Bail out if the recipe defines multiple values.\n+        // TODO: Hoisting such recipes requires additional handling.\n+        if (R->getNumDefinedValues() != 1)\n+          return false;\n         HoistCandidates.push_back(R);\n+      }\n     }\n   }\n \n",
  "tests": [
    {
      "file": "llvm/test/Transforms/LoopVectorize/first-order-recurrence-complex.ll",
      "commands": [
        "opt -passes=loop-vectorize -force-vector-width=4 -force-vector-interleave=1 -enable-interleaved-mem-accesses -S %s"
      ],
      "tests": [
        {
          "test_name": "needs_hoist_interleave_group_op",
          "test_body": "define i8 @needs_hoist_interleave_group_op(ptr noalias %src, ptr %dst, i32 %n) {\nentry:\n  br label %loop\n\nloop:                                             ; preds = %loop, %entry\n  %for.0 = phi i8 [ 0, %entry ], [ %xor, %loop ]\n  %for.1 = phi i8 [ 0, %entry ], [ %fshl1, %loop ]\n  %iv = phi i32 [ 0, %entry ], [ %iv.next, %loop ]\n  %0 = sext i32 %iv to i64\n  %gep = getelementptr i8, ptr %src, i64 %0\n  %fshl = call i8 @llvm.fshl.i8(i8 %for.1, i8 2, i8 3)\n  %fshl1 = call i8 @llvm.fshl.i8(i8 %for.0, i8 3, i8 2)\n  %ld = load i8, ptr %gep, align 1\n  %xor = xor i8 %ld, %fshl\n  %gep1 = getelementptr i8, ptr %gep, i64 1\n  %ld1 = load i8, ptr %gep1, align 1\n  %iv.next = add i32 %iv, 4\n  store i8 %xor, ptr %dst, align 1\n  %ec = icmp slt i32 %iv, 100\n  br i1 %ec, label %loop, label %exit\n\nexit:                                             ; preds = %loop\n  ret i8 %ld1\n}\n\n; Function Attrs: nocallback nofree nosync nounwind speculatable willreturn memory(none)\ndeclare i8 @llvm.fshl.i8(i8, i8, i8) #0\n\nattributes #0 = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }\n"
        }
      ]
    }
  ],
  "issue": {
    "title": "[LV] [VPlan] Assertion in VPlanTransforms.cpp \"only recipes with a single defined value expected\"",
    "body": "Reduced IR t.ll:\n\n```\ntarget datalayout = \"E-m:a-Fi64-i64:64-i128:128-n32:64-S128-v256:256:256-v512:512:512\"\ntarget triple = \"powerpc64-ibm-aix7.2.0.0\"\n\u00a0\n; Function Attrs: mustprogress strictfp\ndefine i32 @_Z14checksumFile_HP4FILEPh(i32 %n) #0 {\nentry:\n\u00a0 br label %for.body\n\u00a0\nfor.body:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ; preds = %for.body, %entry\n\u00a0 %ix2 = phi i8 [ 0, %entry ], [ %xor, %for.body ]\n\u00a0 %ix1 = phi i8 [ 0, %entry ], [ %fshl1, %for.body ]\n\u00a0 %ix = phi i32 [ 0, %entry ], [ %add, %for.body ]\n\u00a0 %0 = sext i32 %ix to i64\n\u00a0 %gep = getelementptr i8, ptr poison, i64 %0\n\u00a0 %fshl = call i8 @llvm.fshl.i8(i8 %ix1, i8 0, i8 0) #2\n\u00a0 %fshl1 = call i8 @llvm.fshl.i8(i8 %ix2, i8 0, i8 0) #2\n\u00a0 %ld = load i8, ptr %gep, align 1\n\u00a0 %xor = xor i8 %ld, %fshl\n\u00a0 %gep1 = getelementptr i8, ptr %gep, i64 1\n\u00a0 %ld1 = load i8, ptr %gep1, align 1\n\u00a0 %add= add i32 %ix, 4\n\u00a0 %cmp = icmp slt i32 %ix, %n\n\u00a0 br i1 %cmp, label %for.body, label %for.end\n\u00a0\nfor.end:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ; preds = %for.body\n\u00a0 ret i32 0\n}\n\u00a0\n; Function Attrs: nocallback nocreateundeforpoison nofree nosync nounwind speculatable willreturn memory(none)\ndeclare i8 @llvm.fshl.i8(i8, i8, i8) #1\n\u00a0\n; uselistorder directives\nuselistorder ptr @llvm.fshl.i8, { 1, 0 }\n\u00a0\nattributes #0 = { mustprogress strictfp }\nattributes #1 = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }\nattributes #2 = { strictfp } \n```\n\u00a0\nAssertion:\n\n```\nopt: /home/llvm/main/llvm-project/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp:2104: bool hoistPreviousBeforeFORUsers(VPFirstOrderRecurrencePHIRecipe *, VPRecipeBase *, VPDominatorTree &): Assertion `Current->getNumDefinedValues() == 1 && \"only recipes with a single defined value expected\"' failed.\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.\nStack dump:\n0.\u00a0\u00a0\u00a0\u00a0 Program arguments: /home/llvm/main/build/bin/opt -passes=loop-vectorize t0.ll\n1.\u00a0\u00a0\u00a0\u00a0 Running pass \"function(loop-vectorize<no-interleave-forced-only;no-vectorize-forced-only;>)\" on module \"t0.ll\"\n2.\u00a0\u00a0\u00a0\u00a0 Running pass \"loop-vectorize<no-interleave-forced-only;no-vectorize-forced-only;>\" on function \"_Z14checksumFile_HP4FILEPh\"\n\u00a0#0 0x0000040b8191004c llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/home/llvm/main/build/bin/opt+0x5b5004c)\n\u00a0#1 0x0000040b819107f4 PrintStackTraceSignalHandler(void*) Signals.cpp:0:0\n\u00a0#2 0x0000040b8190ca4c llvm::sys::RunSignalHandlers() (/home/llvm/main/build/bin/opt+0x5b4ca4c)\n\u00a0#3 0x0000040b8191194c SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0\n\u00a0#4 0x0000722b9dc30444 (linux-vdso64.so.1+0x444)\n\u00a0#5 0x0000722b9d3c55fc __pthread_kill_implementation ./nptl/pthread_kill.c:44:76\n\u00a0#6 0x0000722b9d3c55fc __pthread_kill_internal ./nptl/pthread_kill.c:78:10\n\u00a0#7 0x0000722b9d3c55fc pthread_kill ./nptl/pthread_kill.c:89:10\n\u00a0#8 0x0000722b9d35bd5c raise ./signal/../sysdeps/posix/raise.c:26:13\n\u00a0#9 0x0000722b9d33645c abort ./stdlib/abort.c:79:7\n#10 0x0000722b9d34d824 __assert_fail_base ./assert/assert.c:96:3\n#11 0x0000722b9d34d8c4 __assert_fail ./assert/assert.c:105:3\n#12 0x0000040b834cae00 llvm::VPlanTransforms::adjustFixedOrderRecurrences(llvm::VPlan&, llvm::VPBuilder&) (/home/llvm/main/build/bin/opt+0x770ae00)\n#13 0x0000040b83416364 llvm::LoopVectorizationPlanner::tryToBuildVPlanWithVPRecipes(std::unique_ptr<llvm::VPlan, std::default_delete<llvm::VPlan>>, llvm::VFRange&, llvm::LoopVersioning*) (/home/llvm/main/build/bin/opt+0x7656364)\n#14 0x0000040b83407278 llvm::LoopVectorizationPlanner::buildVPlansWithVPRecipes(llvm::ElementCount, llvm::ElementCount) (/home/llvm/main/build/bin/opt+0x7647278)\n#15 0x0000040b834069f0 llvm::LoopVectorizationPlanner::plan(llvm::ElementCount, unsigned int) (/home/llvm/main/build/bin/opt+0x76469f0)\n#16 0x0000040b8341dfc4 llvm::LoopVectorizePass::processLoop(llvm::Loop*) (/home/llvm/main/build/bin/opt+0x765dfc4)\n#17 0x0000040b8342937c llvm::LoopVectorizePass::runImpl(llvm::Function&) (/home/llvm/main/build/bin/opt+0x766937c)\n#18 0x0000040b83429dd0 llvm::LoopVectorizePass::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/llvm/main/build/bin/opt+0x7669dd0)\n#19 0x0000040b832bbe9c llvm::detail::PassModel<llvm::Function, llvm::LoopVectorizePass, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) PassBuilderPipelines.cpp:0:0\n#20 0x0000040b81bd55a0 llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) (/home/llvm/main/build/bin/opt+0x5e155a0)\n#21 0x0000040b832b69fc llvm::detail::PassModel<llvm::Function, llvm::PassManager<llvm::Function, llvm::AnalysisManager<llvm::Function>>, llvm::AnalysisManager<llvm::Function>>::run(llvm::Function&, llvm::AnalysisManager<llvm::Function>&) PassBuilderPipelines.cpp:0:0\n#22 0x0000040b81bdb2c4 llvm::ModuleToFunctionPassAdaptor::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/home/llvm/main/build/bin/opt+0x5e1b2c4)\n#23 0x0000040b8323ff3c llvm::detail::PassModel<llvm::Module, llvm::ModuleToFunctionPassAdaptor, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) NewPMDriver.cpp:0:0\n#24 0x0000040b81bd3d60 llvm::PassManager<llvm::Module, llvm::AnalysisManager<llvm::Module>>::run(llvm::Module&, llvm::AnalysisManager<llvm::Module>&) (/home/llvm/main/build/bin/opt+0x5e13d60)\n#25 0x0000040b83233e9c llvm::runPassPipeline(llvm::StringRef, llvm::Module&, llvm::TargetMachine*, llvm::TargetLibraryInfoImpl*, llvm::RTLIB::RuntimeLibcallsInfo&, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::ToolOutputFile*, llvm::StringRef, llvm::ArrayRef<llvm::PassPlugin>, llvm::ArrayRef<std::function<void (llvm::PassBuilder&)>>, llvm::opt_tool::OutputKind, llvm::opt_tool::VerifierKind, bool, bool, bool, bool, bool, bool, bool, bool) (/home/llvm/main/build/bin/opt+0x7473e9c)\n#26 0x0000040b81894384 optMain (/home/llvm/main/build/bin/opt+0x5ad4384)\n#27 0x0000040b8188c460 main (/home/llvm/main/build/bin/opt+0x5acc460)\n#28 0x0000722b9d336ca4 __libc_start_call_main ./csu/../sysdeps/nptl/libc_start_call_main.h:58:16\n#29 0x0000722b9d336eec __libc_start_main ./csu/../sysdeps/unix/sysv/linux/powerpc/libc-start.c:77:48\n\n```\n",
    "author": "scui-ibm",
    "labels": [
      "vectorizers",
      "crash"
    ],
    "comments": []
  },
  "properties": {
    "is_single_file_fix": true,
    "is_single_func_fix": true
  },
  "verified": true
}